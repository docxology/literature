Active inference of network neutrality
Riccardo Ravaioli
To cite this version:
Riccardo Ravaioli. Active inference of network neutrality. Other [cs.OH]. Université Nice Sophia
Antipolis, 2016. English. ￿NNT: 2016NICE4044￿. ￿tel-01382731￿
HAL Id: tel-01382731
https://theses.hal.science/tel-01382731v1
Submitted on 17 Oct 2016
HAL is a multi-disciplinary open access L’archive ouverte pluridisciplinaire HAL, est
archive for the deposit and dissemination of sci- destinée au dépôt et à la diffusion de documents
entific research documents, whether they are pub- scientifiques de niveau recherche, publiés ou non,
lished or not. The documents may come from émanant des établissements d’enseignement et de
teaching and research institutions in France or recherche français ou étrangers, des laboratoires
abroad, or from public or private research centers. publics ou privés.
UNIVERSITE NICE SOPHIA ANTIPOLIS
ECOLE DOCTORALE STIC
SCIENCES ET TECHNOLOGIES DE L’INFORMATION ET DE LA COMMUNICATION
T H E S E
pour l’obtention du grade de
Docteur en Sciences
de l’Université Nice Sophia Antipolis
Mention : Informatique
présentée et soutenue par
Riccardo RAVAIOLI
ACTIVE INFERENCE OF NETWORK NEUTRALITY
Thèse dirigée par Guillaume URVOY-KELLER
et Chadi BARAKAT
soutenue le 13 juillet 2016
Jury :
Prof. Françoise Baude Président
Prof. Kavé SALAMATIAN Rapporteur
Ass. Prof. Marco MELLIA Rapporteur
Ass. Prof. Timur FRIEDMAN Examinateur
Prof. Guillaume URVOY-KELLER Directeur de thèse
Dr. Chadi BARAKAT (HDR) Directeur de thèse
Abstract
In the last decade, some ISPs have been reported to discriminate
against specific user traffic, especially if generated by bandwidth-
hungry applications (e.g., peer-to-peer, video streaming) or compet-
ing services (e.g. Voice-over-IP). Network neutrality, a design prin-
ciple according to which a network should treat all incoming pack-
ets equally, h as been widely debated ever since. In this thesis we
present ChkDiff, a novel tool for the detection of traffic differentia-
tionattheInternetaccess. Incontrasttoexistingwork,ourmethodis
agnostictoboththeapplicationsbeingtestedandtheshapingmech-
anisms deployed by an ISP. The experiment comprises two parts,
in which we check for differentiation separately on upstream and
downstream traffic that we previously dump directly from the user.
In the upstream direction, ChkDiff replays the user’s outgoing traf-
ficwithamodifiedTTLvalueinordertocheckfordifferentiationon
routers at the first few hops from the user. By comparing the result-
ing delays and losses of flows that traversed the same routers, and
analyzing the behaviour on the immediate router topology spawn-
ingfromtheuserendpoint,wemanagetodetectinstancesoftraffic
shaping and attempt to localize shapers. Our study on the respon-
siveness of routers to TTL-limited probes consolidates our choice of
measurements in the upstream experiment. In the downstream ex-
periment,wereplaytheuser’sincomingtrafficfromameasurement
server and analyze per-flow one-way delays and losses, while tak-
ing into account the possibility of multiple paths between the two
endpoints. Along the chapters of this thesis, we provide a detailed
descriptionofourmethodologyandavalidationofourtool.
Résumé
Durant la dernière décennie, des FAI ont été accusés de discriminer
certainstypesdetraficutilisateurgénéréspardesapplicationsgour-
mandes en bande passante (peer-to-peer, streaming vidéo) ou par
des services concurrents (Voice-over-IP). La neutralité des réseaux,
un principe selon lequel un réseau devrait traiter tous les paquets
entrants de la même manière, a été largement débattue. Dans cette
thèse,nousprésentonsChkDiff,unnouveloutilpourladétectionde
ladifférentiationdutraficdansleréseaud’accès. Contrairementaux
travauxexistants,notreméthodeestagnostiqueàlafoisvis-à-visdes
applications testées et des mécanismes de shaping déployés. ChkD-
iff comprend deux phases dans lesquelles nous testons séparément
le trafic montant et descendant capturé auparavant dans la machine
de l’utilisateur. Dans la direction montante, ChkDiff rejoue le trafic
sortant de la machine de l’utilisateur avec une valeur TTL modi-
fiée afin de pouvoir tester les routeurs aux premiers sauts. En com-
parant les délais et les pertes des paquets des flux qui ont traversé
les mêmes routeurs et en analysant les résultats sur la topologie des
routeurstraversés,nousmontronsquenouspouvonsdétecterlescas
de différentiation et localiser les shapers. Notre étude sur la réac-
tivitédesrouteursauxsondesavecTTLlimitéconsolidenotrechoix
de mesures dans l’expérimentation sur le trafic montant. Dans la
direction descendante, nous rejouons le trafic entrant dans la ma-
chine de l’utilisateur à partir d’un serveur de mesure et analysons
pour chaque flux les délais unidirectionnels et les pertes, tout en
tenant compte la possibilité de trajets multiples entre le serveur et
l’utilisateur. Le long des chapitres de cette thèse, nous fournissons
unedescriptiondétailléedenotreméthodologieetunevalidationde
notreoutil.
Acknowledgements
Iwouldliketoexpressmydeepestgratitudetomysupervisors,Guil-
laume Urvoy-Keller and Chadi Barakat, for their constant guidance,
tirelessmentoringandinvaluableinsightsthroughoutmyyearsasa
PhDstudent.
I would also like to thank my family for their precious uncondi-
tionalsupport: withoutthem,IwouldnotbethepersonIamtoday.
This dissertation would not have been possible without funding
fromLabexUCN@Sophia.
Contents
1 Introduction 15
2 Context and Related Work 19
2.1 A few examples of discriminatory practices 19
2.2 Internet Neutrality 21
2.3 Traffic differentiation 23
2.4 Legislative efforts 24
2.5 Tools for the detection of traffic differentiation 25
3 ICMP rate limitation 43
3.1 Overview 44
3.2 Experimental setup 45
3.3 Analysis of ICMP rate limitation 46
3.4 Characterization of routers 48
3.5 Delay 56
3.6 Related Work 56
3.7 Summary 57
4 ChkDiff: the upstream experiment 59
4.1 Design of the tool 60
4.2 Validation in a neutral scenario 66
4.3 Validation in a non-neutral scenario 67
4.4 Assessment with respect to existing methods 75
4.5 Summary 76
10 inference of network neutrality violations with active measurements
5 ChkDiff: the downstream experiment 79
5.1 Methodology 79
5.2 Validation 87
5.3 Discussion 91
5.4 Assessment with respect to existing methods 93
5.5 Summary 94
6 Conclusion 95
6.1 Summary 95
6.2 Future directions 96
List of Figures
3.1 Lossratesforallexperiments,arrangedbyprobingrate. 45
3.2 Mean RTT box plots for all experiments, arranged by probing
rate. 45
3.3 Atypicaltimeseriesforanon-offrate-limitedrouter. 46
3.4 Atypicaltimeseriesforagenericallyrate-limitedrouter. 47
3.5 PhasesintheresponsivenessofrouterstoTTL-probes 49
3.6 CDFsofBS,IBTandoverallansweringrateforon-offrouters. 51
3.7 Distributionofr forfr-onoff-irrrouters. 52
1
3.8 Answeringrateoverexpectedansweringrateinirrphaseforon-
offrouters. 52
3.9 Answeringrateforgenericallyrate-limited(rl)routers. 53
3.10CDFsofBS,IBTandansweringrateforon-offrouters,arranged
byroutervendor. 54
3.11Distribution of vendors and percentage of routers in each cate-
goryforCisco,Juniperand“others”. 55
3.12Verification of inferred parameters on a controlled rate-limited
machine. 56
3.13RTT CoV box plots for all experiments, arranged by probing
rate. 57
4.1 An example with shapers at different hops affecting selected
flows. 64
4.2 Expected output of ChkDiff for the network topology in Fig-
ure4.1. 64
4.3 Distribution of flow sizes, in number of packets, for the packet
traceusedforvalidation. 66
4.4 Incidence of false positives in the delay analysis when the re-
played trace contains unaltered original packets, and when it
containspacketsofthesamesize. Resultsareover1run. 66
4.5 Middleboxconfiguration. 67
4.6 Precision and recall of the combined analysis, for the case of
one shaped flow in Scenario 1. In each circle, we report in the
upper-left quarter the result of only the delay analysis, in the
upper-right quarter the result of only the loss analysis, and in
thelowerhalftheresultofthecombinedanalysis,whichrejectsa
flowifeitherthedelayorthelossanalysisfails. 68
12 inference of network neutrality violations with active measurements
4.7 Recall of the loss analysis as we vary fr, for the case of uniform
drops on the whole traffic and on one selected flow (Scenario
2). 68
4.8 Precision and recall of the combined analysis, for the case of
multipleshapedflows,inScenario1. 70
4.9 Recall of the loss analysis as we vary fr, for the case of uniform
drops on the whole traffic and on multiple selected flows (Sce-
nario2). 70
4.10Precisionandrecallofthecombinedanalysis,forthecaseofmul-
tipleshapedflowswithaWiFiconnection,inScenario1. 71
4.11Recall of the loss analysis as we vary fr, for the case of uniform
drops on the whole traffic and on multiple selected flows with a
WiFiconnection(Scenario2). 71
4.12Scenario 1 with multiple shaped flows and ICMP rate limita-
tion. 72
4.13Scenario 2 with multiple shaped flows and ICMP rate limita-
tion. 73
5.1 ThetwoexperimentsinChkDiff. 80
5.2 Configurationofclientandserver. 85
5.3 Timeseries of an experiment with packets following multiple
paths. 86
5.4 Setup used in the validation of ChkDiff, along with the shaper
configuration. 87
5.5 Distributionofflowsizesforthetraceweusedinthevalidation
ofthetool. 88
5.6 Recall of the combined analysis (delay and losses) for Scenario
1overwired,WiFiand3Gconnections. 89
5.7 Recall of the loss analysis as we vary fr in Scenario 2 from the
server located in Germany, over wired, WiFi and 3G connec-
tions. 90
5.8 Recall of the loss analysis as we vary fr in Scenario 2 from
the server located in Ireland, over wired, WiFi and 3G connec-
tions. 91
5.9 Recall of the loss analysis as we vary fr in Scenario 2 from
the server located in Oregon, over wired, WiFi and 3G connec-
tions. 92
List of Tables
2.1 Comparison of existing methods for the detection of neutrality
violations. 41
2.1 Comparison of existing methods for the detection of neutrality
violations. 42
3.1 Numberofroutersineachcategory. 48
4.1 Number of true and false positives when replaying the original
andashuffledtraceatdifferentsendingrates. 74
1
Introduction
The increasing popularity of bandwidth-hungry applications, like
peer-to-peer and video streaming, has induced some Internet Ser-
vice Providers (ISPs) in the last decade to deploy some traffic man-
agementtechniquesthatofferdegradedperformanceinsteadofbest- 1Jon Crowcroft. Net neutrality: the
effort service to specific traffic flows. Reported cases abound: from technicalsideofthedebate:awhitepa-
per. SIGCOMMComput.Commun.Rev.,
blocking of BitTorrent traffic when a user is actively sharing files, to
37:49–56,January2007
reduced performance of NetFlix by a few U.S. operators and throt-
tling of YouTube during peak hours in the evening. Also competing
2MarcelDischinger,AlanMislove,An-
servicessuchasVoIPhavebeenthetargetofISPs,forinstancewhen dreasHaeberlen,andKrishnaP.Gum-
all Vonage calls were systematically blocked by a regional mobile madi. Detecting BitTorrent Blocking.
In Proceedings of the 8th ACM SIG-
operator and when Apple’s FaceTime was disabled for mobile cus-
COMM Conference on Internet Measure-
tomerswhodidnotoptforamoreexpensivedataplan. ment (IMC’08), Vouliagmeni, Greece,
October2008
AlltheseexamplesconstituteclearviolationsofInternetneutral-
Marcel Dischinger, Massimiliano
ity, a principle according to which a network should treat all its in- Marcon, Saikat Guha, Krishna Gum-
coming traffic equally, without deliberately offering worse or better madi, Ratul Mahajan, and Stefan
Saroiu. Glasnost: Enabling End Users
performance to any traffic of its choice. There has been discussion1
toDetectTrafficDifferentiation. InPro-
about whether the Internet has been conceived and implemented as ceedings of the 7th Symposium on Net-
worked Systems Design and Implementa-
a strictly level-playing field, but from a broader point of view it is
tion(NSDI),SanJose,CA,Apr2010
generally agreed upon that all attempts that selectively deteriorate Partha Kanuparthy and Constan-
certain types of Internet traffic over others are, to say the least, con- tineDovrolis. Diffprobe:detectingISP
service discrimination. In Proceedings
troversial. Because of this, legislative efforts aiming at prohibiting
ofthe29thconferenceonInformationcom-
cases like the above ones have appeared in a number of countries, munications,INFOCOM’10,pages1649–
1657, Piscataway, NJ, USA, 2010. IEEE
the first of which to approve such laws were Chile in 2010 and the
Press
Netherlandsin2012.
Traffic differentiation is typically carried out in two steps: first a 3Robert Beverly, Steven Bauer, and
flowisidentifiedbyinspectingpacketfieldsattheIP,transportorap- Arthur Berger. The Internet is not a
big truck: toward quantifying network
plication layer, then a differentiation technique is applied to packets
neutrality. InPassiveandActiveNetwork
belonging to that flow, generally leading to the corresponding user Measurement, pages 135–144. Springer,
2007
application experiencing larger delays and more losses (translating
Partha Kanuparthy and Constan-
intoalowerthroughput),whenitisnotblockedalltogether. tineDovrolis.Shaperprobe:End-to-end
In the literature several tools have been described in recent years detectionofisptrafficshapingusingac-
tivemethods. InProceedingsofthe2011
to try to establish whether an ISP applies traffic differentiation to
ACM SIGCOMM Conference on Internet
specific applications (e.g., BitTorrent, YouTube, Skype, etc.)2 and MeasurementConference,IMC’11,pages
473–482.ACM,2011
withtheuseofspecificdifferentiationtechniques(e.g.,portblocking,
Udi Weinsberg, Augustin Soule,
token-bucketshaper,PowerBoost,etc.).3
and Laurent Massoulié. Inferring traf-
In this thesis, we propose novel method for the detection of traf- ficshapingandpolicyparametersusing
endhostmeasurements. InINFOCOM,
ficdifferentiationattheaccessISPthatdiffersfromexistingworkin
pages151–155,2011
16 inference of network neutrality violations with active measurements
that it is both independent from the applications tested by the user
andtheshapingtechniquedeployedbythenetworkoperator. While
mostmethodsintheliteraturereplayanapplicationflowandarefer-
enceflowwithavarietyoftechniquesandcomparetheperformance
of the two flows to infer differentiation, we replay the whole user
traffic with minimal modifications and compare the performance of
each application run by the user against the rest of the user traffic,
whichwetakeasbaseline. Wedetectdifferentiationbyanalyzingthe
distribution of delays and the number of losses of each flow, which
are the two metrics that are directly affected by a shaper that wants
todegradetheperformanceofselectedtraffic.
We implemented this in a tool we called ChkDiff,4 which first 4The code is available on a
dumpsregularusertrafficforatimewindowofafewminutes,dur- dedicated web page: http:
//chkdiff.gforge.inria.fr/
ingwhichtheuserisexpectedtoruntheInternetapplicationsshein-
tendstotest,andthenspawnstwodifferentexperimentsthatreplay
the captured traffic in respectively the upstream and downstream
direction. In both cases, we shuffle the trace in such a way that the
position of the packets of each flow inside the trace can be modeled
asaPoissonprocess,whichguaranteesus-accordingtothePASTA5
5PoissonArrivalsSeeTimeAverages.
property - that each replayed flow will see the same network condi-
tions. Clearly, we preserve the order of packets of each flow while
shuffling.
In the upstream experiment,6 we replay the user outgoing traffic 6Riccardo Ravaioli, Guillaume Urvoy-
againsttheroutersinherimmediatevicinityinordertotestwhether Keller, and Chadi Barakat. Towards a
generalsolutionfordetectingtrafficdif-
theuser’saccessISPdeploysanyshaperstargetinganyoftheprevi-
ferentiation at the internet access. In
ously executed applications. For each hop at distance k to the user, TeletrafficCongress(ITC27),201527thIn-
ternational,pages1–9.IEEE,2015
we re-inject the trace into the network with a forged Time-To-Live
(TTL) field in the IP header of each packet, so that routers at hop
k will generate ICMP time-exceeded error messages, with which we
compute per-flow Round-Trip Times (RTTs) and losses. ChkDiff in-
fersthataflowhasbeendifferentiatedwhenitsempiricaldelaydis-
tribution fails the one-sided two-sample Kolmogorov-Smirnov test
against the delays of all other flows in the trace, or when its loss
count is not compatible with the overall loss rate of the rest of the
trace, through a tailored binomial-inspired test. By analyzing the
performanceofflowsacrosssuccessivehops,wearealsoabletopin-
pointthepositionofashaperwithrespecttotheuser.
In order to justify our choice of measurements in the upstream
experiment, we performed a detailed study of the responsiveness of
routers to TTL-limited probes and a characterization of how ICMP
rate limitation is implemented.7 With a large-scale measurement 7Riccardo Ravaioli, Guillaume Urvoy-
campaign from 180 PlanetLab nodes, we probed at increasing rates Keller, and Chadi Barakat. Character-
izingICMPRateLimitationonRouters.
850routersuptohop5andanalyzedtheirresponsiveness. Wefound
InIEEEInternationalConferenceonCom-
out that almost one third of the routers hit are fully responsive at munications(ICC),2015
least up to relatively high rates (2500 packets per second (pps)), a
small fraction (3.9%) of routers is unresponsive and almost 60% im-
plementICMPratelimitation,whosemostcommonformisanon-off
pattern defined by the burst size of the generated packets and the
inter-bursttime,whichwecharacterizeindetails. Also,mostrouters
chapter 1. introduction 17
are fully responsive at rates that are between one and two orders of
magnitudehigherthanthosecommonlyusedbytoolsrunningthese
measurements. We also found no correlation between probing rates
andtheresultingRTTs,whichmeansthatourchoiceofprobingrate
doesnotreachanycapacitylimitsonroutersanddoesnotcauseany
additionaldelayinthereturnedICMPreplies.
In the downstream experiment of ChkDiff,8 we replay the user 8Riccardo Ravaioli, Guillaume Urvoy-
incoming traffic from a measurement server and measure per-flow Keller, and Chadi Barakat. Testing for
traffic differentiation with chkdiff: the
one-way delays and losses in order to infer differentiation. Since
downstreamcase. InTeletrafficCongress
there might be NATs, firewalls and middleboxes along the path be- (ITC 28), 2016 28th International. IEEE,
2016
tween the user and our server, we take the necessary measures to
openconnections,findNATmappingsfortheflowsinthetrace,ad-
just sequence numbers and avoid firewall timeouts. Unlike other
proposals in the literature, we take into account the possibility of
multiple paths between the two end points and base our analysis
accordingly. Flow delays are grouped with a clustering algorithm
thatisolatesaposteriorithedifferentpathsandflagsasshapedthose
flows that could not be assigned to any discovered path. We inte-
grate this delay analysis with the loss analysis that we also applied
intheupstreamcaseinordertodetecttrafficdifferentiation.
Thethesisisorganizedasfollows: inChapter2wedescribeafew
representative cases of traffic differentiation, introduce the concept
of Internet neutrality and review existing methods for the detection
oftrafficdifferentiation;inChapter3westudytheresponsivenessof
routers to TTL-limited probes and characterize routers also accord-
ing to their vendor; in Chapter 4 we provide a detailed description
ofthemethodologyoftheupstreamexperimentinChkDiffandval-
idate the tool in a controlled setup with a wired and WiFi connec-
tion, under two different shaping scenarios, and also with a router
implementing ICMP rate limitation; in Chapter 5 we illustrate the
downstream experiment of ChkDiff and validate it using real Inter-
net paths from three different server locations and over wired, WiFi
and 3G connections; we give closing remarks and discuss future di-
rectionsinChapter6.
2
Context and Related Work
Traffic management is commonplace in most network architectures:
it is essential in case of congestion in the network and useful when
certain managed services (e.g., voice over broadband, IPTV, etc.)
have latency or jitter constraints. On the other hand, when traffic
management is used to purposely discriminate certain types of traf-
fic over others, it becomes a more controversial matter, as it directly
harmstheopennessandneutralityoftheInternet.
In this chapter we first present a few blatant cases of discrimina-
torypracticesperformedbyISPs(Section2.1),introducetheconcept
of Internet neutrality and offer arguments in favour and against it
(Section 2.2); then, we explain how traffic differentiation is gener-
ally implemented in today’s networks (Section 2.3) and summarize
the legislative efforts in various countries to preserve a neutral and
open Internet (Section 2.4). Finally, we describe and evaluate exist-
ingmethodsintheliteratureforthedetectionoftrafficdifferentiation
(Section2.5).
2.1 A few examples of discriminatory practices
Inthelastdecade,severalcasesofdiscriminatorypracticeshavebeen
reported by Internet users, concerning mostly bandwidth-hungry
applications like peer-to-peer and video streaming, and competing
services, like Voice-over-IP (VoIP) and even search engine queries.
We detail here a few exemplary cases for each type of targeted ser-
vice.
Peer-to-peer. OneofthefirstcasesthatemergedisthatofU.S.oper-
ator Comcast in 2005, when it deliberately blocked upstream traffic
ofBitTorrentuserswhowereactivelysharingfileswithenduserslo-
catedinothernetworks.1 ByinjectingforgedTCPRSTpacketswhen 1Dslreports: comcast is using sand-
the transfer reached a certain threshold, Comcast was terminating vine to manage p2p connections.
URL: http://www.dslreports.com/
uploads at the boundaries of its network, thus effectively reducing
forum/r18323368-Comcast-is-
thecostoftheextraconnectivitythatComcastitselfwouldhavehad using-Sandvine-to-manage-P2P-
Connections.
tobuyfrombackboneproviders.
Videostreaming. AnISPmightalsodecidetotargetvideostreaming
services,asforinstancedidU.S.wirelesscarrierMetroPCSin2011,2
2MetroPCS 4G Data-Blocking Plans
May Violate Net Neutrality. URL:
http://www.wired.com/2011/01/
metropcs-net-neutrality/
20 inference of network neutrality violations with active measurements
when it openly blocked all video streaming web sites except for
YouTubeandwentasfarasofferingunlimitedYouTubeaccess,most
probably following a special agreement between the two providers.
OthertimesYouTubewasnegativelyimpactedbyISPs,asreportedin
2011 by hundreds of fixed network users in France3 and Germany4: 3Respect my net. URL: http://
the download rate was significantly throttled during peak hours in respectmynet.eu/view/205
4Respect my net. URL: http://
the evening, up to a point in which, for the case of French opera-
respectmynet.eu/view/196
tor Free, resolutions of 720p and 1080p appeared to be blocked and
only480pseemedtowork,eventhoughataloweredspeed. Amore
subtle way to degrade performance was observed in 2014 with U.S.
operatorsComcastandVerizon,5whichformonthsfailedtoupgrade
5Netflix performance on Veri-
theirpeeringinfrastructuredespiteageneralincreaseinNetFlixtraf- zon and Comcast has been
dropping for months, 2013.
fic. ThiswastheconsequenceofadisputebetweenthetwoISPsand
URL: http://arstechnica.com/
NetFlix and resulted in a worse video experience for NetFlix users. information-technology/2014/02/
netflix-performance-on-verizon-
AnotherexampleofanISPtargetingvideoservicesisthatofFrench
and-comcast-has-been-dropping-
mobileoperatorBouygues,6whichin2011wasfoundtobeintercept-
for-months
ing users’ HTTP requests for flash videos that exceeded 20 MB, to 6Bouygues télécom filtre malhonnête-
ment son réseau 3G et inspecte vos
which it would respond with a 403 Forbidden HTTP error message;
données. URL: http://grapsus.net/
furthermore,allTCPconnectionsexceeding10MBwereterminated. blog/post/Bouygues-Telecom-
filtre-malhonnetement-son-reseau-
3G-et-inspecte-vos-donnees
Voice-over-IP. Impairment of VoIP has been the objective of some
ISPsthatofferasimilarvoiceservice. Forinstance,in2005aregional
ISPintheU.S.blockedalltrafficofVoIPapplicationVonage;7 uproar 7Vonage says broadband
among customers urged Vonage to file a complaint to the Federal provider blocks its calls. URL:
http://www.cnet.com/news/vonage-
Communications Commission (FCC), which eventually condemned
says-broadband-provider-blocks-
suchpractice. Between2007and2009,AT&TobtainedfromApplea its-calls/
completeblockofallVoIPapplicationsontheiPhone,8 untilin2009 8Group asks FCC to probe
itfinallyallowedSkype,evenifonlywhenthedevicewasconnected iPhone Skype restrictions. URL:
http://fortune.com/2009/04/03/
to WiFi. More recently, in 2012 AT&T customers owning an iPhone
group-asks-fcc-to-probe-iphone-
hadApple’svideo-callingapplicationFaceTimeblocked,unlessthey skype-restrictions/
opted for a more expensive data plan.9 WhatsApp calls, Skype and 9AT&T blocking iPhone’s FaceTime
Viber are currently blocked in the United Arab Emirates, where the app would harm consumers and
break net neutrality rules. URL:
telecommunicationsauthoritydelegatedtothetwolicensedtelecom
http://www.freepress.net/press-
providers of the country the power to allow or not VoIP services release/99480/att-blocking-
throughtheirnetworks.10 iphones-facetime-app-would-
harm-consumers-and-break-net-
neutrality
10WhatsApp Voice Calling Already
Redirection of search queries. An ISP could also have its own search Banned by UAE’s Etisalat: Report.
2015. URL:http://gadgets.ndtv.com/
engine and might want to redirect customers to it. This is what
apps/news/whatsapp-voice-calling-
WindstreamCommunications,aU.S.DSLprovider,didin2010when already-banned-by-uaes-etisalat-
it was found to redirect to its own search engine all queries that report-672283
were made using the Google toolbar in web browser Firefox.11 By
11Phone Company Helps Make
using Deep Packet Inspection (DPI), the ISP was able to intercept the Case for Net Neutrality. URL:
http://www.savetheinternet.com/
users’ search requests to Google, prevent them from reaching the
blog/10/04/05/phone-company-
actual destination, and provide its customers with the result of its helps-make-case-net-neutrality
own search engine to the same query. In 2012 a dozen U.S. ISPs
were reported to hijack queries that included specific keywords and
redirectthemthroughaffiliatenetworks,inordermonetizeonthose
particularsearches.12
12Widespread Hijacking of Search
Traffic in the United States. URL:
https://www.eff.org/deeplinks/
2011/07/widespread-search-
hijacking-in-the-us
chapter 2. context and related work 21
VPN’s. VPN’s might have their speed throttled too, regardless of
the traffic they carry (since it is encrypted). This was the case in
2014 of Comcast subscribers who wanted to run OpenVPN with its
defaultconfiguration(UDPtrafficoverport1194)andexperienceda
strangelylowspeed,whichdoubledassoonastheyswitchedtoTCP
andadifferentportnumber.13
13IjustdoubledmyPIAVPNthrough-
put that I am getting on my router by
switching from UDP:1194 to TCP:443.
2.2 Internet Neutrality URL: http://www.reddit.com/r/VPN/
comments/1xkbca/i_just_doubled_my_
pia_vpn_throughput_that_i_am
The cases described in Section 2.1 are clear examples of ways an
Internet service provider can tamper with user traffic and discrimi-
nate certain applications. This is against the end-to-end principle in
general and network neutrality in particular. The end-to-end design
principle of network communications14 states that all application- 14J. H. Saltzer, D. P. Reed, and D. D.
specific functions should be implemented on end hosts and inter- Clark. End-to-end Arguments in Sys-
temDesign. ACMTrans.Comput.Syst.,
mediate nodes are exclusively in charge of forwarding packets and
2(4):277–288,November1984
delivering them to the destination. Internet neutrality, a term first
coined by Tim Wu15 in 2003 but a long-standing implicit principle, 15Tim Wu. Network neutrality, broad-
goesonestepfurther:16 banddiscrimination. JournalofTelecom-
“ munications and high Technology law,
2:141,2003
...a maximally useful public information network aspires to treat all ” 16http://www.timwu.org/network_
content,sites,andplatformsequally. Thisallowsthenetworktocarry neutrality.html
everyformofinformationandsupporteverykindofapplication.
TimWu
While there are different interpretations of this principle, from
a radical one stating that all incoming packets should be treated
equally by a network, to a looser one according to which similar
applicationsshouldexperiencesimilarperformance,whatwearein-
terested to verify in this thesis is that no traffic flow is offered sig-
nificantly degraded performance compared to the rest of the user
traffic.
2.2.1 Arguments in favour
A neutral Internet, as advocated for example by non-profit organi-
zationSaveTheInternet17,wouldfostercompetitionandinnovation
17www.savetheinternet.com
inInternetcontents, sincethesuccessorfailureofonlinecompanies
hasalwaysbeendictatedbythequalityoftheservicestheyofferand
not by special deals with ISPs. The risk of a non-neutral Internet is
to switch from a model where ISPs simply provide the infrastruc-
ture of a “dumb” network, as according to the end-to-end principle,
to a model where they play the role of gatekeepers, deciding which
contentsaregrantedafasteraccessandwhicharenot. Indeed,with
the exception of court orders, an ISP should not enforce any control 18Lawrence Lessig and Robert W.
overthedataitforwards. Fromalesstechnicalpointofview,anon- McChesney. No Tolls on The
Internet. June 2006. URL:
neutral Internet would ultimately harm free speech and democratic
http://www.washingtonpost.com/
participation in the Web,18 thus undermining its original aspiration wp-dyn/content/article/2006/06/07/
AR2006060702108.html
toofferawidevarietyofindependentsourcesofinformationandto
generateinnovativecontents. VintCerf,19 co-inventorofTCP/IPand 19Vint Cerf speaks out on
net neutrality. URL: https:
//googleblog.blogspot.fr/2005/
11/vint-cerf-speaks-out-on-net-
neutrality.html
22 inference of network neutrality violations with active measurements
anadvocateofneutrality,alsopointsoutthatwithlittlecompetition
among broadband providers, as it is the case in the U.S. market, a
non-neutral Internet would put in the hands of a few the power of
affectingwhatpeopledoandsee.
Tim Wu,20 one of the most active scholars in the debate, claims 20Tim Wu. Network neutrality, broad-
that the Internet inherently aspires to neutrality, however imperfect banddiscrimination. JournalofTelecom-
munications and high Technology law,
that might be. According to Wu, the end-to-end principle, a key
2:141,2003
design idea of the Internet, is proof of this. He continues to observe
that the diversity of applications running on the Internet, each one
with different requirements, makes it difficult to defend a definition
ofneutralityregardlessofapplications;itismorelogicaltothinkofa
neutral network as one that enforces equal treatment among similar
applications.
2.2.2 Arguments against
Ontheotherhand,opponentsofnetworkneutralityclaimthatband-
width prioritization is necessary for future innovation, as ISPs are 21Jon Crowcroft. Net neutrality: the
moreinclinedtoimproveandmodernizetheirnetworksiftheyhave technicalsideofthedebate:awhitepa-
per. SIGCOMMComput.Commun.Rev.,
additionalrevenues,especiallyifcomingfromcontentproviderslike
37:49–56,January2007
YouTube or Netflix that base their business on a massive use of net- Jon Crowcroft. Talk on Net
Neutrality, December 2006. URL:
workbandwidthandcouldbeaccusedoffree-ridingtheexistingnet-
"http://www.cl.cam.ac.uk/~jac22/
work infrastructure. Another argument against enforcing network talks/neut.ppt.gz"
neutrality rules is that throughout the history of the Internet, there Jon Crowcroft. Talk on Newt
or Notrality, July 2011. URL:
hasneverbeenatruelevel-playingfield,sincelargecompanieshave
"https://www.cl.cam.ac.uk/~jac22/
always had an advantage over smaller ones by the deployment of talks/notrality.ppt"
replicatingserversandthepurchaseofhigh-bandwidthservices.
JonCrowcroftfurtherelaboratesonthis,21 statingthathistorically
the Internet has never been made of just “dumb pipes”; on the con-
trary,itcomprisesordependsalreadyonanumberofelementsthat
directlyalteritsperformanceandaccessibility: TCPthroughputand
itsdependenceonroundtriptime(andthusonthedistancebetween
a server and a user), making cache and proxy servers essential to
give a significant advantage to companies that deploy them; inter-
domainroutingalgorithmBGPnativelysupportingroutingdiscrim-
ination; NATs and firewalls effectively cutting out portions of the
Internet. Moreover, services like VoIP, IPTV, videoconferencing and
onlinegamescomewithexpectationsinperformanceandsometimes
with a cost for users, in which case it is the users themselves that
woulddemandthatsuchservicesbeprioritized.
Pappasetal.22 claimthatastrongdefinitionofnetworkneutrality, 22Christos Pappas, Katerina Argyraki,
in which all packets should be treated equally by a network, is not Stefan Bechtold, and Adrian Perrig.
Transparency Instead of Neutrality. In
only unrealistic, but also not at all desirable: applications with dif- Proceedings of the 14th ACM Workshop
ferent needs, having for instance latency or bandwidth constraints, onHotTopicsinNetworks,HotNets-XIV,
pages22:1–22:7.ACM,2015
naturally result in better Quality of Experience (QoE) for users if
treated accordingly across the network. Rather then enforcing im-
practicalrulesonISPs,itismoreimportanttoaskthemforincreased
transparencyabouttheirtrafficmanagementpractices.
Indeed - whatever the position - it is generally agreed that any
chapter 2. context and related work 23
actiontakenbyanISPtodiscriminatetrafficshouldbemadepublic,
so that users can make an informed decision and freely choose the
provider that best suits their needs. Transparency is therefore what
wealsoadvocatehere.
2.3 Traffic differentiation
In order to discriminate a flow, a shaper has to perform two steps,
involving first the identification of the flow it wants to affect and
thentheapplicationofthedesireddifferentiationtechniquetoit.
1. Flow identification. An incoming packet can be associated to a
known application by inspecting its IP header (source and desti-
nationIPaddresses),itstransportprotocolheader(portnumbers),
oritsapplicationpayload. Inthislastcase,devicesaresaidtoap-
plyDeepPacketInspection(DPI).Additionalcriteriacanbetaken
intoaccountbyanISP,suchastimeoftheday(forexampleduring
peak hours), network load (if the network is congested), or even
userbehaviour(incaseofheavybandwidthusage).
2. Differentiation. Onceapackethasbeenidentifiedasbelongingtoa
certainapplicationthatismeanttoreceivedifferenttreatmentthan
regulartraffic, avarietyofdifferentiationtechniquesarepossible.
Packets of a flow can be entirely dropped, as in the case of port
blocking;theycanbedeprioritizedinordertodecreasetheoverall
flow throughput; their rate can be shaped with token or leaky
bucket-like techniques; they can be subject to a fixed or variable
droppingrate;ortheycanberoutedoveraslowerlink. AnISPcan
also cause a lower throughput to a flow or block it by interfering
withitdirectlyatthetransportandapplicationlayers: attheTCP
layer, it can reduce the advertised window size by overwriting
the corresponding header field, or it can inject a TCP RST packet
in order to terminate the connection; at the application layer, it
can for example intercept HTTP requests and inject HTTP error
messages that effectively impair the download of the requested
resource (as seen in Section 2.1). Still at the application layer, an
ISPcanredirectHTTPrequeststoserversofitschoice.23
23This is a form of differentiation that
does not necessarily alter the perfor-
While all these techniques can overlap with traffic management manceofaflow, butmodifiesthecon-
tents requested by a user without the
practices, they constitute violations of Internet neutrality when they
user’sconsent.
areusedtopurposelyofferworseperformancetoselectedflows.
The First-Come-First-Serve (FCFS) service policy might not yield
the best results in case of contention of network resources with cer-
tain types of traffic, for example for network control and manage-
ment. This is why traffic differentiation has been integrated into
Internet protocols right from the beginning, with the Type of Ser-
vice(ToS)24 fieldoftheIPheaderoriginallyallowingapplicationsto 24P. Almquist. RFC 1349: Type of
indicate the quality of service desired along the network path. The Service in the Internet Protocol Suite.
1992. URL: https://tools.ietf.org/
ToS field was later redefined as Differentiated Services Code Points
html/rfc1349
(DCSP),25whichallowedtospecifytherequestedper-hopbehaviour.
25S.Blake,F.Baker,andD.Black. RFC
2474: Definition of the Differentiated
Services Field (DS Field) in the IPv4
andIPv6Headers. 1998. URL:https:
//tools.ietf.org/html/rfc2474
24 inference of network neutrality violations with active measurements
Whiletoday’send-userapplicationsdonotusethisfieldanymore,it
is still extensively used by ISPs to mark incoming packets and map
themtodifferentinternalroutesbeforeforwardingthemtoanexter-
nal network. It is worth noting, however, that there has never been
a homogeneous end-to-end usage of the DSCP field across different
networkoperators,forengineeringandeconomicreasons.
More generally, every network architecture today includes ways
ofdifferentiatingtraffic,26especiallytohandlecongestionevents,but
26BITAG Technical Working Group.
alsotolimitauser’sbandwidthtotheirpurchasedrate,toofferbet- Differentiated Treatment of Internet
Traffic. 2015
ter performance to IP-based services offered by the ISP (e.g., IPTV
and carrier grade voice) and to comply with the QoS parameters of
ServiceLevelAgreements(SLAs)forbusinessconnectivityservices.
2.4 Legislative efforts
Historically,theideaofneutralityinacommunicationnetworkcame
aboutin1860withaUSfederallawstatingthat“messagesfromany
individual, company, or corporation, or from any telegraph lines”
should be “impartially transmitted in the order of their reception,
excepting that the dispatches of the government shall have prior-
ity”.27 Nevertheless, it is only in the last dozen years that the idea 27http://cprr.org/Museum/Pacific_
of guaranteeing neutrality inside the Internet drew considerable at-
Telegraph_Act_1860.html
tention from the media, the research community (for the technical,
economicalandlegislativeaspectsitentails)andalsolawmakers.
Thefirstcountriestoapprovelawsthatexplicitlyenforcenetwork
neutralityintheInternetwereChile28 in2010andtheNetherlands29
28Chile, primer país en incorporar la
in 2012. In the United States, after a 5-year-long debate,30 network neutralidad en la red. URL: http:
//www.elmundo.es/elmundo/2010/07/
neutrality rules were finally approved in February 2015, prohibiting
16/navegante/1279272468.html
arbitrary blocking and throttling of services, and increasing trans- 29Net neutrality enshrined
parency at the access ISP and in backbone networks.31 In France, in dutch law. URL: http:
//www.theguardian.com/technology/
followinganationalTelecomsPackageof2009,theNationalRegula-
2011/jun/23/netherlands-enshrines-
toryAuthorityARCEP32 wasassignedincreasedpowersinthemon- net-neutrality-law
30https://www.whitehouse.gov/net-
itoringofnetworkneutralityandissuedaseriesofrecommendations
neutrality
forISPsin2010and2012.
31FCC. Protecting and promoting
IntheEuropeanUnion, areviewoftheEuropeanTelecomsPack- the open internet. April 2015. URL:
https://www.federalregister.gov/
agein2009introducedthefirstprovisionsforincreasedtransparency
articles/2015/04/13/2015-07841/
andstarteddiscussionsaboutmorecomprehensiveregulations,which protecting-and-promoting-theopen-
were approved in October 2015 and have been effective since 30th internet
32Autorité de régulation des commu-
April 2016. Thanks to this, the European legislation now (i) forbids
nications électroniques et des postes.
any discriminatory treatment of Internet traffic and guarantees the http://www.arcep.fr/
right of all users to access and distribute contents of their choice;
(ii) limits the circumstances under which an ISP can apply restric-
tive traffic management policies to its network (for example in case
of congestion, exceptional security threats or specific court orders);
(iii) states explicitly that optimized services should not degrade the
performance of regular traffic; (iv) calls for monitoring of the com-
mercial practices of ISPs and (v) strengthens the transparency obli-
gations of ISPs, especially pertaining traffic management. The text
mandates that the National Regulatory Authorities (NRAs) should
chapter 2. context and related work 25
beinchargeofenforcingtheserules.
However, currently there is no general consensus on how NRAs
should verify that ISPs do not apply any discriminatory practices to
user traffic. For example, a NRA could decide to adopt a reactive
approach,byexpectinguserstofilereportsandactuponthem,orto
have a proactive approach, in which measurements should be per-
formed on each ISP operating on the national territory. NRAs also
face the problem of selecting the tools to run such measurements.
It has been observed33 that NRAs inside the European Union have 33Ioannis Koukoutsidis. Public QoS
adoptedavarietyofmeasurementtools,34 mostofwhichsimplyfo- andnetneutralitymeasurements. Jour-
nalofInformation,5,2015
cus on network troubleshooting to conduct their verifications, and
34BEREC. Annex of monitoring
amongthetoolsproposedbytheresearchcommunity(whichwere- quality of internet access services in
view in details in Section 2.5) only one, NANO, has been adopted the context of net neutrality. BEREC
Report BoR (14) 117, September 2014.
by a handful of European NRAs. Nonetheless, the Body of Euro-
URL: http://berec.europa.eu/eng/
pean Regulators of Electronic Communications (BEREC)35 has been document_register/subject_matter/
berec/download/1/4602-monitoring-
releasing a number of documents providing NRAs with recommen-
quality-of-internet-access-se_
dationsandbestpracticesonhowtoenforcenetworkneutralityand 1.pdf
when to intervene. A framework for the evaluation of Quality of 35http://berec.europa.eu/
Service (QoS) has been discussed, as well as when and how mini-
mum QoS requirements should be set.36 Also, guidelines have been 36BEREC. A framework for Qual-
provided on a few key problems:37 (i) what the regulatory is- ity of Service in the scope of Net
Neutrality. BEREC Report BoR (11)
sues are with regard to QoS and Internet neutrality; (ii) which in- 53, December 2011. URL: http:
stancesofservicedegradationrequirefurtherinvestigationbyNRAs //berec.europa.eu/eng/document_
register/subject_matter/berec/
and (iii) when regulatory intervention is necessary. More recently, a
download/0/117-a-framework-for-
BEREC report also discussed 38 the requirements for network mea- quality-of-service-in-th_0.pdf
surements to have legal value and described possible measurement 37BEREC. Guidelines for qual-
ity of service in the scope of net
methodologies, which could be hardware or software based, target-
neutrality. BEREC Report BoR (12)
ing an ISP or going up to Internet Exchange Points (IXP’s), using 131, November 2012. URL: http:
active or passive techniques and applicable to fixed, wireless and
//berec.europa.eu/eng/document_
register/subject_matter/berec/
mobile setups. The ultimate goal is to reach a convergence of met-
download/0/1101-berec-guidelines-
ricsandmethodsacrossEuropeancountries,soastohaveauniform for-quality-of-service-_0.pdf
frameworkandallowcross-countrymeasurements.
2.5 Tools for the detection of traffic differentiation
Anumberofmethodsforthedetectionoftrafficdifferentiationhave
been proposed in recent years in the literature. When performing
measurements, one can do it passively, by collecting information
from existing user traffic, or actively, by injecting traffic on the net-
work and carrying out measurements on it. Among the proposed
tools that detect traffic differentiation, NANO (Section 2.5.6) is the
only one using passive measurements, while all other ones use ac-
tive probing. Among these, relative discrimination is the most com-
mon technique: an application flow mimicking the behaviour of an
application to test and a reference (or baseline) flow that is not sup-
posed to experience differentiation are replayed between a user and
a measurement server. By comparing the performance of the two
flows, one can infer whether the application flow has been differen-
tiated. This is the technique adopted, with various modifications in
26 inference of network neutrality violations with active measurements
theirmethodology,inBT-Test(Section2.5.1),Glasnost(Section2.5.2),
DiffProbe (Section 2.5.3), ShaperProbe (Section 2.5.4), Packsen (Sec-
tion2.5.5),NetPolice(Section2.5.8)andDifferentiationDetector(Sec-
tion2.5.7),whichisalsotheonlytoolthatisimplementedspecifically
for mobile networks. Zhang et al. (Section 2.5.9) on the other hand
proposedamodelthatshowwhenitisfeasibletoobserveandlocal-
ize violations of network neutrality. Finally, Neubot (Section 2.5.10)
does not directly infer neutrality violations, but routinely collects
measurements from end users in order to have a global picture to
monitorovertime.
Table2.1summarizesthekeyaspectsofeachmethodology,which
weassessgloballyinSection2.5.11.
2.5.1 BT-TEST
ReportsonBitTorrentdiscriminationbeingperformedatthetimeby
Comcast in the United States were largely covered by Internet me-
dia.39 Regularusers,though,didnothavetoolstoevaluatewhether 39Packet forgery by ISPs: A report
theirISPwasdifferentiatingBitTorrenttraffic. Thefewexistingnetwork- on the comcast affair. URL: https:
//www.eff.org/wp/packet-forgery-
troubleshooting tools required expert knowledge in order to be ap-
isps-report-comcast-affair
pliedtothisparticulardifferentiationcase.
BT-Test40 enables users to verify whether: (i) their ISP is block- 40MarcelDischinger,AlanMislove,An-
ing BitTorrent traffic using forged RST packets; (ii) their ISP is able dreasHaeberlen,andKrishnaP.Gum-
madi. Detecting BitTorrent Blocking.
to identify BitTorrent flows by looking at port numbers, BitTorrent In Proceedings of the 8th ACM SIG-
protocol messages, or both and (iii) differentiation affects uploads, COMM Conference on Internet Measure-
ment (IMC’08), Vouliagmeni, Greece,
downloads,orboth.
October2008
The tool checks for RST packet injection and only tests BitTorrent
flows.
Outline of the method. BT-Test replays eight different flows between
theuserandameasurementserver. FlowsvaryintheTCPportnum-
ber(6881,awell-knownBitTorrentport,or4711,notassociatedwith
any protocol) the direction (upstream or downstream) and the ap-
plicationpayloads(BitTorrent-likeorrandomizedbutwiththesame
sizeand orderingasin BitTorrentflows). Each oftheeight resulting
combinationsisruntwiceandlasts10seconds. Theserverperforms
acompletelink-levelpacketcapture,thusavoidingtheburdenofre-
quiring administrator privileges on the client side, where the user
simplyrunsaJavaapplet. TheclientonlykeepstrackofJavaexcep-
tionswitherrormessagesofinterest.
Differentiation is detected when (i) the server-side packet trace
containsatleastoneincomingRSTpacketand(ii)IOexceptionssig-
nalingaterminatedconnectionareseenbytheapplet. Byexamining
theresultsobtainedineachtest,thetoolidentifieshowtheISPclas-
sifiesflowsasBitTorrent,thatistosaywhetherthediscriminationis
basedontheportnumberorontheprotocolmessages,andwhether
itaffectsupstreamordownstreamBitTorrentflows.
chapter 2. context and related work 27
Resultsfromtestsinthewild. ItwasfoundthatComcastblockedup-
loads only when a user had finished the download of a file and up-
loaded it altruistically. As for flows identified as BitTorrent through
inspection of message protocols, by looking at the flow trace on the
server it was possible to determine at which point of the message
exchange the ISP triggered differentiation. Interestingly, contrary to
what some ISPs had claimed at the time, no differentiation during
peak-hourswasevidentfromthelargesampleofgatheredtests.
User’s point of view. The user starts the test trough a Java applet
includedinadedicatedwebpage,waitsforthetesttocompleteand
then results are immediately displayed. The tool is not currently
available,asitwassupersededbyGlasnost(Section2.5.2).
2.5.2 Glasnost
Withnotoolatthetimebeingsuitabletobeusedbythelargepublic,
Glasnost41 aims to be a widely-usable tool whose primary focus is 41Marcel Dischinger, Massimiliano
non-savvyusers. Marcon, Saikat Guha, Krishna Gum-
madi, Ratul Mahajan, and Stefan
Thethreemaindesignprinciplesare:
Saroiu. Glasnost: Enabling End Users
to Detect Traffic Differentiation. In
• Low barrier of use (simple and intuitive interface, no installa- Proceedings of the 7th Symposium on
Networked Systems Design and Imple-
tion of additional software required, no administrative privileges
mentation (NSDI), San Jose, CA, Apr
needed, quick computation of results, results immediately dis- 2010
playedtotheuser).
• Accuracy of results and no space for misinterpretation (reducing
the effects of confounding factors, minimizing false positives at
theexpenseoffalsenegativesandretainingpositiveresultsincase
thetoolischallengedtojustifyitsfindings).
• Easiness of evolution (extendibility of the system and avoiding
white-listing).
Outline of the method. The tool emulates an application flow and a
reference flow, of which only the latter should trigger differentia-
tion, if any shaper is deployed along the path. The difference be-
tween the two flows is on port numbers and application payload,
whereas all fields at the IP layer remain unchanged. Glasnost in-
terleaves these two flows and sends them between the user and a
measurement server 5 times. Each flow lasts 60 seconds to allow
TCP to achieve a stable throughput. Since throughput in TCP is di-
rectly affected by any differentiation technique, that is what the tool
comparesbetweenthetwoflows.
Twostepsareinvolvedintheanalysis:
1. Noise filtering. In order to identify noisy paths, the tool analyzes
the variance of throughput of the two flows. Noise is calculated
as the difference between maximum and median throughput, di-
vided over the maximum throughput. All tests affected by high
28 inference of network neutrality violations with active measurements
noise are discarded. From empirical tests, up to a 20% of differ-
encebetweenmedianandmaximumthroughputistobeexpected
intheabsenceofconsiderablenoise.
2. Differentiation detection. The idea is that in scenarios with low
noise, most throughput measurements lie close to the maximum
throughput. Since noise tends to lower the throughput, the maxi-
mumthroughputisagoodapproximationofthethroughputthat
flows could achieve without cross traffic. In the first implemen-
tation of the tool, differentiation is inferred when the maximum
throughput of the two flows differs by more than 20%. In such
version of Glasnost the total duration of the test was 20 minutes,
which proved to be too long for most users, who abandoned the
test before its completion. The test duration was then reduced
down to 6 minutes and the minimum difference between maxi-
mumflowthroughputsfordifferentiationdetectionwasincreased
to50%,inordertominimizefalsepositives.
Resultsfromtestsinthewild. The first test implemented in Glasnost
checked whether ISPs differentiated BitTorrent flows based on con-
tent or port numbers, downstream or upstream. 21% of users were
affected by differentiation and not all customers of the same ISP
which performed differentiation were affected. Detailed results are
availableonline,sortedbycountryandISP.42
42http://broadband.mpi-sws.org/
transparency/results/
User’spointofview. AuserneedstogoontheGlasnostwebpage43 43http://www.measurementlab.net/
(hosted by M-Lab44) and select an application flow to test. The test tools/glasnost/
44Measurement Lab is an open plat-
iscarriedoutthroughaJavaapplet,foratotaldurationof6minutes,
form for researchers to deploy Inter-
after which the results are displayed. Currently, available tests are: net measurement tools. URL: http:
BitTorrent, eMule and Gnutella for peer-to-peer applications; flash //www.measurementlab.net
Constantine Dovrolis, Krishna Gum-
videoforvideostreamingapplications;POP,IMAP4,HTTPtransfer,
madi, Aleksandar Kuzmanovic, and
SSHtransferandUsenetformoregenericservices. SaschaD.Meinrath. Measurementlab:
Advanced users are provided with a tool45 which automatically overview and an invitation to the re-
searchcommunity. SIGCOMMComput.
generatesanewGlasnosttestfromthepacket-leveltraceofanappli- Commun.Rev.,40:53–56,June2010
cation. It extracts packet size, payload, order of packets exchanged 45http://broadband.mpi-sws.org/
transparency/createtest.html
andinter-packettiming. TheoutputisuseddirectlybytheGlasnost
applet. The application flow preserves ordering at the expense of
timing,sinceitisassumedthatISPsusuallyidentifyapplicationsby
looking only at the sequence of protocol messages. The reference
flowdiffersfromtheapplicationflowinitspayloadsandportnum-
bers. The user uploading the trace can set port numbers to specific
values,otherwisetheyarerandomlychosen.
2.5.3 DiffProbe
Startingfromtheassumptionthatanyformofdiscriminationresults
in high delays or high loss rates, the goal of DiffProbe46 is to detect 46Partha Kanuparthy and Constantine
if: Dovrolis. Diffprobe: detecting ISP ser-
vicediscrimination.InProceedingsofthe
• the traffic of an application is being classified as low-priority by 29th conference on Information communi-
cations,INFOCOM’10,pages1649–1657,
anISP;
Piscataway,NJ,USA,2010.IEEEPress
chapter 2. context and related work 29
• theISPperformsdelaydiscrimination,lossdiscrimination,orboth;
• theschedulertype, implementingStrictPriority(SP)orWeighted
FairQueueing(WFQ),canbeidentified.
Whennodifferentiationistakingplace,thetoolassumesthatISPs
use the First-Come-First-Served (FCFS) scheduling discipline and
DropTailbuffermanagementpolicy.
Outlineofthemethod. Atfirst,anestimationofupstreamanddown-
streampathcapacitiesbetweenclientandmeasurementserverisper-
formedusingtrainsofpackets. Then,anapplication(A)andarefer-
ence(P)flow aresentsimultaneously duringtwo replayphasesand
one-waydelays,aswellasthenumberoflostpackets,aremeasured
forthetwoflows. Flow Ausesapre-recordedtraceofSkypeorVon-
age and it keeps the same port numbers, transport protocol, packet
sizes, inter-packet gaps and payloads as in the respective original
application, while the last four payload Bytes are overwritten with
the sender timestamp for easier one-way delay measurement. Flow
P is crafted with the same number of packets and the same packet
sizesasinflow A;payloadsarerandomized(excludingthesender’s
timestamp) and port numbers are those not commonly associated
with any service, so that packets are unlikely to be classified as low
priority. Packets of flow P are sent at about the same time as those
offlow A.
Theexperimentcomprisestwophases,whichDiffProbeperforms
downstreamandupstream:
• Balanced Flow Period (BLP). Both flows are sent at their nominal
rates.
• LoadIncreasePeriod(LIP).TherateofflowPisscaledupsoasto
maximize the chances of queueing in the ISP network. This way,
flowsAandPshouldsaturatetheuser’saccesslink.
ThefirstcomparisonDiffProbeperformsisbetweenthe90th-percentile
of delays of flow P during the LIP phase and the median delay of
flow PduringtheBLPphase. Iftheformerisnotsignificantlylarger
than the latter, differentiation cannot be detected, since the exper-
iment did not seem to trigger any queueing. The ISP might still
deploy some kind of differentiation, but it has no significant effect
ontheuser’straffic.
Delay discrimination detection. The tool first checks for equality of
the delay distributions of flow A and flow P during the LIP phase.
It selects only the packets that might have experienced queueing by
considering, for each packet in flow A, the first packet in P sent no
later than the transmission time of an MTU-sized packet in the bot-
tleneck link. If no such sample in P exists, this packet of flow A is
discarded. Ifitdoesexist,apaircontainingthedelayofthetwosam-
ples (one for flow A, one for flow P) is added to the set of delays to
30 inference of network neutrality violations with active measurements
analyze. Afterremovingfromthissetthedelaysthataretoocloseto
thepropagationdelay,estimatedastheminimumdelayofeachflow,
the propagation delay is subtracted from each sample, so that the
resulting delay values will approximate the queueing delays experi-
encedbythepacketsofthetwoflows. Onthesevalues,thetoolruns
the non-parametric Kullback-Leibler (KL) divergence test, which re-
jects the two input sets if they do not follow the same distribution.
When this is the case, DiffProbe goes on to test for inequality of the
two empirical distributions: it checks that all higher percentiles (be-
tween 50th and 95th) of the empirical delay distribution of flow A
are larger than the corresponding ones of flow P. If this holds true,
thetoolreportsthatdelaydiscriminationwasappliedtoflow A.
Furthermore, DiffProbe attempts to identify whether the packet
scheduling algorithm used for differentiation is Strict Priority (SP)
or Weighted Fair Queueing (WFQ). In a SP scheduler, an arriving
P packet will never experience queueing delays due to backlogged
low-priority packets, while in a WFQ scheduler it could. Therefore,
for each burst of P packets the tool now only considers the first
packet, which is the only one that is most likely to not have been
backlogged behind other high priority packets. In this subset of P
packets, the tool examines the variability of the delay distribution:
with SP scheduling it should be very small, whereas with WFQ it
shouldbesignificantlyhigher.
Loss discrimination detection. DiffProbe also compares the losses of
flows A and P in order to discover discriminatory buffer managers.
Toensurethatthetwoflowssamplethesamecongestionevents,the
samepairingasinthedelayanalysisisperformed. Ontheresulting
samples,thetoolrunsthetwo-proportionz-testforequalpopulation
proportions, which will fail if the loss events in the two flows differ
considerably.
Validation and results from tests. The tool was validated in a simu-
latedenvironment. TestsinresidentialISPs,locatedintheUSandin
Europe,didnotshowanydifferentiation.
User’spointofview. TheuserchoosesbetweenaSkypeandaVonage
UDP trace, each 10 minutes long, and launches the test from the
commandline. Resultsareshownuponcompletionofthetest.47 47http://netinfer.net/diffprobe/
2.5.4 ShaperProbe
AnextensionofDiffProbe(Section2.5.3),ShaperProbe48 attemptsto 48Partha Kanuparthy and Constantine
verify whether an ISP is shaping user traffic and, more specifically, Dovrolis. Shaperprobe:End-to-endde-
tection of isp traffic shaping using ac-
if the user connection drops automatically to a low rate after some tivemethods. InProceedingsofthe2011
time,duetoashaper. ACM SIGCOMM Conference on Internet
MeasurementConference,IMC’11,pages
Trafficshapingismodeledasatokenbucket,allowingamaximum
473–482.ACM,2011
burst of traffic to be serviced at the peak capacity of the link, while
anyremainingtrafficisservicedatalowerrate(i.e. theshapingrate).
chapter 2. context and related work 31
PowerBoostisanexampleofashaperbasedonsuchmechanism.49,50
49In the version deployed by Comcast
in the U.S, it allows faster downloads
up to 20 MB of data and faster up-
Outline of the method. The capacity of the path between user and loads up to 10 MB, after which it de-
server is estimated in both directions before starting the actual ex- creases the speed to the regular pro-
visioned one. Since it increases a
periment: the sender sends trains of back-to-back packets and the
user’s contractual speed, it is actually
receiver estimates the path capacity by measuring the dispersion of a form of positive shaping. http://
each train. Then the sender probes the receiver at a rate equal to www.dslreports.com/faq/14520
50Srikanth Sundaresan, Walter De Do-
the path capacity. The receiver records the received-rate timeseries
nato, Nick Feamster, Renata Teixeira,
by discretizing time into intervals of duration D and estimating the Sam Crawford, and Antonio Pescapè.
Measuring home broadband perfor-
receiving rate for each interval as the amount of bits received over
mance. Communications of the ACM,
intervalD. Probingstopswheneitherthereceiverseesalevelshiftin 55(11):100–109,2012
thetimeseriesorthedurationoftheprobingexceeds60seconds. The
experimentiscarriedoutinupstreamanddownstreamdirections. In
casealevelshiftisdetected,shapingparametersareestimated:
• theshapingrateasthemedianrateafterthelevelshift;
• the burst size based on the number of Bytes sent before the level
shift.
Itisworthpointingoutthat,sinceshapingmechanismslikePower-
Boost affect all flows regardless of their origin, the replayed trace
reproduces a single flow which does not belong to any specific ap-
plication.
Validation and results from tests in the wild. In order to test the accu-
racy of the method, ShaperProbe was validated on two ISPs where
theshapinggroundtruthwasknownandinanemulatedwide-area
setup. The measurement server used to be hosted on M-Lab. Re-
sultsfromM-LabusersshowedthatU.S.operatorsComcastandCox
were indeed shaping traffic of a large fraction of their users, while
evidencefromotherU.S.operatorsonlyinvolvedbetween5and10%
oftheirsubscriberswhoranDiffProbe.
User’spointofview. The user runs the tool from the command line.
The experiment lasts for about 3 minutes, after which results are
immediatelydisplayed.51
51http://netinfer.net/diffprobe/
shaperprobe.html
PassivevariantforTCPflows. Apassivetechniquewhichusesanop-
timizedversionofShaperProbewasalsoproposed. Ittakesasinput
anapplicationpackettraceanditisparticularlyusefulwheneveran
ISP performs shaping on flows based on packet fields that are diffi-
cult to replicate with active probing to a server, such as destination
andsourceIPaddresses. InorderforShaperProbetoapplytoaTCP
flowtheauthorshadtotakeintoaccountthat:
• a level shift in TCP throughput occurs every time TCP decreases
itswindowduetotimeoutsorpacketlosses;
• TCP does not send a constant rate stream, making it difficult to
estimatethenumberoftokensinthetokenbucket-indeed,tokens
32 inference of network neutrality violations with active measurements
can accumulate when the TCP throughput is below the shaping
rate;
• Accumulation of tokens might also happen when shaping kicks
in,asitmighttriggerTCPback-offsandtimeouts.
Therefore it is essential to be able to distinguish throughput level
shiftsduetoashaperfromthoseduetoTCPback-offs. Thisisdone
by analyzing the variability of a carefully constructed timeseries of
cumulativeBytesreceivedatthereceiver.
ThispassivemethodwasvalidatedusingalargesetofNDTtraces
collected at M-Lab. Also, consistent results were found between
active and passive methods by having the passive variant analyze
ShaperProbeexperimenttraces.
2.5.5 Packsen
Existing tools either focused on simply detecting the existence of
flowdiscrimination(BT-Test,Glasnost,NANO)orrequiredrelatively
long calculations to obtain accurate results (DiffProbe). Packsen52 52Udi Weinsberg, Augustin Soule, and
detects traffic shaping and infers its parameters, with a faster infer- Laurent Massoulié. Inferring traffic
shaping and policy parameters using
ence and still high detection accuracy, even in the presence of cross
endhostmeasurements. InINFOCOM,
traffic. Asseeninothermethodsintheliterature,itreplaysanappli- pages151–155,2011
cation (BitTorrent) and a reference (HTTP) flow, and compares their
performance.
Outlineofthemethod. Theexperimentismadeofuptothreephases,
aimed at respectively detecting shaping, inferring the shaper type
and its parameters, and inferring WFQ shaper weights in case of
significant cross traffic. The computational cost increases with each
phase.
1. Detection of shaping. Two short interleaved flows of 20 packets
each are sent to a measurement server. The tool then compares
the distribution of inter-arrival times of the two flows with the
Mann-Whitney U-test, which is accurate also on small samples.
If the test rejects the two flows, the tool infers that shaping took
placeandmovestothenextphase.
2. Inferenceofshapertypeandparameters. Theexperimentisrepeated,
but with flows of 100 packets each. Packsen then compares the
valuesobservedforsentandreceivedbandwidth;theformerisas-
sumedtoestimatethesender’sbandwidth,whilethelattershould
estimate the bandwidth induced by the shaper. A Strict Priority
(SP)schedulerisrecognizedwhenthesentbandwidthdominates
thereceivedbandwidth. Ifthisdoesnothappen,thetoolassumes
that the scheduler implements Weighted Fair Queueing (WFQ)
andestimatestheflowweights.
3. InferenceofWFQweightswithcrosstraffic. Inthepresenceofheavy
crosstraffic,phase2doesnotyieldcorrectresultsforWFQsched-
ulers. The tool analyzes the arrival times of selected flow packets
chapter 2. context and related work 33
from phase 2 and infers WFQ weights, while taking into account
cross traffic, which it models as a Poisson process. The experi-
mentinphase2isrepeatedseveraltimesuntilthevarianceinthe
resultsissufficientlylow.
Results from tests. Validation was carried out both in a controlled
testbedwithemulatedcrosstrafficandwithalargesetofPlanetLab
nodes.
User’spointofview. Thetoolisnotavailableforpublicuse.
2.5.6 NANO
Existingtoolsfordetectionoftrafficdifferentiationaretypicallyspe-
cific to an application or focus on a particular differentiation mech-
anism. Also, their use of active probing makes it easy for an ISP
to detect injected measurement flows and treat them accordingly,
by ether blocking or prioritizing them. Nano53 overcomes all this 53Mukarram Bin Tariq, Murtaza Moti-
by performing passive measurements and using causal inference to wala,NickFeamster,andMostafaAm-
mar. Detectingnetworkneutralityvio-
quantify the causal relationship between an ISP and the observed
lationswithcausalinference.ACMSIG-
servicedegradation. COMMCoNext,page289,2009
Causalinference. LettheactiontakenbyanISPbetreatmentvariable
X and let the observed service performance be outcome variable Y.
InordertoestablishacausalrelationbetweenXandY,allthefactors
thatmightgenerateinterferenceshouldbeidentified. Theycouldbe:
(i) client-based: application, operating system, computer configura-
tionandtheuser’slocalnetworkservicecontract;(ii)network-based:
client and ISP location (with respect to the location of servers on
the Internet), or a path segment to a particular service provider not
sufficiently provisioned and (iii) time-based: time of the day, since
serviceperformancemightvarywidelythroughouttheday,bothfor
ISPs and service providers. Once measurements are gathered, they
are divided into strata so as to have in each stratum similar values
for each confounding variable. Within a stratum NANO can easily
compute the measure of the observed effect (the association value),
on outcome variable Y (the service performance), and claim that it
converges to causal effect. Therefore association can be used as a
metricofcausaleffectwithinastratum.
Outline of the method. Instead of attempting to detect a specific be-
haviour,NANOdirectlyobservestheperformanceoftrafficandtries
toinferthecausesofdegradedperformanceincaseofitsoccurrence.
A NANO agent resides on an end host, collects traffic data from
it and aggregates traffic statistics that it later sends to a centralized
server. In particular, an agent collects features that help to identify
the client setup, it determines the topological location of the client
and their ISPs and it timestamps all collected data. These will be
the confounding factors sent to the server. An agent analyzes IP,
34 inference of network neutrality violations with active measurements
transport and application protocol headers to identify the services
run by the user and for each flow it measures throughput and jitter,
andcountslossesaswellaspossibleincomingTCPRSTpackets.
A server receives data from the agents and applies the following
actionstodetecttrafficdifferentiation:
1. Itstratifiesthedata. Bins(rangesofvalues)arecreatedforeachcon-
foundingvariable. Adjacentstrataarecombinedifthedistribution
of outcome variable Y conditioned on the treatment variable X is
identicalinmorestrata.
2. It establishes baseline and causality. It takes as baseline the average
performance of all other clients with similar values for all con-
foundingvariablesexceptfortheaccessISP.
3. Itinfersthediscriminationcriteria. Adecisiontreeisusedtogener-
aterulesindicatingthediscriminationcriteriathattheISPapplies.
Validation. Thevalidationsetupincluded:
• agentsrunningonclientsdeployedonEmulabhosts,sothatcon-
foundingvariablesontheclientsidecouldbecontrolled.
• ISPs represented by shapers also running on Emulab hosts, in or-
der to directly apply various discrimination techniques (proba-
bilistic dropping of packets on all flows or on flows exceeding a
certain length, dropping of TCP acknowledgements, dropping of
packetsforaparticularserviceordestination,andTCPRSTinjec-
tion);
• ContentprovidersonPlanetLabnodes,whichensuredthatexper-
imentsusedrealInternetpaths;
• aserveronaregularInternethost.
NANOcorrectlyidentifieddiscriminatingandneutralISPsinallval-
idationtests.
Due to the methodology used to infer differentiation, a deploy-
mentofNANOinthewildwouldrequirealargeuserbaseinorder
tocorrectlyestablishcausalinference.
User’s point of view. NANO agents are voluntarily installed by end
users,54 who are asked to manually provide details about their net- 54https://noise-lab.net/projects/
work interface (wired or wireless), the type of contract with their old-projects/nano/
ISP and their geographic location. The project appears to have been
discontinued.
2.5.7 Differentiation Detector
Recently Differentiator Detector,55 a tool for the detection of traffic 55ArashMolaviKakhki,AbbasRazagh-
differentiationinmobilenetworks,wasproposed. Itaddressestheis- panah, Anke Li, Hyungjoon Koo, Ra-
jesh Golani, David Choffnes, Phillipa
sueofscalabilitytoarbitraryapplicationsbyfullyreplayingbetween
Gill,andAlanMislove.Identifyingtraf-
theuserandameasurementserverapreviouslydumpedflow. Italso fic differentiation in mobile networks.
In Proceedings of the 2015 ACM Confer-
enceonInternetMeasurementConference,
pages239–251.ACM,2015
chapter 2. context and related work 35
avoids all sorts of rooting or jailbreaking on a user’s mobile phone
by moving the task of capturing traffic to a server and by replaying
flowsrightfromtheapplicationlayer.
Outlineofthemethod. Theexperimentcomprisestwophases:
• Dump. At first, the user is asked to run on her Android mobile
phonetheapplicationsheintendstotestafterconnectingtoMed-
dle,56 a VPN proxy over IPsec, which relays traffic between user 56Ashwin Rao, Justine Sherry, Arnaud
and destination and dumps the selected application flow. The Legout, Arvind Krishnamurthy, Walid
Dabbous, and David Choffnes. Med-
VPN proxy then produces a transcript describing the packet ex-
dle: middleboxes for increased trans-
change that took place in downstream and upstream directions, parencyandcontrolofmobiletraffic.In
Proceedingsofthe2012ACMconferenceon
and the corresponding inter-packet times. This transcript is then
CoNEXTstudentworkshop,pages65–66.
deliveredtoboththeuserandameasurementserver,sothatthey ACM,2012
can replicate the behaviour of the selected flow. In the current
versionofthetool,thisphaseisskippedandtheuserisprovided
withasetofpre-recordedtracestoreplay.
• Replay. User and measurement server replay the flow first as it
is, while of course overwriting the original server-side IP address
with theIP addressof the measurementserver, and then through
anencryptedVPN.Theideaisthatashaperthatwantstoaffecta
given application will be able to identify the corresponding flow
when replayed out of the VPN, but not when the packets are en-
crypted. The replay phase is carried out twice to minimize the
effects of possible noise. For TCP flows, throughput and Round-
Trip Times (RTT’s) are measured on the captured trace from the
serverside,whileforUDPflowstheclientcomputestheflowjitter
from the inter-packet timings at the application layer. Losses are
recordedforallflows.
In order to evaluate the performance of the application and the
control flows, that is to say the flows replayed respectively outside
andinsidetheVPN,thetoolfirstrunsthetwo-sampleKolmogorov-
Smirnovtest,whichassessesthemaximumverticaldistancebetween
twoempiricalCDF’s. Then,thetoolappliesatailoredtestthatrejects
the flows if the normalized area between their empirical CDF’s is
greaterthanagiventhreshold. Thereasonbehindthisistotakeinto
account also the horizontal distance between the two curves before
declaring that a flow has been differentiated. The analysis on flow
losses simply compares maximum and average flow losses over the
tworeplays.
Validation and results from tests in the wild. Differentiation Detector
was validated with two commercial shapers, which correctly identi-
fiedapplicationflowsanddisregardedcontrolflows. Theauthorsof
the tool were able to reverse engineer the flow classification mecha-
nismofthesetwoshapersandfoundoutthatflowsgetmostlyiden-
tified as belonging to a particular application with the use of regu-
lar expressions on packet payloads (Deep Packet Inspection) and by
lookingatportnumbers.
36 inference of network neutrality violations with active measurements
TestsfromusersinmostmajormobileprovidersintheU.S.showed
casesofshapingforYouTube,NetFlixandSpotifyinthefirstsemester
of2015.
User’s point of view. The user needs to install Differentiation Detec-
tor57 from Google Play and then selects one application flow to test 57http://dd.meddle.mobi/index.html
between YouTube, NetFlix, Spotify, Skype, Viber and Google Hang-
out. Theoutcomeofthetestisshownrightaftertheexperiment.
2.5.8 NetPolice
Asopposedtoallothermethodssofardescribed,whichtestauser’s
accessISP,NetPolice58aimsatdetectingtrafficdifferentiationinback-
58Ying Zhang, Zhuoqing Morley Mao,
bone ISPs. It selectively probes from a number of hosts ingress and and Ming Zhang. Detecting traffic
differentiation in backbone isps with
egress routers of backbone ISPs with TTL-limited packets and an- netpolice. In Proceedings of the 9th
alyzes the loss rates observed along the same ingress-egress path ACM SIGCOMM Conference on Internet
MeasurementConference,IMC’09,pages
segments. Itisabletodetectcontentdifferentiationbasedonpacket
103–115.ACM,2009
payloads or port numbers and routing differentiation based on the
next-hopandprevious-hopautonomoussystem(AS).
Outline of the method. The methodology used by NetPolice can be
brokendownintothreesteps:
1. Path selection. Given a set of hosts running NetPolice, the tool
runs traceroute to all prefix destinations on the Internet in or-
dertodiscoverwhichsource-destinationpairscrosswhichingress
and egress routers of backbone ISPs along the path and at which
hopssuchroutersarefound. Afterwardsthetoolselectsthesetof
paths to test so that it minimizes the number of experiments per
hostwhilestillhavinganexhaustivepictureofanISPingressand
egress points, probed from various sources and with various IP
destinationaddresses.
2. Path measurement. Each host is instructed to test a given path a
number of times and does so by sending packets with applica-
tion contents and the specified TTL values so that they expire at
the targeted ingress and egress ISP routers and generate ICMP
time-exceedederrormessages. Probingisperformedataconstant
rate of 1 packet per second (pps) for 200 seconds, so as to min-
imize losses due to routers implementing ICMP rate limitation.
Sentpacketsarethesamesize(200Bytes)andhaveportnumbers
andapplicationpayloadsfrom5differentapplications: BitTorrent,
SMTP,PPLive,VoiPandHTTP.
3. Differentiation detection. For the same pair of ingress and egress
routers, NetPolice computes the per-experiment loss rate of this
internal path by subtracting the ingress loss rate from the egress
loss rate. Then, it verifies whether probes belonging to the five
applications, coming from different sources and destined to dif-
ferent IP prefixes, experienced similar loss rates along this path
segment. In order to detect content-based differentiation, it runs
chapter 2. context and related work 37
the Kolmogorov-Smirnov (KS) test between the loss rate distribu-
tion of experiments carrying HTTP traffic (used as baseline) to
that of experiments carrying any of the other four tested applica-
tions. Similarly,butregardlessoftheapplications,NetPoliceruns
the KS test on the loss rate distribution of experiments traversing
the same AS right before reaching the target ingress-egress pair,
againstthelossratedistributionofexperimentsthatcrossedadif-
ferentAS.ItthenrunstheKStestonthesetofexperimentsrouted
todifferentAS’safterthesameingress-egresspath.
Results from tests. A measurement campaign was performed from
200 PlanetLab hosts, targeting 18 backbone ISPs. Content-based dif-
ferentiationwasfoundin4ISPs,whilerouting-baseddifferentiation
was found in 10; the observed difference in loss rates was up to 5%.
Since only a fraction of paths in a given ISP indicated traffic differ-
entiation, it was conjectured that a high network load on a subset
of all internal paths of an ISP might trigger differentiation. By also
analyzing the Type of Service (TOS) field in the quoted IP packet of
returnedICMPtime-exceededmessages,acorrelationwasoccasion-
ally found between the observed TOS value and the resulting loss
rates.
User’spointofview. NetPoliceisnotintendedforendusers.
2.5.9 Neutrality Inference through Network Tomography
Zhang et al.59 recently proposed a theoretical tomography-inspired 59Zhiyong Zhang, Ovidiu Mara, and
framework where they claim that, given the topology of a network Katerina Argyraki. Network neutral-
ityinference. InProceedingsofthe2014
andexternalend-to-endpathmeasurementsoveritspaths, suchob-
ACM Conference on SIGCOMM, SIG-
servationsareinconsistentwitheachotherwhenthenetworkisnon- COMM ’14, pages 63–74, New York,
NY,USA,2014.ACM
neutral. The authors describe the conditions that are necessary to
observe neutrality violations and to localize them on specific links,
independentlyofhowtrafficdifferentiationisimplemented.
Since network tomography essentially assumes that a network is
neutral and that a neutral link has the same properties for all paths
traversingit,aneutralnetworkcanberepresentedbyasolvablesys-
temofequationswherethesumofunknownspecificlinkproperties
ofagivenpathequalsameasuredmetriconthatpath. Theinsightof
this work is that if such system is unsolvable, it indicates a possible
neutralityviolation.
Outline of the model. The proposed model can be split into three
contributions:
1. Observabilityofneutralityviolations. Foranynetworkwhereaneu-
trality violation is detected there exists at least one equivalent
neutral network that, given the same traffic input, would cause
the same external observations as in the original non-neutral net-
work. This equivalent neutral network is constructed so that any
non-neutral link in the original non-neutral network is split into
38 inference of network neutrality violations with active measurements
two links: (i) a regular link that retains the same properties that
originally applied to non-differentiated traffic, and (ii) an extra
link, called virtual link, inserted in such a way in the network
topology that only differentiated traffic flows through it and has
thesamepropertiesoriginallyappliedtodifferentiatedtraffic. The
modelclaimsthataneutralityviolationisexternallyobservableif
and only if the equivalent neutral network contains at least one
virtual link that is distinguishable from any link in the original
non-neutral network. That is to say, if there is at least one virtual
link whose set of paths traversing it differs from the sets of paths
traversingallotherlinksintheoriginalnetwork.
2. Localization of neutrality violations. Once a network has been de-
tected to be non-neutral, the non-neutral links can be pinpointed
to a link sequence of the original network, as long as this link
sequence is crossed by a sufficiently diverse number of paths. A
system of equations is constructed as described above, but only
over the network slice containing the suspected link sequence. If
thissystemisunsolvable,thenthelinksequenceisnon-neutral.
3. Algorithm. Zhang et al. finally proposed an algorithm that, given
as input the topology of a network and the results of measure-
mentsoveritspaths,itoutputsanynon-neutrallinksequences. It
firstchecksforobservableneutralityviolationsandthenattempts
to localize them by verifying, for each link sequence, the unsolv-
abilityofthesystemofequationscomposedofpairsofpathsthat
intersectexactlyatthislinksequence.
Validation. Themethodwasvalidatedinanemulatedenvironment,
first in a simpler case with only one shared link, where the shaper
was deployed, and then ina more complexcase with several shared
links. The algorithm proved to produce no false negatives or false
positivesinbothscenarios.
User’spointofview. Itisnotintendedforendusers.
2.5.10 Neubot
A project that differs from the ones thus far described is Neubot60, 60Simone Basso, Antonio Servetti, and
which monitors the access link of users by regularly running dis- Juan Carlos De Martin. The network
neutrality bot architecture: a prelimi-
tributed performance measurements and collects the data on a cen-
nary approach for self-monitoring of
tralized server, where results are made available to researchers for Internet access QoS. In Computers and
Communications(ISCC),2011IEEESym-
lateruse. Thetooldoesnotexplicitlyinferneutralityviolations.
posiumon,pages1131–1136.IEEE,2011
Outlineofthemethod. Thetoolregularlyperformsfourtransmission
tests from end users, in the background. Available tests are HTTP,
BitTorrent, raw TCP and DASH (Dynamic Adaptive HTTP stream-
ing). Every30minutes,Neubotmeasuresupstreamanddownstream
throughput,aswellastheRound-TripTime(RTT)overthefourtests.
chapter 2. context and related work 39
Resultsfromtests. Noglobalanalysiswithrespecttotrafficdifferen-
tiation has been provided to this date. A comparison of throughput
and RTT between access ISPs in the Turin area was published, but
no further analysis was made. An aggregate study of available data
over time and over different ISPs would be an added value to the
project.
User’spointofview. Theuserneedstoinstallthetool,61 whichruns 61http://www.neubot.org/
measurement tests periodically and upon user request. Users can
also view statistics of the quality of their link over time on a dedi-
catedwebpage.
2.5.11 Discussion
The main features of each of the reviewed methodologies are sum-
marizedinTable2.1foramoredirectcomparison.
We saw that most of the methods in the literature that make use
of active measurements rely on the joint replay of an application
and a control flow, of which a shaper targeting that same applica-
tionshouldonlyaffecttheformerandnotthelatter. Thisisthecase
of BT-Test, Glasnost, DiffProbe, Packsen, NetPolice and Differentia-
tionDetector. Thistechniquehasanon-negligibledrawback,sinceit
takes for granted that the modifications applied to the control flow
aresuchthatashaperwillnotaffectitinanyway. Inordertocreatea
controlflow, themostcommonapproachistomodifyportnumbers
or payloads of an application flow. A port number can be modified
so that it belongs to a different application that is supposed to not
beshaped,asinthecaseofNetPolicewithHTTP,oritcanbechosen
within the range of high values not registered for any application,62 62ServiceNameandTransportProtocol
as in Glasnost, DiffProbe and Packsen. Expecting that one specific Port Number Registry. IANA. URL:
www.iana.org/assignments/port-
service, for instance HTTP, is never shaped, might be true in most
numbers
cases,butitisnotarobustassumptionthatcouldapplytoanytype
of network. As for high unassigned port numbers, it might not also
be a safe option, as reported by the authors of Differentiator Detec-
tor, who noticed that the two commercial shapers at their disposal
labeledtrafficwithhighportnumbersaspeer-to-peer. Anotherpos-
sibility is to randomize packet payloads, since Deep Packet Inspec-
tion(DPI)devicesoftenrunregularexpressionpatternsonincoming
packets to match them with known applications. While this would
definitelyavoidDPIclassification,wecannotassumeinadvancethat
portnumberswillnotbetakenintoconsiderationbyshapersinany
network. DifferentiationDetectortriestoovercomethisbyreplaying
the control flow inside a VPN, but we saw in Section 2.1 that VPNs
toomightbethetargetofdifferentiation.
Amongthetoolsintendedforendusers,anothercommonlimitis
thattheydonotscaleeasilytoanyapplicationausermightwantto
test, even though the underlying methodology is not dependent on
a particular application. The application flow is always provided
directly by the tool developers from a set of pre-recorded traces,
40 inference of network neutrality violations with active measurements
whichisthecaseofGlasnost,DiffProbeandPacksen. Glasnostworks
aroundthisproblembyallowingadvanceduserstocreatetheirown
test from traces captured from running applications; it is definitely
an added value, but it is not an easily scalable solution, since a new
customized test has to be created each time a user wants to test a
newapplication. DifferentiationDetector,ontheotherhand,should
inprinciplecreateacustomizedexperimentfromthetrafficoftheap-
plication selected by the user, but in the version released up to this
dateisonlyavailablewithasetofpre-recordedtraces. ShaperProbe
insteadfocusesonlevelshiftsinthroughput,whichforexamplewith
PowerBoostapplytoanyflow,andthereforeitisnotconcernedwith
thetypeoftrafficitreplays.
Furthermore,onlyoneapplicationatatimecanbetestedinallthe
reviewed active methods. This is a direct consequence of detecting
differentiation by comparing an application to a control flow. Even
when multiple application traces are provided, a user still needs to
run the tool separately on each one of them in order to test them
all. This is not the case of NANO, the only passive method so far
proposedintheliterature: itcontinuouslymeasurestheperformance
of all user applications (with the possibility of excluding some for
securityreasons)whiletheyrunontheendhost. Themainlimitation
in NANO is that, in order for it to correctly infer differentiation, it
needs a very large user base, in the order of thousands according to
itsauthors.
It must also be pointed out that, if a differentiation detection tool
becomes popular, a replayed pre-recorded application flow can be
easily white-listed by an ISP and offered regular service, thus effec-
tively circumventing the underlying methodology. An experiment
in which the replayed traffic is not the same same across all users
woulddefinitelyrepresentanadvantage.
In the reviewed methods, the metrics analyzed to detect differen-
tiation are mostly throughput, delays and losses. Indeed, the effect
of a shaper on a flow translates into higher delays, possibly more
losses, and consequently an overall lower throughput. Delays and
lossesalonealreadyfullycapturetheeffectsofashapingdeviceand
can also provide a better insight on the performance of a flow over
time.
With the tool we propose in this thesis, ChkDiff, we try to over-
come the limitations described above for active methods, as will be
described in Chapters 4 and 5. The approach seen in NetPolice
for backbone networks, making use of TTL-limited probes, is the
mostsimilarinspirittotheupstreamexperimentinChkDiff. Before
delving into the details of our methodology, we need to understand
how routers respond to such probes, whether ICMP rate limitation
isprevalentandhowitisimplemented. Wedothisinthenextchap-
ter, where we corroborate the validity of measurements using ICMP
time-exceededfeedbackfromintermediaterouters.
chapter
2.
context
and
related
work
41
Table2.1: Comparisonofexistingmethodsforthedetectionofneutralityviola-
tions.
Tool Active Experiment Measured Met- ApplicationSpecific? DetectionMethod AvailabilityofRe- Currently
or rics sults available
Passive
BT-Test Active. Replays synthetic control TCP RST injec- Yes, it only tests BitTorrent Checks for RST injection and determines Immediately. No, but up-
andapplicationflows,vary- tion. flows. whatfactor(port,payload,direction)trig- graded by
ingportnumbers,direction gereddifferentiation. Glasnost.
(upstream or downstream)
andpayload.
Glasnost Active. Replays synthetic control Throughput. Yes, but extendable. Avail- Checkswhetherthethroughputofthetwo Immediately. Yes.
andapplicationflows,vary- able tests: BitTorrent, flowsdiffersbymorethan50%.
ingportnumbers,direction eMule, Gnutella, Flash,
(upstream or downstream) POP, IMAP4, HTTP trans-
andpayload. fer,SSHtransfer,Usenet.
DiffProbe Active. Replays control and appli- One-way delays, No, but limited to the set Checks for delay discrimination by run- Immediately. Yes.
cationflowsatoriginaland losses. ofsynthetictracesprovided ning Kullback-Leibler test on the delay
sustainedrates. bytheauthors(Skype,Von- distributionofselectedpacketsofthetwo
age). flows. Infersschedulertype(SPorWFQ).
Checksforlossdiscriminationbyrunning
two-proportionz-testonthelossesofthe
twoflowsinselectedinstantsoftheexper-
iment.
ShaperProbe Active. Replays a default trace at Instantaneousre- No, but the replayed trace Checks for a level shift in the received Immediately. Yes.
thepathcapacity. ceived through- does not belong to any ap- throughput. Estimates shaping rate and
put. plication. burstsize.
Packsen Active. Replays control and appli- Inter-arrival No, but limited to the syn- In the first experiment, it runs Mann- Immediately. Notavailable.
cation flows, interleaved. times and band- thetictraceprovidedbythe Whitney U-test on the distributions of
The first replay lasts 20 s, width. authors(BitTorrent). inter-arrivaltimesofthetwoflowstode-
thesecondone100s. tectdifferentiation.Then,itcomparessent
andreceivedbandwidthinthesecondex-
perimenttoinfertheschedulertype(SPor
WFQ).
NANO Passive. It passively measures the Throughput, jit- No. It compares the user performance to a Immediately, pro- Discontinued.
performanceoftheapplica- ter, losses, TCP baseline of all other users with a similar vided that a large
tionsrunbytheuser. RSTinjection. setup, location, and time of the experi- enoughbaselineof
ments,butconnectedtoadifferentISP. users with similar
characteristics is
available.
Continuesonthenextpage.
42
inference
of
network
neutrality
violations
with
active
measurements
Table2.1: Comparisonofexistingmethodsforthedetectionofneutralityviola-
tions.
Tool Active Experiment Measured Met- ApplicationSpecific? DetectionMethod AvailabilityofRe- Currently
or rics sults available
Passive
Differentiator Active. Replays the packet ex- For TCP flows: No, but the current tool It runs the two-sample Kolmogorov- Immediately. Yes.
Detector change of a given applica- RTT’s, through- only provides pre-recorded Smirnov test on the RTT distribution of
tion through (control flow) put, losses. For applicationtraces(YouTube, thetwoflows,aswellasatailoredteston
and out (application flow) UDPflows: jitter, Netflix, Spotify, Skype, theareabetweenthetwoCDFcurves. It
ofaVPN. losses. Viber and Google Hang- comparesmaximumandaveragelossesof
out). thetwoflowsovertworeplays.
NetPolice Active. Itprobesingressandegress Losses. No, but limited to the syn- Todetectcontent-baseddifferentiationon Not intended for Not intended
routers of a given ISP from thetictracesprovidedbythe agiveningress-egressrouterpair, itruns endusers. forendusers.
several hosts with TTL- authors. Available traces: thetwo-sampleKolmogorov-Smirnovtest
limitedpackets. BitTorrent, SMTP, PPLive on the distribution of losses of applica-
and VoIP. HTTP trace is tionandcontrolflows,fromalltheexper-
usedasbaselineforcontent- imentstargetingthatpathsegment. Simi-
based differentiation detec- larly,itrunsthesametesttodetectrouting
tion. differentiationbasedonprevious-hopAS
andnext-hopAS.
Tomography- Active. End-to-end path measure- Works in princi- No. Given the exact topology of a network, Not intended for Not intended
inspired ments across all paths of a ple on any end- itformsasystemofequationswherethe endusers. forendusers.
model givennetwork. to-end measure- sumofunknownlinkpropertiesofagiven
ment. pathequalsthemeasuredend-to-endmet-
ric along that path. If the system is un-
solvable, thenetworkisnotneutral. The
model also tries to identify non-neutral
links.
Neubot Active. Fourtransmissionteststoa Throughput, No, but limited to the syn- It does not directly infer differentiation, Statistics are avail- Yes.
serverevery30minutes. RTT. thetictracesprovidedbythe but it monitors a user’s access link over ableonadedicated
authors: HTTP, BitTorrent, time. webpage.
rawTCPandDASH.
3
ICMP rate limitation
Several tools proposed by the research community rely on feedback
from intermediate routers in order to infer network characteristics.
Traceroute-based path discovery1 is a notable example: by sending 1Van Jacobson. traceroute. URL: ftp:
probes with increasing Time-To-Live (TTL) values until a given des- //ftp.ee.lbl.gov/traceroute.tar.gz
Brice Augustin, Xavier Cuvellier,
tination is reached, traceroute elicits ICMP time-exceeded errors on
Benjamin Orgogozo, Fabien Viger,
intermediate routers and the whole path to a destination is uncov- Timur Friedman, Matthieu Latapy,
Clémence Magnien, and Renata Teix-
ered. By merging paths to many destinations, we can even infer the
eira. Avoiding traceroute anomalies
topologyoftheInternet(e.g. CAIDA’sskitterproject2),orthetopol- with paris traceroute. In Proceedings
ogyofspecificISPnetworks(e.g. Rocketfuel3). ICMPfeedbackfrom of the 6th ACM SIGCOMM conference
onInternetmeasurement,pages153–158.
routers is also used to discover path performance properties such
ACM,2006
as bandwidth and delay. For example, Pathneck4 tries to localize 2K Claffy, Tracie E Monk, and Daniel
and characterize the bottleneck link on a given path, and Pathchar5 McRobb. Internettomography. Nature,
7(11),1999
leverages the relationship between transmission time and delay to
3Neil Spring, Ratul Mahajan, and
inferthebitrateofnetworklinks. DavidWetherall.MeasuringISPtopolo-
gies with rocketfuel. ACM SIG-
The main problem that arises when making use of TTL-limited
COMM Computer Communication Re-
probes is that ICMP feedback from routers is often neither instanta- view,32(4):133–145,2002
neous nor entirely reliable. Indeed, as the generation of ICMP error 4Ningning Hu, Li Li, Zhuoqing Mor-
leyMao,PeterSteenkiste,andJiaWang.
messagestakesplaceintheslowpathofthedataplane,manufactur-
A measurement study of internet bot-
ers and operators impose a low priority on it, in order to minimize tlenecks. In INFOCOM 2005. 24th An-
the overall load on routers. Other internal tasks mostly related to nual Joint Conference of the IEEE Com-
puter and Communications Societies. Pro-
the control plane, like route computation and management opera-
ceedings IEEE, volume 3, pages 1689–
tions, might take precedence over it, especially when resources are 1700.IEEE,2005
shared between slow path and control plane. In addition, in order 5Allen B Downey. Using pathchar to
estimateinternetlinkcharacteristics. In
to further reduce the impact of ICMP message generation, the re-
ACMSIGCOMMComputerCommunica-
sponsiveness to expiring packets is often limited by a hard-wired tionReview, volume 29, pages 241–250.
or configurable maximum rate,6 above which routers simply ignore ACM,1999
6RASteenbergen. Apracticalguideto
anyexpiredpacketsandstaysilent. AlltheselimitationsoftheICMP
(correctly)troubleshootingwithtracer-
generationprocesscanhaverepercussionsonmeasurementtoolsand oute. NorthAmericanNetworkOperators
Group,pages1–49,2009
needtobethoroughlyunderstood.
In this chapter, we try to shed light on the way ICMP rate lim-
itation is implemented on routers and analyze its impact on active
measurements. We proceeded for this purpose with a large-scale
measurement campaign on PlanetLab, where we targeted at various
probingrates850routerslocatedatdifferentdepthsintothenetwork.
Ourcontributionsarethefollowing:
• We identify an on-off pattern in the way ICMP rate limitation is
44 inference of network neutrality violations with active measurements
most often implemented and devise a taxonomy of routers ac-
cordingly.
• Wedeterminethemostpopularconfigurationparametersonrate-
limitedrouters,withrespectalsototheirvendors.
• Wedemonstratethatthemeasuredround-triptimeforTTL-limited
probesisnotcorrelatedwiththechoiceofprobingrate.
Developersofmeasurementtoolswhomighthaveaconcernabout
exceedingratelimitationthresholdscandrawlessonsfromourfind-
ings, as we show that it is relatively easy to observe an answering
pattern and possibly filter it out. On the other hand, when it is es-
sential to have a high answering rate, it might be of use to know in
advancewhichsettingsarethemostcommonacrossvendors.
For the purpose of the upstream experiment in ChkDiff (Chap-
ter 4), we will see that we can indeed use TTL-limited probes to
measure RTTs and we can send packets at relatively high probing
rateswithouthittinganycapacitylimitsofrouters.
We presented the results of this chapter in a paper published at
ICC’15.7
7Riccardo Ravaioli, Guillaume Urvoy-
Keller, and Chadi Barakat. Character-
izingICMPRateLimitationonRouters.
3.1 Overview InIEEEInternationalConferenceonCom-
munications(ICC),2015
Beforedelvingintoanaccuratedescriptionofourmeasurementsetup,
we provide upfront two results: one introduces the effect of ICMP
rate limitation on active probes, the other adds an important insight
onthedelaysobtained.
First, we ask ourselves which fraction of routers is affected by
ICMP rate limitation and at which probing rates this is most evi-
dent. In Figure 3.1, we plot the loss rates that we experienced when
probing a large set of routers with TTL-limited packets at different
sendingratesintherangeof[1,2543]packetspersecond(pps). The
loss rate, which we define as the number of received ICMP time-
exceeded messages over the number of sent probes, is drawn in a
separate bean plot for each probing rate. Bean plots show a scatter
plot of all individual values on top of a kernel density estimate of
the probability density function of the data. Median and mean are
denoted, respectively, by a blue cross and a short green horizontal
line. Two trends are evident in Figure 3.1: (i) the median loss rate
remains very low for probing rates up to 372 packets per second
(pps) and it progressively increases up to 90% with higher probing
rates; (ii) a non-negligible fraction of experiments shows the above
behaviour already for rates higher than 54 pps. But when exactly
doesICMPratelimitationtakeplace? Howisitmostcommonlyim-
plemented and what are the most frequent configurations? We will
addressthesequestionsinSections3.3and3.4.
Besides being concerned about collecting a sufficient number of
responses, we are interested to know whether the delay associated
to them is in any way biased by the sending rate that we choose. In
chapter 3. icmp rate limitation 45
100
80
60
40
20
0
1 19 39 54 75 1041441992723725036789071183155220092543
sending rate (pps)
)%(
etar
ssol
all ttls Figure 3.1: Loss rates for all experi-
ments,arrangedbyprobingrate.
105
104
103
102
101
100
10-1
1 19 39 54 75 104 144 199 272 372 503 678 907 1183155220092543
sending rate (pps)
)sm(
TTR
naem
all ttls Figure3.2: MeanRTTboxplotsforall
experiments,arrangedbyprobingrate.
ordertoverifythis,weplotinFigure3.2themeanRound-TripTime
of each experiment, arranged by probing rate (a full description of
the measurement campaign is presented in Section 3.2). The box
plots are self-explanatory: both the medians and the IQRs8 appear 8IQR is the Inter-Quartile Range, de-
steadyacrossallthetestedprobingrates. Wecanthereforeconclude
finedasthedifferencebetweenthe75th
and the 25th percentiles of the consid-
thatthechoiceofprobingratehasnovisibleinfluenceontheaverage
ered distribution. It corresponds, by
round-triptime. Wecanalsoobservethatafewexperimentsresulted definition,tothelengthoftheboxand
aggregates50%ofthesamples.
inmeanvaluesthatarefarawayfromthecoreofthedistribution(at
1, 10 and up to 60 seconds). These outliers start to appear at 75 pps
and seem to follow a linear increase. Such behavior was limited to
a dozen routers that persistently behave in this way and constitute
an exception as compared to the rest of routers in our dataset. We
furtherdiscussthedelaydistributioninSection3.5.
3.2 Experimental setup
Weconductedourmeasurementcampaignfrom180PlanetLabhosts,
eachofwhichlocatedatadifferentsiteinordertoavoidoverlapping
measurements. Each run lasted 30 seconds and targeted one single
hopalongthepathfromaPlanetLabhosttoafixedIPdestination. A
singleexperimentconsistedinsendingataconstantrateICMPecho-
request probes (similar to what the Ping tool uses) with a forged IP
Time-To-Live (TTL) value, so that the packets would expire on the
router at the desired hop and generate ICMP time-exceeded error
messages. Each sent probe was 28 Bytes in length (20 Bytes for the
IP header and 8 Bytes for the ICMP header), with no extra payload
addedtotheendofthepacket.
46 inference of network neutrality violations with active measurements
Figure 3.3: A typical timeseries for an
on-offrate-limitedrouter.
The choice of ICMP for our probes instead of UDP or TCP fol-
lowedtheresultsbyGunesandSarac,9 whoshowedwithlarge-scale 9Mehmet H Gunes and Kamil Sarac.
measurements that, in comparison, ICMP probes elicit the highest Analyzingrouterresponsivenesstoac-
tive measurement probes. Passive and
number of responses. We decided to target the first 5 hops from
Active Network Measurement, pages 23–
each PlanetLab host in order to include in our dataset both edge 32,2009
and backbone routers. The IP destination address was a public IP
address assigned to a machine in our use. It was kept unchanged
in all probes, thus effectively reaching no more than one router per
hop,exceptforonly3casesinwhichper-packetloadbalancerswere
encountered (a low prevalence in line with what was observed in
large-scale measurements by the authors of Paris Traceroute10). We 10BriceAugustin,TimurFriedman,and
selected 17 exponentially-spaced sending rates between 1 and 4000 Renata Teixeira. Measuring load-
balancedpathsintheinternet. InPro-
packets per seconds, in order to capture the behaviour of routers at ceedingsofthe7thACMSIGCOMMcon-
low and relatively high probing regimes. We note here that the ma- ference on Internet measurement, pages
149–160.ACM,2007
jority of PlanetLab hosts could not fully keep up with the desired
sendingrates,especiallywiththehighestones(>1500pps). Conse-
quently in all figures, for a desired probing rate r, we actually show
the median of all measured sending rates achieved by the Planet-
Lab hosts when instructed to probe at rate r. Every (host,hop,rate)
tuple was tested 3 times. We tried to stress routers as little as pos-
sible between experiments by shuffling the order of sending rates
and by never choosing the same hop in consecutive experiments.
Themeasurementcampaignwasperformedinthefirsttwoweeksof
February 2014 using NEPI,11 a Python-based library for the deploy- 11Alina Quereilhac, Mathieu Lacage,
ment of experiments on network evaluation platforms. Our result- Claudio Freire, Thierry Turletti, and
Walid Dabbous. Nepi: An integration
ing dataset includes over 45000 path measurements and 850 distinct
framework for network experimenta-
routers. Only 53 routers appeared in more than one path, generally tion.InSoftware,Telecommunicationsand
ComputerNetworks(SoftCOM),201119th
athops4or5fromhostsinthesamecountry.
International Conference on, pages 1–5.
IEEE,2011
3.3 Analysis of ICMP rate limitation
Inthedatasetwecollected,twotypesofratelimitationwerepresent.
In the first one, which we call on-off, the router followed a clear an-
sweringpattern. Inthesecondone,whichwewilljustcallrate-limited
(rl), the overall answering rate is constant, but without a visible pat-
tern.
chapter 3. icmp rate limitation 47
Figure 3.4: A typical timeseries for a
genericallyrate-limitedrouter.
3.3.1 On-off
A typical example of an experiment targeting an ICMP rate-limited
on-off router is displayed in the timeseries in Figure 3.3, where we
reportonthe x-axisthetimeatwhichtheprobewassentandonthe
y-axis the corresponding round-trip time if an ICMP time-exceeded
packetwasreceivedforthisprobe. Whenevernoreplywasreceived,
aredcrossappearsonthe x-axisaty=0. Wedefine:
• a burst as any series of consecutive answered probes delimited
by unanswered probes. What we are interested in is the size of a
burst(BS),inpackets.
• an Inter-Burst Time (IBT) as the time interval between the first
probeofaburstandthefirstprobeofthenextburst.
A period coincides therefore with the occurrence of a burst, fol-
lowedbyaseriesofunansweredprobes.
Tolerance to noise. In experiments similar to the one in Figure 3.3,
occasional unanswered probes inside a burst would split that burst
into smaller ones, according to the above definition. If instead we
tolerate the occurrence of a few unanswered probes (that we call a
gap and denote its size by g) and decide to end a burst only when
morethangunansweredprobesappearinarow,weareabletocatch
also those cases of visually identifiable bursts that a more conserva-
tive approach would miss. This allows us to account for potential
losses in the network and occasional interruptions in the generation
of ICMP time-exceeded packets on routers when more urgent tasks,
forexamplerelatedtofastpathoperations,needtotakeplace.
On-offbehaviour. Ifwerepresenteachexperimentasaseriesofburst
sizes (BS’s) and Inter-Burst Times (IBT’s), we can determine the de-
gree of regularity of the observed burstiness by examining the coef-
ficient of variation12 (CoV) of the two metrics, which we call CoV
BS
12Thecoefficientofvariationisdefined
andCoV . Throughacarefulvisualinspectionofmanytimeseries, astheratiobetweenthestandarddevia-
IBT
tionofarandomvariableanditsmean.
we observed that a significant fraction of routers featured a typical
Itmeasuresthevariabilityofadistribu-
on-off pattern when answering to our probes, where an on state is a tion in units of the mean and enables
a direct comparison between distribu-
state in which all or nearly all probes are answered and an off state
tionshavingdifferentmeans.
isastateduringwhichnoanswerisreceived. Thisessentiallycorre-
spondstoavariantofatokenbucketwheretokens,validonlyforthe
48 inference of network neutrality violations with active measurements
durationofoneperiod,aregeneratedperiodicallyandinbursts,with
each token being a ticket to send out an ICMP reply when needed.
Once all tokens expire, the router simply ignores any arising event
requiring the transmission of an ICMP reply and continues to do so
untilthenextperiod,whenanewburstoftokensarrives. Taking
into consideration the presence of noise as previously described, we
define an experiment as on-off when both its CoV and CoV lie
BS IBT
below an empirically chosen threshold of 0.05. That is to say that,
whentheseriesofBS’sandofIBT’scontainvaluesthatdonotdiffer
from one another by more than 5%, the router is flagged as on-off
for this experiment. The threshold of 0.05 appeared to be a good
trade-offthatminimizestheincidenceoffalsepositives.
3.3.2 Generic rate limitation
We will see in Section 3.4 that a fraction of routers in our dataset
are indeed rate-limited when being probed at rates higher than a
router-specific threshold, but the way in which they respond does
notfollowanon-offoranyotherrecognizablepattern. Anexampleis
providedinFigure3.4,whereitisclearthat,eventhoughthenumber
of unanswered probes is approximately the same every second, the
order at which the router decides whether to generate ICMP time-
exceeded replies is not as predictable as in the on-off case. We now
move to a more detailed characterization of routers based on their
responsiveness.
3.4 Characterization of routers
Inourmeasurementcampaign,weobservedthatthevastmajorityof
routers behave according to three responsiveness phases depending
on the rate at which we probe. As we probe at increasingly high
rates,wehave,inorderofappearance:
• fully responsive phase, in which a router replies to the probes it
receives in a timely manner. The loss rate is < 5%, with sporadic
exceptions attributable to the router load, network congestion or
otherminorcauses. [r ,r )istherangeofprobingratesatwhich
min 0
thisphasetakesplace.
Table 3.1: Number of routers in each
category.
Category Description #ofrouters(%)
fr FullyResponsive 257(30.2%)
fr-irr FullyResponsivethenIrregular 51(6.0%)
fr-rl FullyResp. thenGenericallyRateLimited 118(13.9%)
fr-onoff FullyResponsivethenOn-Off 211(24.8%)
fr-onoff-irr FullyResp. thenOn-OffthenIrregular 180(21.2%)
unresponsive Noanswer 33(3.9%)
chapter 3. icmp rate limitation 49
r min r 0 r 1 r max Figure3.5:Responsivenessofroutersto
TTL-limited probes, broken down into
three phases, according to the rate at
fully rate-limited irregular whichwesendprobes.
responsive (on-offorrl)
• rate-limited phase, where ICMP rate limitation is turned on as
a result of a probing rate higher than a router-specific threshold.
If on-off, the router responds at a constant rate and any excess
probes at every time period will be simply discarded. If generi-
callyrate-limited(rl),therouterhasanoverallconstantanswering
rate, but excess probes are dropped without a clear order. Refer
toSection3.3formoredetails. Thisphaseisdefinedin [r ,r ].
0 1
• irregularphase,duringwhichtherouterreactionislesspredictable
than before. The rate at which we probe hits a capacity limit and
the router fails to reply in a regular way. Generally, two things
mighthappen: thelossrategraduallyincreasesto100%,ortheon-
offpatternisnotaspreciselyobservableasbefore,withtheoverall
responsiveness being nonetheless roughly unchanged. This is the
behaviourobservedin (r ,r ].
1 max
The three phases are displayed in Figure 3.5, where we called: r
min
the minimum probing rate at which we hit a router (in our case
1 pps); r the minimum probing rate at which rate limitation ap-
0
pears (with r being necessarily ≥ r , the rate at which a router is
0 rl
configured to reply when in the rate-limited phase); r the highest
1
probing rate at which we notice a well-defined rate limitation; r
max
the maximum rate at which we probe. Our classification
of routers is based on which of the three phases occur in the set of
probingratesin [r , r ] usedinourmeasurementcampaign. As
min max
mentionedinSection3.2,wetestedexponentially-spacedratesinthe
range [1,4000] pps, but most PlanetLab nodes failed to achieve the
highest values. Typically, a router will have a fully-responsive (fr)
phase, followed by a rate-limited phase (if configured), and possi-
bly by an irregular phase (irr). We can now devise the following
taxonomy:
• Rate-limitedrouters. Routerswherearate-limitedphaseoccurred.
Wedefinethreesub-categories:
a) fr-onoff. Routersthatarefullyresponsivein [r , r ) andon-
min 0
off for higher probing rates, that is to say in [r ,r ], with
0 max
r ≥r .
1 max
b) fr-onoff-irr. Routers that are on-off only within a given range
of probing rates, above which they exhibit an irregular be-
haviour. They are fully responsive, as in the previous case, in
[r , r ), but have an on-off phase in [r , r ], with r < r .
min 0 0 1 1 max
Anirregularphaseappearsin (r , r ].
1 max
c) fr-rl. Routers that are fully responsive up to r , after which
0
their answering rate is constant at a value r (with r neces-
rl rl
50 inference of network neutrality violations with active measurements
sarily ≤ r ), without the occurrence of any on-off pattern. We
0
noteherethatnofr-rl-irrrouterswereencountered.
• Nonrate-limitedrouters. Routersinwhichtherate-limitedphase
isnotobserved. Wehavetwocases:
a) fr. Routersthatarefullyresponsivefortheentirerange[r , r ],
min max
inwhichtheyreplytoall(ornearlyall)probes. Thecondition
verified here is that the loss rate in the majority of the exper-
iments is < 5%, a value arbitrarily chosen as an indication of
high responsiveness. This essentially corresponds to the case
inwhichnorate-limitedorirregularphasetookplaceforprob-
ingratesin [r , r ].
min max
b) fr-irr. Routers that are fully responsive (loss rate < 5%) up to
a given probing rate r , after which their loss rate starts to
irr
increase,withoutanyrate-limitingpatternbeingobserved.
• Unresponsive. Routers that are configured to never reply to ex-
piring IP packets. 33 such cases were encountered, amounting to
amere4%ofthetotalnumberofroutersinthedataset.
Interestingly, the six categories appeared quite evenly spread out
withregardtothehop-distancefromthePlanetLabhosts.
Inoursubsequentanalysis,wechosetouseagapvalueof4,since
itmaximizesthenumberofon-offrate-limitedrouterswithoutbeing
sohighastoincludepossiblefalsepositives. Thebreakdownforour
set of 850 routers is detailed in Table 3.1. The vast majority (96%) of
routers are responsive, which is good news, as tools like traceroute
arekeyinstrumentsfornetworktroubleshooting. 30%oftherouters
answer to all probes (up to the maximum probing rate used in our
experiments),whileabout60%featureratelimitationatsomepoint,
eitherwithaclearon-offpattern(46%)orwithout(13.9%).
3.4.1 On-off routers
Foragivenon-offrouter,itson-offbehaviourcanbedescribedbyits
(BS,IBT) pair. Ifwedivide BS by IBT,weobtaintheratelimitation
threshold of an on-off router, or in other words its answering rate
r duringtheon-offphase.
onoff
Distribution of Burst Size. In Figure 3.6(a) we compare the cumu-
lative distribution functions (CDF’s) of burst sizes for fr-onoff and
fr-onoff-irr routers. In the case of the 211 fr-onoff routers (as seen
in Table 3.1), burst sizes span from 1 to 39,000 packets. The most
common values are: 1 (25%), 50 (20%), 500 (15%), 20 (10%), and 250
(10%). Almost all remaining values are multiples of 50, each one of
them not occurring in more than 5% of all cases. As for the 180 fr-
onoff-irr routers, while the set of burst sizes is similar to that of the
fr-onoff, we found a much larger fraction of routers configured at 50
pps. The most frequent values are the following: 50 (70%), 250 (7%)
and 500 (7%). Even though the two CDF’s look fairly different, the
chapter 3. icmp rate limitation 51
1.0
0.8
0.6
0.4
0.2
0.0
100 101 102 103 104 105
burst size (packets)
FDC
1.0
0.8
0.6
0.4
0.2 fr-onoff
fr-onoff-irr
0.0
10-2 10-1 100 101 102
IBT (s)
(a)BurstSizeCDF.
FDC
fr-onoff
fr-onoff-irr
(b)Inter-BurstTimeCDF.
1.0
0.8
0.6
0.4
0.2
0.0
100 101 102 103 104
answering rate (pps)
FDC
fr-onoff
fr-onoff-irr
(c)AnsweringrateCDFbyrouter Figure3.6: CDFsofBS,IBTandoverall
answeringrateforon-offrouters.
set of burst sizes for both router categories includes reasonable val-
ues that a network administrator could have very well picked. We
will see in Section 3.4.3 that this is due to a dominance, among the
fr-onoff-irr, of Juniper routers, which are mostly rate-limited at 50
pps.
Distribution of Inter-Burst Time. Similarly to what we did for the
burst size, we now study the distribution of the Inter-Burst Time,
shown in Figure 3.6(b). The two curves are rather similar, with 1
secondasthemostfrequentvalue. Wealsoobservealargerfraction
of fr-onoff routers at IBT = 0.01s. In the case of fr-onoff routers,
the values span from 4 ms to 30 s with the most common ones be-
ing: 1 s (70%), 0.01 s (10%), 2 s (5%) and 10 s (5%). For fr-onoff-irr
routerstheobservedrangeis(0.01s,60s),wherewehave: 1s(85%),
0.02 s (5%) and 10 s (5%). We can also notice outliers on the right-
hand side of the CDF curves: about a dozen PlanetLab hosts used
in our measurement campaign were heavily loaded at the time and
our 30-second experiments lasted in reality up to 2 minutes (with
the measured probing rates being considerably smaller than the de-
sired ones); surprisingly, this let us find a couple of cases where a
52 inference of network neutrality violations with active measurements
1.0
0.8
0.6
0.4
0.2
0.0
102 103
r (pps)
1
FDC
Figure 3.7: Distribution of r1 for fr-
onoff-irrrouters.
fr-onoff-irr
1.0
0.8
0.6
0.4
0.2
0.0
0 1 2 3 4 5
(1 - loss rate) / (r / sending rate)
onoff
FDC
Figure3.8:Answeringrateoverexpected
answering rate in irr phase for on-off
routers.
very long series of answered probes (see the outliers in the BS CDF)
wasinterruptedevery30or60secondsbyarelativelyshortseriesof
unanswered packets. Our suspicion is that this is most likely due to
an internal process requesting the router resources at those precise
intervals.
Distribution of answering rate r . We consider the resulting an-
onoff
swering rate in the on-off phase by dividing BS over IBT. With
1 second as the most common IBT, there are no surprises in Fig-
ure3.6(c): thevaluesareroughlythesameseeninFigure3.6(a). The
mostcommonvaluesforfr-onoff routersare(inpacketspersecond):
500(28%),50(18%),100(15%),1(15%),20(10%),250(10%),400(9%)
and 250 (5%). In the case of fr-onoff-irr routers, the CDF shows a
dominant value: 50 (75%). The other observed answering rates are:
250 (8%), 500 (8%), 400 (5%) and 10 (5%). We can also notice that
50% of fr-onoff routers have a rate limitation threshold ≤ 100 pps,
whereas60%ofthefr-onoff-irrhavealowerthreshold: 50ppsorless.
Behaviour in (r , r ]. We said that on-off routers of type fr-onoff-
1 max
irr cease to be on-off at probing rates higher than r , which varies
1
from router to router. In Figure 3.7 we show the distribution of r ,
1
chapter 3. icmp rate limitation 53
1.0
0.8
0.6
0.4
0.2
0.0
102 103
answering rate (pps)
FDC
Figure 3.9: Answering rate for generi-
callyrate-limited(rl)routers.
whichrevealsthat76%oftheseroutersmovedtotheirregularphase
already when we probed them at less than 76 pps, with this value
beingr for45%ofthem. Inordertostudywhathappensduringthe
1
irregular phase, we plotted in Figure 3.8 the CDF of the (per-router)
average ratio between the actual answering rate of each experiment
in the irr phase and the answering rate if the router were still in the
on-off phase. In the curve, values close to 0 indicate little (or no)
responsiveness, which is the case for around 10% of these routers.
Values on 1 suggest that, even though the on-off pattern is not as
strictly enforced as before, the overall answering rate is the same as
in the on-off phase. This is true for around 20% of routers in this
category. Values between 0 and 1, where more than 50% of routers
lie, show instead a decreased answering rate. We leave for future
study an explanation for the outliers on the right-hand side of the
curve,whichindicateanunexpectedincreaseinresponsiveness.
3.4.2 Generically rate-limited routers
Genericallyrate-limitedrouterskeeptheansweringrateconstantfor
allprobingratesintherate-limitedphase. InFigure3.9westudythe
distribution of answering rates for these routers. Compared to the
answeringratesseenfortheon-offcategory,herethevaluesaresen-
siblyhigher: almost50%arerate-limitedat2000pps,20%atroughly
1000ppsand15%at100pps.
3.4.3 Vendors
ICMP rate-limitation parameters can be hard-coded into a router or
configurable by its administrator, depending on the router vendor.
For example, according to Cisco documentation,13 Cisco 6500 and 13Cisco. TTL expiry attack identifi-
7600 routers can be configured with the desired answering rate and cation and mitigation. URL: http://
www.cisco.com/web/about/security/
burst size. Steenbergen14 reports that in Cisco GSR routers the lim-
intelligence/ttl-expiry.html
itation rate is hard-coded, which is also the case for Juniper routers, 14RASteenbergen. Apracticalguideto
whoseansweringratesvarydependingonthemodel: 50,250or500 (correctly)troubleshootingwithtracer-
oute. NorthAmericanNetworkOperators
pps. Withthisinmind,wefingerprintedtheroutersinourdatasetin Group,pages1–49,2009
order to determine their most common configurations. For routers
54 inference of network neutrality violations with active measurements
1.0
0.8
0.6
0.4
0.2
0.0
100 101 102 103 104 105
burst size (packets)
FDC
1.0
0.8
0.6
0.4
cisco
juniper 0.2
others
0.0
10-2 10-1 100 101
IBT (s)
(a)BurstSizeCDFbyvendor.
FDC
cisco
juniper
others
(b)Inter-BurstTimeCDFbyvendor.
1.0
0.8
0.6
0.4
0.2
0.0
100 101 102 103 104
answering rate (pps)
FDC
cisco
juniper
others
(c)AnsweringrateCDFbyvendor. Figure 3.10: CDFs of BS, IBT and
answering rate for on-off routers, ar-
rangedbyroutervendor.
at hop 1 we simply looked up their MAC address, whereas for all
other ones we used the technique described by Vanaubel et al.,15 15Yves Vanaubel, Jean-Jacques Pan-
throughwhichwecanidentifyarouterasCisco,Juniperor“others” siot,PascalMérindol,andBenoitDon-
net.Networkfingerprinting:TTL-based
by considering the IP TTL of the response to an ICMP echo-request
router signatures. In Proceedings of the
and the IP TTL of the response to a TTL-limited probe. The distri- 2013 conference on Internet measurement
conference,pages369–376.ACM,2013
bution of vendors seems to follow the known prevalence of Cisco in
the market: 59% of routers were labeled Cisco, 30.5% Juniper and
10.5% others. In Figure 3.11 we see how the different categories
are distributed for each vendor: Cisco has a large fully-responsive
component(50.8%),almostall(95.8%)Juniperroutersareon-offand
those marked as “others” are also mainly on-off (74.1%). For on-off
routers, we show in Figure 3.10 the distribution of BS, IBT and an-
swering rate arranged by vendor. A few considerations: (i) Cisco
routers are mostly configured at 20, 100 or 500 pps; (ii) IBT is gen-
erallyalways1second,exceptforCiscorouters,whichdisplaymore
values(probablyasaconsequenceofbeingconfigurableinsoftware)
and(iii)mostJuniperroutersarerate-limitedat50pps,thedominant
value we saw previously for fr-onoff-irr routers. It is no coincidence,
asthesearemostlyJuniper.
chapter 3. icmp rate limitation 55
cisco fr
59.0% 50.9%
10.5% fr-irr 6.7%
others
19.8%
18.8% fr-rl
30.5% 3.8%
fr-onoff
juniper fr-onoff-irr
(a)Distributionofvendors. (b)DistributionofroutertypesforCiscorouters.
fr-onoff
fr-irr
31.3%
7.4%
fr
fr-irr 13.0%
1.8% fr
2.4%
5.6% fr-rl
fr-onoff 68.4%
5.6%
fr-onoff-irr
64.5%
fr-onoff-irr
(c)DistributionofroutertypesforJuniperrouters. (d)Distributionofroutertypesfor“other”routers.
Figure 3.11: Distribution of vendors
3.4.4 Validation by controlled experiments and percentage of routers in each cat-
egoryforCisco,Juniperand“others”.
We resorted to controlled experiments in order to verify that (i) we
infer the correct on-off parameters, and (ii) PlanetLab hosts do not
add any bias . We arbitrarily chose 60 machines from the Planet-
Lab testbed, each one of which located at a different site, and in-
structedthemtoprobe(insequence)amachineinourcontrol,where
we emulated the on-off behaviour of routers with the use of Linux
iptables.16 For simplicity, we did not make the ICMP echo-request
probes expire on this machine, but we directly replied to them with
16http://www.netfilter.org/
ICMP echo-reply messages. Similarly to our large-scale measure- projects/iptables
ments, each single experiment lasted 30 seconds, during which a
PlanetLab host probed our machine at a constant rate. We picked
12 exponentially-spaced probing rates in the interval [1, 1000] pps
and tested each rate twice. On the machine in our control, we em-
ulated an on-off router by using for a first round of measurements
a rate limitation of 20 pps (BS = 20 packets, IBT = 1 second) and
for a second round a value of 50 pps (BS = 50 packets, IBT = 1
second). In Figure 3.12 we show the CDF of the measured average
Burst Size (BS) and Inter-Burst Time (IBT). While for the IBT the
correctvalueispreciselymeasured,anerrorofupto2unitsisoften
encountered in the estimation of the BS parameter. After a manual
56 inference of network neutrality violations with active measurements
1.0
0.8
0.6
0.4
0.2
0.0
20 25 30 35 40 45 50 55
average BS (packets)
FDC
1.0
0.8
0.6
0.4
20 pps 0.2
50 pps
0.0
0.97 0.98 0.99 1.00 1.01 1.02 1.03 1.04
average IBT (s)
(a)BurstSizeCDF.
FDC
20 pps
50 pps
(b)Inter-BurstTimeCDF.
Figure3.12: Verificationofinferredpa-
inspectionofseveralexperiments, wecanonlyconcludethatitisan rameters on a controlled rate-limited
implementation-dependentissue: the BSparameterissimplynotal- machine.
ways as rigorously enforced as the IBT in iptables. Nonetheless, the
correct inference of the above parameters lets us exclude the exis-
tence of any bias coming from the PlanetLab hosts or the networks
wheretheyreside.
3.5 Delay
InSection3.1weobservedthattherateatwhichwesendprobesdoes
notinfluencetheresultinground-triptime,whosemeanvalueissta-
bleacrossallprobingratesunderconsideration. Weaddherefurther
evidencetosupportourclaimbyanalyzingtheper-experimentRTT
variability. For each experiment, we took the coefficient of varia-
tion (CoV) of all its round-trip times and plotted in Figure 3.13 all
CoVs arranged by probing rate and regardless of the hop distance.
Apartfromthecaseof1packetpersecond,forwhichtheCoVsrefer
to samples of only 30 RTT’s (as each experiment lasts 30 seconds),
where apparently less variability occurs, for all other probing rates
theredoesnotseemtobeanynoticeabledifferenceacrossthem. The
interquartile range appears stable, with a very slight decrease of the
medianforhigherrates. Therefore,wecanapparentlyconcludethat
thesendingratehasnodirectimpactontheround-triptimeofTTL-
limitedprobes: itsmeanisnotaltered,andneitherisitsvariability.
3.6 Related Work
To the best of our knowledge, our work is the first of its kind to
attempt to precisely characterize ICMP rate-limitation on routers at
a large scale. Gunes and Sarac17 analyzed publicly available tracer- 17Mehmet H Gunes and Kamil Sarac.
outedatacollectedbetween1999and2008,andnoticedthatinrecent Analyzingrouterresponsivenesstoac-
tive measurement probes. Passive and
years network operators have configured routers to become increas-
Active Network Measurement, pages 23–
inglylesscooperativetoactiveprobing. Then,theyconductedlarge- 32,2009
chapter 3. icmp rate limitation 57
scale measurements with direct (i.e. destined to a router) and indi-
rect(i.e. traceroute-like)probesandcomparedtheresponsivenessof
routers according to the chosen protocol: ICMP, TCP or UDP. They
concluded that ICMP probes elicit the highest number of responses
forbothdirectandindirectprobes,followedbyTCPandUDPinthe
case of direct probes, and by UDP and TCP for indirect ones. It is
also based on this finding that we decided to use ICMP probes in
our measurements. Govindan and Paxson18 proposed a technique 18Ramesh Govindan and Vern Paxson.
to estimate the time taken by a router to generate an ICMP time- EstimatingrouterICMPgenerationde-
lays. In Passive & Active Measurement
exceededmessage: givenarouter Rlocatedonthepathfromhost A
(PAM),2002
tohostB,theycomparedtheone-waydelayfrom AtoBexperienced
by direct probes and by spoofed TTL-limited probes that expire on
R but whose ICMP error message is sent to B. They found out that
for most routers the slow path time is less than 0.5 ms. Malone and
Luckie19 tackled an issue tightly related to the use of TTL-limited 19David Malone and Matthew Luckie.
probes: thematchingbetweenprobesandICMPtime-exceededmes- Analysis of ICMP quotations. Passive
and Active Network Measurement, pages
sages, based on the quoted contents of the expired probes inside
228–232,2007
the returned ICMP message. They detailed a variety of packet field
modifications applied by routers and middleboxes that might result
in discrepancies between the quoted packet and the original probe.
Incidentally, they also pointed out that in their measurements there
were a few tens of probes that experienced incredibly high RTT’s,
spanning from 10 to 300 seconds. We encountered exactly the same
kind of outliers when analyzing our dataset (as can be seen in Fig-
ure 3.2). Layouni et al.,20 who studied in depth the causes behind 20FarahLayouni,BriceAugustin,Timur
undisclosedroutersintraceroute,alsoreportedveryhighround-trip Friedman,andRenataTeixeira.Origine
desétoilesdanstraceroute. InColloque
timesandattributedthemtohighactivityinthecontrolplane,which
Francophonesurl’IngénieriedesProtocoles
at least in our dataset seems more likely to be caused by our own (CFIP),2008
probingratherthanbyotherparallelprocesses.
3.7 Summary
Although the use of ICMP rate limitation on routers in the Inter-
net has been known for a long time, no previous study had tack-
led the problem of precisely characterizing how this function is im-
plemented in the wild. We analyzed the RTT distribution obtained
when targeting routers with TTL-limited probes and found that it
is apparently uncorrelated with the chosen probing rate. We intro-
12
10
8
6
4
2
0
1 19 39 54 75 104 144 199 272 372 503 678 907 1183155220092543
sending rate (pps)
VoC
TTR
Figure3.13: RTTCoVboxplotsforall
experiments,arrangedbyprobingrate.
58 inference of network neutrality violations with active measurements
ducedaclassificationofroutersbasedontheirresponsivenessacross
different probing rates and observed that rate limitation most often
consists of an on-off process, where the router alternates between a
stateinwhichitanswerstoallprobesandastateduringwhichitre-
mainssilent. Weanalyzedindetailstheconfigurationparametersof
on-off routers: burst size, for which we detected a variety of values,
and inter-burst time, generally equal to 1s. A future direction for
thisworkcouldextendourmeasurementstogodeeperintothecore
of the Internet and group routers with respect to the ISP that man-
ages them. This will allow us, for example, to check if ISPs apply a
consistentconfigurationacrosstheirrouters.
Now that we have shown that round-trip times obtained with
TTL-limited packets can be used for delay measurements, we can
introduce in the next chapter the upstream experiment of our tool,
ChkDiff, which relies on this type of feedback from intermediate
routerstoinferdifferentiationandlocalizeshapers.
4
ChkDiff: the upstream experiment
TheneutralityoftheInternethasbeenahottopiceversince,around
adecadeago,bandwidth-hungryapplications(e.g.,peer-to-peer,video,
media streaming) started to gain success among users and a num-
ber of ISPs took measures to counter possible detrimental effects on
the connectivity they provided. Arbitrary decisions, as for exam-
ple blocking of BitTorrent traffic in the upstream direction1 by an 1Dslreports: comcast is using sand-
operator in the U.S., have since then been reported. As we saw in vine to manage p2p connections.
URL: http://www.dslreports.com/
Chapter 2, other examples include: throttling ofYouTube in France2
forum/r18323368-Comcast-is-
and Germany3 during evening hours, when link utilization reaches using-Sandvine-to-manage-P2P-
Connections.
itspeak;degradedperformanceoveraVPNusingOpenVPNdefault
2Respect my net. URL: http://
port4 inthe U.S.; mostrecently, evidentdecrease inperformancefor respectmynet.eu/view/205
Netflixtrafficinearly2014bytwoU.S.operators.5 3Respect my net. URL: http://
respectmynet.eu/view/196
Butsincetrafficdifferentiationisrarelyrevealedbyofficialsources
4IjustdoubledmyPIAVPNthrough-
and certainly does not appear in Service Level Agreements (SLA’s), put that I am getting on my router by
it becomes of utmost importance to be able to detect it from within switching from UDP:1194 to TCP:443.
URL: http://www.reddit.com/r/VPN/
the network. A number of tools for the detection of traffic differen-
comments/1xkbca/i_just_doubled_my_
tiation have thus emerged in the literature in the past few years (we pia_vpn_throughput_that_i_am
reviewed them in Chapter 2). The method we propose here differs 5Netflix performance on Veri-
zon and Comcast has been
from existing work in its attempt to be independent both from the
dropping for months, 2013.
shapingtechniquesinusebyISPsatlayer3(IP)oftheprotocolstack URL: http://arstechnica.com/
information-technology/2014/02/
and from the user applications that might be targeted. The idea is
netflix-performance-on-verizon-
that a shaper whose goal is to degrade the performance of selected and-comcast-has-been-dropping-
traffic might do so according to a variety of packet scheduling and for-months
buffer management policies, but it will typically result on the user
side in larger delays and possibly more losses. Consequently, if we
compare the set of delays of a flow to that of the rest of the traffic,
and we proceed analogously for losses, we should be able to infer
whether any shaping took place. In order for this to be valid for
whatever application the user is running, we reuse her own traf-
fic and replay it with minimal changes so that it targets the routers
at the first few hops from her. If any shaper is located in prox-
imity to one (or more) of these routers, packets going through it
will have degraded performance at that hop and at all subsequent
ones, thus allowing us to also pinpoint their relative position. We
implemented this technique for upstream traffic in a tool we called
ChkDiff,6 through which we can detect the presence and identify 6The code is available on a
the location of shapers, by using the ICMP feedback provided by dedicated web page: http:
//chkdiff.gforge.inria.fr/
60 inference of network neutrality violations with active measurements
routers. We focus in this chapter on the validation of ChkDiff in the
upstream direction: we stress the tool under different shaping sce-
nariosandassessitsresilienceagainstsourcesoferrorsuchastraffic
variationandICMPratelimitationonrouters.
Thechapterisorganizedasfollows: inSection4.1wepresentthe
functioning of our method in details, along with a discussion of all
thetechnicaladjustmentsneededforthetooltowork;inSections4.2
and 4.3 we validate ChkDiff in respectively a controlled neutral and
non-neutralenvironmentandshowthatitisabletosuccessfullyde-
tectshapingevenwhenalargefractionofthetrafficisdifferentiated;
we compare our method to existing work in Section 4.4 and give
concludingremarksinSection4.5.
The results of this chapter were presented in a paper published
at ITC 27.7 An early draft of this work was presented at CoNEXT 7Riccardo Ravaioli, Guillaume Urvoy-
2012.8 Keller, and Chadi Barakat. Towards a
generalsolutionfordetectingtrafficdif-
ferentiation at the internet access. In
4.1 Design of the tool
TeletrafficCongress(ITC27),201527thIn-
ternational,pages1–9.IEEE,2015
8RiccardoRavaioli,ChadiBarakat,and
The strength of ChkDiff lies on its ability to not depend on the kind Guillaume Urvoy-Keller. Chkdiff:
of shaping technique affecting delays and losses in use by ISPs and checking traffic differentiation at In-
ternet access. In Proceedings of the
on the applications (or rather, traffic flows) that might be targeted.
2012ACMconferenceonCoNEXTstudent
We achieve this by implementing the following design ideas in the workshop,pages57–58.ACM,2012
coreofourtool:
• Useofrealusertraffic. Weconductallexperimentswithpreviously
dumped user traffic, so that the results yielded by our tool will
refertotheexactsetofapplicationsrunbytheuser.
• Traceisleft(almost)intact. This ensures that any shapers traversed
by our trace will have the same behaviour they would have if the
packets had been generated by their respective applications. As
we will see in the following subsections, the only modifications
appliedtopacketsareintheTTLfield,inordertohittherouter(s)
at the desired hop, and in the application payload, in which we
enforcethesamesizeonallpacketssoastoavoiddifferenttrans-
missiontimes.
• Baseline for comparison is the entire traffic. By the definition of net-
work neutrality, a flow that is not differentiated will be treated in
the same way as the rest of the (non-differentiated) traffic by any
given router. On the other hand, a flow that is differentiated by
a shaper will typically display higher delays or losses, depend-
ingontheschedulingandbuffermanagementtechniquesinuse.9
9More specifically, a shaper will still
When compared to the delays and losses of the rest of the trace, be able to classify flows as if they
werecomingfromtheirrespectiveorig-
thisflowwillstandout. Ourstatisticalanalysisisbasedonthat.
inal applications, when it does so by
inspecting IP, transport-layer header
Wewillshowinthevalidationsectionthatweareabletosuccess- fields or application payloads. If it
fully detect shaping when over half of the traffic is differentiated. implements stateful TCP flow analy-
sis, our replayed trace would proba-
TheexecutionofChkDiffissummarizedinAlgorithm1.
bly bypass it. After this flow identi-
A traffic trace is captured during a user’s regular Internet activ- fication phase, a shaper will apply a
differentiationtechniquetotheselected
ity; it is then processed and arranged into flows. For each hop h
flows. ChkDiff is able to detect tech-
niques resulting in higher delays and
losses;techniquesthatinterferedirectly
withthetransportorapplicationlayer,
such as TCP RST injection and HTTP
redirections,willnotbedetected.
chapter 4. chkdiff: the upstream experiment 61
Algorithm1ChkDiffexecution
1: Captureusertraffic
2: foreachhop h ∈ {1,2...k} do
3: foreachrunr ∈ {1,2,3} do
4: shuffletrace
5: replaytracewith TTL ←h
6: collectICMPtime-exceededreplies
7: endfor
8: detectshapedflowsathop h
9: endfor
10: aggregateresultsandlocateshaper(s),ifany
we intend to test, we shuffle the trace so as to minimize any bias in
the network conditions that our flows will experience: we keep the
ordering of packets within each flow and modify the global packet
ordering to be resilient to side traffic. We set the TTL field of the IP
header of each packet to h and we replay the trace. Routers at hop
h,ifresponsive,willreplywithICMPtime-exceedederrormessages,
through which we compute single packet Round-Trip Times (RTT’s)
tohoph. Anyshaperlocatedbetweentheuserandhophmusthave
affected packets belonging to the flows it is configured to differen-
tiate, before the ICMP error messages were elicited. We repeat this
operation 3 times for the same hop in order to filter out false pos-
itives and we claim that a flow has been shaped when it has been
rejected in our statistical analysis across all three runs. Once all the
first k hopshavebeentested,wecomparetheresultsandattemptto
localizetheshapers.
Intherestofthissection,wewilldescribeeachoftheabovesteps
indetail.
4.1.1 Traffic trace
The first action taken by ChkDiff is to dump outgoing user traffic
whiletheuserrunsherusualnetworkapplications. Thisisthetrace
that will be replayed from the end user host towards routers at the
hopsnearbyinthefollowingsteps. Sincewefocusinthischapteron
the upstream direction, we expect the user to execute applications
generating some non-trivial outgoing traffic that is not limited to
HTTP requests or TCP ACK’s: for example media upload, VoIP, file
sharingandinstantmessaging.
4.1.2 Flows and trace preparation
Trace classification into flows. The packets in the dumped trace are
arranged into 5-tuple flows, that is to say according to source and
destination IP addresses, source and destination port numbers and
transportprotocol.
62 inference of network neutrality violations with active measurements
Fixed-size packets. Next, we need to prepare the trace we have to
replay. Packets of different size, if sent along the same path to the
same destination, will inevitably have different transmission times.
As we will see in Section 4.2, this is a non-negligible source of error
if, as it is in our case, we make the assumption that the delays of all
packets going along the same path should be comparable. This is
especially true if we measure delays to the closest hops, where the
delay variability could be low enough to be comparable to or even
smallerthanthedifferenceintransmissiontimesbetweensmalland
large packets. In order to overcome this, we force every packet of
our trace to be of the same size S (in Bytes), with S being the size
of the largest packet in our trace, by adding random padding at the
end of packets with shorter payloads. Through this, we preserve all
original payloads so that packets can still be intercepted by shapers
implementingDeepPacketInspection(DPI).
Shuffling packets. Before replaying our trace, an additional step is
required. Since our analysis will be in terms of flows, we have to
ensurethattheyallseethesamenetworkconditionswhilebeingin-
jected into the network. It is therefore necessary to shuffle packets
so that they exhibit such property. We assign a weight to each flow
in our traffic according to its original size in packets and normalize
itbythesumofallflowssizes, suchthatallweightssumto1. Fora
tracewith f flows,anyflowi withsizes,innumberofpackets,will
i
f
have weight p = s /∑ s . A queue is thus created for each flow,
i i k=1 k
where the per-flow packet order is maintained, since it might reveal
useful information to a shaper for flow identification. We now pick
packetsrandomlyfromeachqueueaccordingtotheflowweightand
put them aside, ready to be replayed. Whenever a queue becomes
empty, its weight is set to 0 and weights of all other flows are up-
datedaccordingly,sothattheyalwayssumto1. Bypoppingpackets
from each queue in the above fashion, we obtain for every flow an
ordered sequence of 0’s and 1’s indicating whether a packet in the
resulting shuffled trace came from that flow or not. Given a flow i,
such sequence of 0’s and 1’s can be seen as a Bernoulli process with
a probability equal to the weight of flow i, let us say p. Now, if we
i
considerthespacing(orinter-packettime)W betweenanytwocon-
i
secutive packets from flow i, we can see that it follows a geometric
distribution with parameter p: P(W = w) = (1− p )w−1p. The
i i i i
geometric distribution being the discrete version of an exponential
distribution,packetsofflowiseetherealnetworkconditionsaccord-
ing to the PASTA property (Poisson Arrivals See Time Averages).10 10Ronald W Wolff. Poisson arrivals
Asthispropertyappliestoallflows,itenablesustoreachourinitial see time averages. OperationsResearch,
30(2):223–231,1982
goal: lettingallflowsobservethesamenetworkconditions,provided
thatthenetworkoffersastationaryservice.
Furthermore,shufflingisparticularlyusefulwhenhavingtocoun-
teractsidetrafficandICMPratelimitation,aswewillseeshortly.
chapter 4. chkdiff: the upstream experiment 63
4.1.3 Replay
ICMPratelimitation. InChapter3westudiedtheresponsivenessof
routers to TTL-limited probes. Through a large measurement cam-
paign, we examined possible bias in the Round-Trip Times of these
probes and how ICMP rate-limitation is implemented on routers.
Wedemonstratedthattheredidnotappeartobeanycorrelationbe-
tweenasloworhighprobingrate(intherange[1,4000]packetsper
second)andtheresultingRound-TripTimes. Inotherwords,evenat
high rates, we were not hitting any capacity limits that might have
slowed down the generation of ICMP messages and contributed to
the total packet delay. This is good news, since it tells us that the
choiceofprobingratedoesnotmarthedelaysweobtain. Therewill
definitely be a delay component due to the generation of the ICMP
errormessage(estimatedtobeintheorderofthesubmillisecond),11
11Ramesh Govindan and Vern Paxson.
since it takes place in the router slow path, which is usually im- EstimatingrouterICMPgenerationde-
lays. In Passive & Active Measurement
plemented in software instead of hardware and does not have high
(PAM),2002
prioritycomparedtoother routeroperations. Butthisdelay compo-
nentwillhaveroughlythesameweightinallRTT’stowardthesame
routerandthereforewillnotconstituteasourceoferror.
WhenusingTTL-limitedprobesasinourcase,wemustalsomake
sure that we obtain a sufficient number of replies, since it is a fairly
widespread practice for manufacturers and network administrators
to limit at a fixed maximum rate the responsiveness of routers to
these expiring probes. We tested 850 routers from PlanetLab hosts
up to hop 5 and demonstrated that ICMP rate limitation is imple-
mented as an on-off process with typical values in [20,500] packets
per second (pps). In light of this, the shuffling technique presented
above has the undoubted advantage that unanswered probes would
be spread fairly evenly across flows, since flow packets themselves
are spread evenly across the trace. A non-shuffled trace replayed
to an ICMP rate-limiting router would instead incur more variable
losses among flows, which would inevitably impair any loss analy-
sis. WewilldiscusstherobustnessofourtooltoICMPratelimitation
inSection4.3.
Testing the first k hops. In order to locate the position of a shaper,
weneedtoreplaytheshuffledtraceasmanytimesasthenumberof
hopswewanttotest,byincreasingtheIPTTLofallpacketsatevery
experiment. For the choice of k, a value of 3 or 4 should suit most
cases and provide a large enough picture of what happens at the
user’sInternetaccess,includingISProutersandthoserightafterthe
ISP boundaries. The user trace being made of flows with different
IP destination addresses, testing routers that are further away is of
increasing complexity due to a reduction in terms of samples per
routeraswemoveawayfromtheuser.
64 inference of network neutrality violations with active measurements
Figure4.1:Anexamplewithshapersat
differenthopsaffectingselectedflows.
hop1 hop2 hop3 hop4 shapers? Figure4.2: ExpectedoutputofChkDiff
forthenetworktopologyinFigure4.1.
flow0 ❉ ✖ ✖ ✖ hop2
flow1 ❉ ❉ ❉ ✖ hop4
flow2 ❉ ❉ unresp ❉ none
flow3 ❉ ❉ unresp ✖ hops3,4
flow4 ❉ ❉ unresp unresp notuntilhop2
4.1.4 Results analysis
We focus our analysis on the study of Round-Trip Times and losses.
In both cases, the approach is similar: we consider large flows only,
that is those with at least 20 answered packets (a typical minimum
samplesizeinstatisticalanalysis),andweanalyzetheseflowsoneat
a time, comparing them against all the rest of the traffic as a whole
(largeandsmallflowsindifferently). Werejectaflowifitfailsatleast
one between the delay and the loss analysis in all three experiments
againstthesamerouter.
Delays. We compare the distribution of delays of a flow to the de-
lay distribution of the rest of the trace using a statistical test. Our
null hypothesis is that, in an environment without differentiation,
if we sample the total set of delays obtained, they will all appear
to be drawn from the same distribution as all the other delays of
the trace. We conduct our analysis by applying two-sample one-
sidedKolmogorov-Smirnovtest,whichhasthebenefitofbeingnon-
parametric, in that it does not make assumptions on the underlying
distribution of the data it is checking. The test takes as statistic the
maximum vertical deviation between the Cumulative Distribution
Functions (CDF’s) of two samples. We chose the one-sided version
of this test because, while the two-sided Kolmogorov-Smirnov test
looks for the maximum vertical deviation between two curves with-
out including in its result whether this vertical distance was due to
the first curve being above the second one or the other way around,
the one-sided version looks for this deviation in one given direc-
tion. Applied to our scenario, we can test whether a flow experi-
encedworse(i.e. larger)delaysthantherestofthetracebychecking
whether its CDF lies below the CDF of its baseline, and to which
extent.
chapter 4. chkdiff: the upstream experiment 65
Losses. Inordertocheckifthelossrateofaflowdifferssignificantly
from that of the rest of the trace, we proceed by using an argument
inspired from the binomial distribution. If we want to examine the
losses (i.e. the number of unanswered packets) experienced by flow
i, we let p be the loss rate of the rest of the traffic as a whole, and
s be the original number of packets of flow i. If the loss events of
i
flow i were not caused by a shaper, its number of losses l can be
i
modeled as a binomial random variable of parameters B(s, p). To
i
test whether this holds true, we can approximate this binomial as a
normalrandomvariableofparameters N(s p, s p(1−p))andverify
i i
that the loss events l lie within α standard deviations of the normal
i
mean. With α being a function of the significance level we want to
achieve,wecheckthat ps−αpp(1−p)s < l < ps +αpp(1−p)s.
i i i i
Therightsideofthislastconditionistheoneweareinterestedin,as
itindicates-whenitdoesnothold-thattheflowexperiencedmore
lossesthanitshouldhave,anditiswhatwecheckinouranalysis.
Combinedanalysis. Sinceashapermightcauselongerdelaysorextra
losses to affected flows, we combine the delay and the loss analyses
describedaboveandrejectaflowwhenitfailsatleastoneofthem.
Repetition of experiments. Statistical tests are operated at a certain
confidence level, which in our tool we set to 99%. Due to the high
number of flows in a user trace, we are bound to have a number of
false positives, whatever action we take. To work around this issue,
weadoptasimplestrategy. Werepeatanexperimentthreetimes(at
thesameconstantprobingrate)torouter(s)atthesamehop-distance
and claim that a flow has been shaped only when it was rejected in
allthreeruns.
4.1.5 Results Aggregation
After collecting traces and analyzing delays and losses for the first
k hops, we need to aggregate results in order to attempt to localize
shapers, if ever a flow was rejected in any of those hops. A shaper
positioned right before hop h, with h ∈ {1,2, ...k}, will cause tar-
geted flows to fail the delay or loss analysis (or both) on all hops
≥ h. WhenChkDiffdetectsthis,itdeclarestheflowasbeingshaped
on the hop segment between h and the previous responsive router.
We show an example with routers up to hop 4 in Figure 4.1. We
assume that there is a number of non-differentiated flows from the
user trace passing through each router besides the four shown in
the figure, and that they contribute to the baseline for the statistical
analysis. InFigure4.2weprovidetheexpectedoutputfromChkDiff
based on this scenario. A shaper for flow 0 is deployed right before
the router at hop 2: this means that flow 0 will pass the analysis at
hop1,butwillnotatallsuccessivehops. Flow1isasimilarcase,but
attheedgeofthetestedhops. Athop3anunresponsiverouter,that
is to say a router that is configured not to reply to expiring packets,
66 inference of network neutrality violations with active measurements
generates a gap in our assessment, which might be compensated by
theresultsatthenexthop. Ifatthenexthopaflow(flow2)continues
topassthetest,wecansafelyclaimthatitwasnotshapedalongthe
whole path under consideration. If instead the flow fails the test, as
weshowforflow3inourexample,wecanonlysaythatathop3and
4itencounteredashaper,withoutbeingmorespecific. Finally,ifthe
next hop is also unresponsive, for a flow like flow 4, our conclusion
issimplythatnoshapersweredetecteduptothelasthopwherethe
flowpassedtheanalysis.
4.2 Validation in a neutral scenario
Before validating ChkDiff in the presence of traffic differentiation, it
isimportanttojustifysomemeasureswetakewhenreplayingauser
trace: forcing the same size in all packets and aggregating results
across 3 experiments. The packet trace we used here and in
Section4.3wascapturedinatime-windowof3minutesofatypical
Internet session, in which we performed picture uploading on a so-
cialnetwork,browsingonanewssite,andsentafewchatmessages.
Thetraceismadeof6733packets,arrangedinto275flows,ofwhich
61arelarge(i.e. theyhavemorethan20packets)andcomprise76.8%
ofthetotalamountofpackets. Theexactdistributionofflowsizesis
showninFigure4.3.
1.0
0.8
0.6
0.4
0.2
0.0
100 101 102 103
flow size (packets)
FDC
Figure4.3:Distributionofflowsizes,in
numberofpackets,forthepackettrace
usedforvalidation.
1.0
0.8
0.6
0.4
0.2
0.0
0 1 2 3 4 5
no. of false positives
FDC
KS
original Figure 4.4: Incidence of false positives
fixed size inthedelayanalysiswhenthereplayed
trace contains unaltered original pack-
ets,andwhenitcontainspacketsofthe
samesize.Resultsareover1run.
chapter 4. chkdiff: the upstream experiment 67
Figure4.5:Middleboxconfiguration.
shapingpipe
100Mbit/s
pipe
compensatingpipe
We claimed in Section 4.1.2 that, by fixing the packet size to a
constant value for all packets in a trace, we were able to remove a
considerable fraction of errors in the delay analysis. We now show
the incidence of false positives when packets are the original size
and when they are padded to a constant value. For each of the
two options, we ran ChkDiff 100 times in a controlled setup with
no differentiation towards a router under our control at hop 2. In
Figure 4.4 we compare the CDFs of the number of false positives of
the delay analysis for each experiment.12 The improvement is evi- 12Wedonotconsiderthelossanalysis,
dent: we remove all errors in 70% of experiments and are left with since in our controlled setup the trace
didnotexperienceanylosses.
30%ofexperimentsshowingmostly1falsepositive.
The next step is to aggregate the results of multiple runs, as de-
scribed in Section 4.1.4 and see if these errors disappear. We ran
ChkDiff100timesandobservedindeedthatnofalsepositivesemerged
when considering just two runs. In order to have a safe margin of
error,weusebydefaultthreerunsinChkDiff.
4.3 Validation in a non-neutral scenario
We tested how the tool copes with different shaping and network
settings in a controlled experimental setup. We focused on two sce-
narios: Scenario 1, in which we throttle the bandwidth of selected
flows, and Scenario 2, where we apply uniform packet drops. In
our setup, a user machine is connected through cable to a middle-
box, which operates both as a gateway and a shaper, and which is,
in turn, connected to a Cisco router under our control, where our
probes expire. In the middlebox, we deployed a shaper with Dum-
mynet, a popular and versatile network emulation tool.13 The con- 13Marta Carbone and Luigi Rizzo.
figuration we used is depicted in Figure 4.5: incoming packets are Dummynetrevisited. SIGCOMMCom-
put. Commun. Rev., 40(2):12–20, April
directed to either the upper or lower pipe on the left side, depend-
2010
ingonwhethertheybelongrespectivelytotheflowstoshapeornot.
The upper pipe is traversed by all flows that we intend to shape;
in Scenario 1 it has its own bandwidth bw and queue size, and in
Scenario 2 it induces uniform losses at rate lr. The lower pipe com-
pensates for the transmission delay produced by the upper pipe in
Scenario 1: it adds this constant delay component to the packets of
all non-differentiated flows, so that only the queueing delay in the
upperpipeconstitutesthediscriminatingfactorbetweenshapedand
non-shaped packets. In scenario 2, it produces no effect. Finally, all
packets meet at the pipe on the right-hand side, which emulates a
100 Mbit/s link. In Scenario 2 this pipe induces a uniform loss rate
lr to all flows. All pipes are configured with a buffer size of 100
all
68 inference of network neutrality violations with active measurements
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
k
wb
100
80
60
40
20
0
noisicerp P/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(a)Precisionofthecombinedanalysis
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
Figure 4.6: Precision and recall of the
combined analysis, for the case of one
shapedflowinScenario1. Ineachcir-
cle, we report in the upper-left quar-
tertheresultofonlythedelayanalysis,
intheupper-rightquartertheresultof
onlythelossanalysis,andinthelower
halftheresultofthecombinedanalysis,
which rejects a flow if either the delay
orthelossanalysisfails.
(b) Recallofthecombinedanalysis
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(a) Recallwhenfr=20%
rl
depahs
fr=40%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(b)Recallwhenfr=40%
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=60%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(c)Recallwhenfr=60%
rl
depahs
fr=80%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
Figure 4.7: Recall of the loss analysis
as we vary fr, for the case of uniform
drops on the whole traffic and on one
selectedflow(Scenario2).
(d)Recallwhenfr=80%
packetsandadroptailbuffermanagementpolicy.
4.3.1 One shaped flow
We start by examining a scenario in which only one flow is being
differentiated by the shaper. We proceeded by taking the trace pre-
viously described and by adding an extra flow of which we varied
the number of packets in order for it to be a fraction fr of the total
amount of packets of the trace. This is the flow that will be targeted
bytheshaper. Ourresultsareintermsofprecisionandrecall,which
show respectively the fraction of detected flows that we know are
indeed shaped, and the fraction of shaped flows that are correctly
detected.14 Perfectperformancetranslatesintoaprecisionandrecall 14Wedefineprecisionasbeingthenum-
of100%. ber of true positives (TP) over the
number of positives (P), and recall
as the number of true positives over
Shapingpipe(Scenario1). In this configuration the bandwidth bw of the sum of true positives and false
negatives (FN), that is to say over
theupperpipeontheleftsideissetasafunctionoftheaveragesend-
the number of flows that we know
were shaped. More details can be
found on http://en.wikipedia.org/
wiki/Precision_and_recall
chapter 4. chkdiff: the upstream experiment 69
ingrater(inbitspersecond)oftheshapedflow,computedbeforethe
experimentbegins. Wechosebw = k r,sothatafractionk ∈ (0,1]
bw bw
ofpacketsoftheshapedflowwouldusealltheavailablepipeband-
width bw and the rest would queue up. We ran ChkDiff 3 times
for each combination of k and fr, with k ∈ {0.2,0.4,0.6,0.8,1.0}
bw bw
and fr ∈ {0.2,0.4,0.6,0.8}. These are the values we used also in all
thefollowingexperimentsinScenario1. Theresultsareprovidedin
Figure 4.6, where we chose a compact representation in which each
circleshowsintheupper-leftquartertheresultofthedelayanalysis,
in the upper-right quarter the result of the loss analysis and in the
lower half theresult of the combined analysis. Since in this scenario
a shaping pipe causes queueing delays and, in case its queue fills
up,dropspackets,wedirectlyevaluatethebenefitsofcombiningthe
two analyses in such setting. In this basic scenario, we see that the
combined analysis manages to always identify the shaped flow. At
k =1weobservethattheflowstillexperiencedsomequeueing,as
bw
aresultofthepipebandwidthbeingafunctionoftheaveragesending
rateoftheflowandnotofitsinstantaneousrate.
Uniform drops (Scenario 2). Our goal in Scenario 2 is to verify to
whichextentChkDiffmanagestoidentifyashapedflow,whenlosses
affect a selected flow and the entire traffic at different rates. We
configured the shaper so that the upper pipe in Figure 4.5 drops a
fraction lr of the packets of the flow to shape, and the pipe on the
right-hand side, where all traffic goes, has a drop rate lr . We var-
all
ied again the size of the targeted flow and ran experiments with
fr ∈ {0.2,0.4,0.6,0.8}. For this and all the following experiments
in Scenario 2, we chose lr ∈ {0.05,0.1,0.2,0.4,0.6,0.8} and lr ∈
all
{0.2,0.4,0.6,0.8}. We do not include the graphs on precision, since
allresultsshowaprecisionof100%, whichmeansthatweneveren-
counteredanyfalsepositivesor,inotherwords,alltheflowsdetected
byChkDiffasbeingshapedwereindeedshaped. Ontheotherhand,
somefalsenegatives(i.e. shapedflowsthatgoundetected)didoccur,
so our analysis will focus on recall. In Figure 4.7 we present the re-
sults for this scenario. We only show the results of the loss analysis,
since in this scenario delays are not affects. On the X-axis we plot
the loss rate lr for all packets of the trace, whereas on the Y-axis
all
weshowtheoverallloss-ratelr experiencedbytheshapedflow:
shaped
1−(1−lr)(1−lr ). The tool achieves 100% recall in all cases
shaped
exceptthoseinwhich,withalowfrandafairlyhigh(≥40%)overall
loss rate, the loss rate of the shaped flow is close to the global one.
Theaddedlossratesonthelowerdiagonalofthegraphscorrespond
to lr = 0.05, which could be too low to be noticeable on samples of
relatively small size. In all other cases, the tool correctly identified
theshapedflow.
70 inference of network neutrality violations with active measurements
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
k
wb
100
80
60
40
20
0
noisicerp
P/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(a)Precisionofthecombinedanalysis
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
Figure 4.8: Precision and recall of the
combinedanalysis,forthecaseofmul-
tipleshapedflows,inScenario1.
(b)Recallofthecombinedanalysis
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(a)Recallwhenfr=20%
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(b) Recallwhenfr=40%
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=60%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(c) Recallwhenfr=60%
rl
depahs
fr=80%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
Figure 4.9: Recall of the loss analysis
as we vary fr, for the case of uniform
dropsonthewholetrafficandonmul-
tipleselectedflows(Scenario2).
(d)Recallwhenfr=80%
4.3.2 Multiple shaped flows
We now move to a more complex scenario, in which multiple flows
are being targeted by the shaper. In order to select which flows to
shape, given a fraction fr of the trace size to differentiate, we iter-
atively picked the flow whose size (in Bytes) was the closest to the
targetfr,untilthetotalamountwasreached.
Shaping pipe (Scenario 1). We set the bandwidth bw of the shaping
pipe as a function of the average sending rate of all packets belong-
ing to the flows to shape. All shaped flows pass through the same
shaping pipe so as to be able to compensate for one transmission
time only in the lower pipe. We present the results for this scenario
in Figure 4.8. While the precision reached appears to be optimal,
the recall plots show that, quite expectedly, when the shaped flows
amount to a large fraction of the trace, the baseline for comparison
becomestooweakforthetesttowork.
chapter 4. chkdiff: the upstream experiment 71
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
k
wb
100
80
60
40
20
0
noisicerp
P/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(a)Precisionofthecombinedanalysis
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
Figure4.10: Precisionandrecallofthe
combinedanalysis,forthecaseofmul-
tipleshapedflowswithaWiFiconnec-
tion,inScenario1.
(b)Recallofthecombinedanalysis
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(a)Recallwhenfr=20%
rl
depahs
fr=40%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(b) Recallwhenfr=40%
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=60%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(c) Recallwhenfr=60%
rl
depahs
fr=80%
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
Figure 4.11: Recall of the loss analysis
as we vary fr, for the case of uniform
dropsonthewholetrafficandonmul-
tipleselectedflowswithaWiFiconnec-
tion(Scenario2).
(d)Recallwhenfr=80%
Uniform drops (Scenario 2). In the scenario with uniform drops, we
used a different shaping pipe for each flow to differentiate, in order
to have the same loss rate lr for all shaped flows. Results are pro-
vided in Figure 4.9, where we omitted the plots on precision, since
it reached the optimal value (100%) for all combinations of parame-
ters. In the four subplots, we are mostly interested in the area with
lr ∈ [0.0,0.2], as it best represents a realistic setting: in a network
all
with no (0%) or relatively high (20%) packet drops, a shaper causes
losses of various degrees to part of the traffic passing through it.
Forcompleteness,wealsoshowcaseswithhigherlossesandalarge
fractionofaffectedtraffic. When20%ofthetrafficistargeted,weare
able to detect all differentiated flows, except when the shaped flows
experiencejust5%moreoflosses,ontopofthe20%overalllossrate
of the trace. We observe that, as we shape an increasing fraction of
thetrace,thelossanalysissignificantlydegrades. Thereasonisthat,
with several flows being differentiated, the baseline will necessarily
72 inference of network neutrality violations with active measurements
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
k
wb
r=30pps
100
80
60
40
20
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(a) Recall of the combined analysis, r =
30pps
k
wb
r=50pps
100
80
60
40
20
0
llacer
)NF+PT(/PT
(b) Recallofthecombinedanalysis,r=
50pps
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
k
wb
r=80pps
100
80
60
40
20
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(c) Recall of the combined analysis, r =
80pps
k
wb
r=100pps
100
80
60
40
20
0
llacer
)NF+PT(/PT
Figure 4.12: Scenario 1 with multiple
shapedflowsandICMPratelimitation
at20pps.
(d)Recallofthecombinedanalysis, r =
100pps
includemoreandmoreshapedflowsandthestatisticalanalysiswill
be impacted. However, this constitutes an extreme case for our tool
anditisunlikelytobeencounteredinpractice.
4.3.3 Multiple shaped flows over WiFi
We repeat the same experiments as in the previous section, with
multiple shaped flows, but we use a WiFi connection between the
client and the middlebox in order to stress the delay analysis. Fig-
ures 4.10 and 4.11 show the results for respectively Scenarios 1 and
2. In both cases, the results are qualitatively similar to the previous
setup,whereweusedawiredconnection.
4.3.4 ICMP rate limitation
We also wanted to verify how resilient our analysis is when we en-
counter a router that implements ICMP rate limitation. We tested
ChkDiffinthesamewiredexperimentalsetupsasbeforeandconfig-
ured the router to respond at most at 20pps (with a burst size of 20
packets and a period of 1 second), a common setting we found for
Cisco routers, as seen in Chapter 3. We repeated the experiments of
Scenarios 1 and 2 at different sending rates (30, 50, 80 and 100 pps)
higher than the ICMP rate limitation threshold. Our aim is to stress
our tool when an additional source of losses is present and see how
high our sending rate r can be, with respect to the rate limitation
chapter 4. chkdiff: the upstream experiment 73
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20%,rate=30pps
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(a)Recallofthelossanalysis,
fr=20%,r=30pps
rl
depahs
fr=20%,rate=100pps
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(b)Recallofthelossanalysis,
fr=20%,r=100pps
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=40%,rate=30pps
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(c)Recallofthelossanalysis,
fr=40%,r=30pps
rl
depahs
fr=40%,rate=100pps
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(d)Recallofthelossanalysis,
fr=40%,r=100pps
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=60%,rate=30pps
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(e)Recallofthelossanalysis,
fr=60%,r=30pps
rl
depahs
fr=60%,rate=100pps
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(f)Recallofthelossanalysis,
fr=60%,r=100pps
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=80%,rate=30pps
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(g)Recallofthelossanalysis,
fr=80%,r=30pps
rl
depahs
fr=80%,rate=100pps
100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
Figure 4.13: Scenario 2 with multiple
shapedflowsandICMPratelimitation
at20pps.
(h)Recallofthelossanalysis,
fr=80%,r=100pps
implementedontherouterside,whilestillminimizingerrors.
In Figure 4.12 we show the recall plots of the combined analysis
in the case of Scenario 1, where a shaping pipe throttles the band-
width of multiple selected flows. Since ICMP rate limitation only
causespacketdrops,itisnosurprisethatthedelaysarenomoreaf-
fectedthantheywereinthepreviouscasewhentherouterwasfully
responsive (Figure 4.8 (b)). We omit here and in the next scenario
theresultsforoneshapedflow,sincetheyalwaysshowedmaximum
74 inference of network neutrality violations with active measurements
precisionandrecall.
WeconductedagaintheexperimentsofScenario2,whereuniform
drops are applied to selected flows and to the whole traffic with
differentprobabilities,andweprovidetheresultsinFigure4.13. For
constraints of space, we only show the results for the minimum and
maximum probing rates we considered: 30 and 100 pps. We observe
that the loss test experiences considerable degradation only in the
extreme case of multiple shaped flows corresponding to 80% of the
trace. Most importantly, varying the probing rate from 1.5 (30 pps,
with a router-induced loss rate of 33%) to 5 times (100 pps, with a
router-induced loss rate of 80%) the ICMP rate limitation threshold
oftherouterdoesnotappeartoaltersignificantlytheresults.
4.3.5 A more complex scenario
Inarealisticsetting,ifauserdumpsherowntrafficwhilesomeTCP
flows are being targeted by a shaper that throttles their bandwidth,
thesendingrateoftheseflowsinsidethecapturedtracewillalready
have been reduced by the shaper. If ChkDiff replays this trace at its
original sending rate, the TCP flows that were previously throttled
will now comply with the shaper’s policies and will not of course
experienceanyfurtherdegradation. Itisthereforeimportanttoscale
up our probing rate with respect to the original one, in order to be
abletotriggeranddetectthepresenceofashaper.
We set up a wired scenario with a shaper, ICMP rate limitation
and cross traffic. In the same way as in Section 4.3.1, we created a
flow constituting 20% of the total trace size and injected it in our
trace so that it would be evenly spread out and have consequently
a constant sending rate r . The shaper was configured as in the
flow
previouscaseofashapingpipeaffectingoneflowonly,anditsband-
width was set to r . The router activated ICMP rate limitation at
flow
50pps, a common value for Juniper routers, as we showed in Chap-
ter3. Finally,weaddedsomecrosstrafficflowingonaverageat20%
of our sending rate and implemented as a series of bursts of ping
packets following a Poisson process. We configured the bandwidth
of the pipe on the right-hand side in Figure 4.5 to be equal to the
sum of the rate of the trace and of the cross traffic. This way, the
wholetracealsoexperiencesqueueing.
In this setup, we assess whether a shuffled trace replayed at a
constant rate is indeed more robust to transient network conditions
thantheoriginaltracereplayedasitis. Weincreasedtheprobingrate
r byafactorof1.5,2,4,8and16timestheoriginalprobingrater
orig
Rate
1x 1.5x 2x 4x 8x 16x
Original TruePositives 0 1 1 1 1 1
trace FalsePositives 11 3 3 1 2 1 Table4.1:Numberoftrueandfalsepos-
Shuffled TruePositives 0 1 1 1 1 1 itiveswhenreplayingtheoriginalanda
shuffledtraceatdifferentsendingrates.
trace FalsePositives 0 0 0 0 0 0
chapter 4. chkdiff: the upstream experiment 75
ofthetrace(withr =64pps)andcountedinTable4.1thenumber
orig
offalsepositivesofthedelayanalysisacross3runs. Weseethat,even
though in both cases we correctly identify the shaped flow already
at 1.5x, we never encounter any false positives when replaying a
shuffledtrace. Withtheoriginaltrace,ontheotherhand,wealways
obtained some false positives; their number seems to decrease with
high probing rates only because the amount of flows with sufficient
samplesalsodecreases.
4.4 Assessment with respect to existing methods
A number of tools for the detection of traffic differentiation have
been proposed in the literature in the past few years, as detailed in
Chapter2.
A work that has some aspects in common with the upstream ex-
periment of ChkDiff is NetPolice,15 where the authors were able to 15Ying Zhang, Zhuoqing Morley Mao,
detect differentiation in backbone networks with the use of TTL- and Ming Zhang. Detecting traffic
differentiation in backbone isps with
limited probes. Using synthetic traces made of HTTP, peer-to-peer, netpolice. In Proceedings of the 9th
BitTorrentandotherapplicationflows,theyprobedingressandegress ACM SIGCOMM Conference on Internet
MeasurementConference,IMC’09,pages
routers of backbone ISPs from a large set of PlanetLab nodes in or-
103–115.ACM,2009
der to notice any difference in loss rates along the same path seg-
ment: if any difference was observed, they tried to attribute it to
content-based differentiation (with the HTTP flow as baseline) or,
when the discrepancy was between different IP sources or destina-
tions, to routing-based differentiation. Our approach does leverage
TTL-limitedprobes,butitisclient-oriented(inatraceroute-likeman- 16MarcelDischinger,AlanMislove,An-
ner), it focuses on the user’s access ISP, and does not make assump- dreasHaeberlen,andKrishnaP.Gum-
madi. Detecting BitTorrent Blocking.
tions on which flows should be considered as non-differentiated in In Proceedings of the 8th ACM SIG-
itsanalysis. COMM Conference on Internet Measure-
ment (IMC’08), Vouliagmeni, Greece,
One of the first tools presented to the scientific community was
October2008
BT-Test,16 which checks for TCP reset packets injected by ISPs dur- 17Marcel Dischinger, Massimiliano
ing the replaying of a typical BitTorrent packet exchange between a Marcon, Saikat Guha, Krishna Gum-
madi, Ratul Mahajan, and Stefan
userandcontrolledserver. Itsaimwastodiscloseapracticethathad
Saroiu. Glasnost: Enabling End Users
been recently reported by some U.S.-based users. The same authors to Detect Traffic Differentiation. In
laterproposedamorecomprehensivetool,Glasnost,17thatcompares Proceedings of the 7th Symposium on
Networked Systems Design and Imple-
the maximum throughput of an application flow (e.g., BitTorrent, mentation (NSDI), San Jose, CA, Apr
YouTube, etc) to that of a control flow whose packets are the same 2010
asintheapplicationflowexceptfortheirpayload,whichisrandom-
ized. Thepacketsofthetwoflowsareinterleavedsoastoexperience
thesamenetworkconditionsandarereplayedtoaserver. Thistech-
niqueexpectstrafficdifferentiationtohappenattheapplicationlayer
by means of deep packet inspection, and to result in lower through-
put for the affected application. ChkDiff is also able to detect such
cases,sincealowerthroughputistheresultofhigherpacketdelays,
but we do not make the assumption that a shaper targets a specific
applicationandthatitdiscriminatesaccordingtopacketpayloads.
A tool that also focuses on a specific application and control flow
is DiffProbe,18 which attentively analyzes the delay and loss distri- 18Partha Kanuparthy and Constantine
butions of the two flows during a replaying phase at the normal Dovrolis. Diffprobe: detecting ISP ser-
vicediscrimination.InProceedingsofthe
29th conference on Information communi-
cations,INFOCOM’10,pages1649–1657,
Piscataway,NJ,USA,2010.IEEEPress
76 inference of network neutrality violations with active measurements
application sending rate and during a replaying phase at a higher
rate, which attempts to create congestion at possible shapers along
the path. The control flow is crafted much in the same way as pre-
viously described, with the addition of transport layer fields such
asportnumberbeingmodifiedinordertobypassshapers. Thistool
wassoonfollowedbyShaperProbe,19whichassumesthatdifferentia-
19Partha Kanuparthy and Constantine
tionhappensthroughatokenbucketandtriestoinferitsparameters Dovrolis. Shaperprobe:End-to-endde-
tection of isp traffic shaping using ac-
(buffer size and processing rate). It sends at the path capacity trains tivemethods. InProceedingsofthe2011
of packets back-to-back to a server and, if they traverse a shaper, it ACM SIGCOMM Conference on Internet
MeasurementConference,IMC’11,pages
expects to observe a level shift in the received rate at the destina-
473–482.ACM,2011
tion. While both methods undoubtedly provide more insight than
ChkDiffonthecharacteristicsofshapers,theyanalyzethebehaviour
of one application at a time and, even if in principle they can adapt
to any application, they are in practice limited to the packet traces
provided with the executables (i.e. Skype, in this case). Packsen20 20Udi Weinsberg, Augustin Soule, and
has a similar approach to DiffProbe, but it improves on it by using Laurent Massoulié. Inferring traffic
shaping and policy parameters using
a less computationally expensive statistical analysis in order to infer
endhostmeasurements. InINFOCOM,
theshapertypeandparameters. pages151–155,2011
Nano21 differsfromexistingsolutionsinthatitcarriesoutpassive 21Mukarram Bin Tariq, Murtaza Moti-
measurements on user traffic and compares it against a data set of wala,NickFeamster,andMostafaAm-
mar. Detectingnetworkneutralityvio-
otherusersinthesamegeographicalarea,withcomparablemachine
lationswithcausalinference.ACMSIG-
setups, at the same time of the day, but connected to a different ISP. COMMCoNext,page289,2009
While this method is undeniably independent of user applications
anddifferentiationtechniques,itsmaindisadvantageisthatitneeds
afairlylargenumberofusersforittobeoperational.
More recently, a theoretical framework for the inference and lo-
calization of neutrality violating links has been proposed.22 After 22Zhiyong Zhang, Ovidiu Mara, and
conducting measurements from different vantage points traversing Katerina Argyraki. Network neutral-
ityinference. InProceedingsofthe2014
the same links, it builds a linear system of equations in the same
ACM Conference on SIGCOMM, SIG-
fashion as in network performance tomography. When the network COMM ’14, pages 63–74, New York,
NY,USA,2014.ACM
isneutral,suchsystemissupposedtobesolvableanditinfersprop-
erties of the links. When instead a link is not neutral, the measure-
ments are inconsistent and the system unsolvable. The deployment
of such method would require a large and diverse user base, where
several vantage points perform measurements on the same set of
paths and send the results to a central server, which would process
the data and infer differentiation. Our approach is instead confined
to the network performance experienced by the end user who runs
thetool: noaggregationofresultsacrossusersisnecessary.
4.5 Summary
In this chapter we presented the upstream experiment of ChkDiff,
a novel tool for the detection of traffic differentiation at the Inter-
net access. After replaying the user outgoing traffic to the routers at
thefirstfewhops,thetoolappliesastatisticalanalysistodelaysand
lossesinordertoinferwhetheranyofthereplayedflowsexperienced
degraded performance. We validated ChkDiff in a controlled envi-
ronment with different setups and showed its robustness to ICMP
chapter 4. chkdiff: the upstream experiment 77
ratelimitation.
In the next chapter, we extend ChkDiff so that it includes an ex-
perimentfordownstreamtraffic, whichweshuffleandreplaytothe
user from a dedicated measurement server in order to detect differ-
entiation.
5
ChkDiff: the downstream experiment
We saw in the previous chapter that ChkDiff directly addresses the
problems of scalability to different user applications and of applica-
bilitytodifferentshapingtechniquesaffectingdelaysandlosses. We
achieve this by performing active measurements with the real user
traffic,comparingtheperformanceofaflowagainsttheperformance
of the rest of the replayed traffic, and by analyzing for each flow its
delaysandlosses,whichreflectanyalterationintroducedbyashaper
insidethenetwork.
ThischaptercomplementsChapter4,inwhichwefocusedonthe
user’s upstream traffic and replayed it with low TTL values in a
traceroute-likemanneragainsttheroutersatthefirstfewhopsaway
from the user in order to detect differentiation and localize shapers.
Weextendthiswithanewexperimentinthedownstreamdirection,
where we replay the user’s incoming traffic from a server, measure
one-way delays and losses, and check for differentiation on a per-
flow basis. We describe in details the measures taken by ChkDiff
in order to successfully deliver the replayed trace and validate the
tool in two differentiation scenarios, with the server located in three
differentdatacenters,andoverwired,WiFiand3Gconnections.
The chapter is organized as follows: in Section 5.1 we provide
a detailed description of the methodology we used in ChkDiff; in
Section5.2wevalidatethetool;wediscussourmethodinSection5.3
and assess it with respect to related work in Section 5.4; we give
closingremarksinSection5.5.
We presented the results of this chapter in a paper published at
ITC28.1
1Riccardo Ravaioli, Guillaume Urvoy-
Keller, and Chadi Barakat. Testing for
traffic differentiation with chkdiff: the
5.1 Methodology downstreamcase. InTeletrafficCongress
(ITC 28), 2016 28th International. IEEE,
2016
Thedesignofanewtoolforthedetectionoftrafficdifferentiationhas
tonecessarilyconsidertwoweakpointsofexistingmethods: thedif-
ficultytoscaletodifferentapplicationsandthelimitationtospecific
differentiation techniques. As illustrated in Chapter 4, we overcome
thisinthreesteps: a)weusetherealtrafficofauserandnotasyn-
thetictrace;b)weminimizethemodificationstothetraceneededfor
theexperimenttoworkandc)weanalyzetheperformanceofaflow
in terms of delays and losses with respect to the rest of the trace in
80 inference of network neutrality violations with active measurements
(a)Upstreamexperiment (b) Downstreamexperiment
Figure 5.1: The two experiments in
ChkDiff.
order to infer neutrality violations: these two metrics alone are able
tocapturetheeffectofshapersattheIPlayer.
A complete run of ChkDiff consists of two experiments, one that
replaystheuser’soutgoingtraffic(upstreamdirection)totherouters
at the first few hops away from the user and one that replays the
user’s incoming traffic (downstream direction) from a measurement
server to the user. We report in Algorithm 2 an outline of a full
executionofChkDiff.
At first the tool dumps client traffic for a time window of typ-
ically 3-5 minutes, while the user is asked to run the applications
and services of an Internet session she wishes to test. Next, packets
aregroupedinto5-tupleflows(sourceanddestinationIPaddresses,
transportprotocol, sourceanddestinationportnumbers), whichare
further arranged into an outgoing trace, trace , and an incoming
out
one, trace . We now briefly recall the upstream experiment, fully
in
described in Chapter 4, and then go on to illustrate in detail the
methodologyforthedownstreamcase.
5.1.1 Upstream experiment, in a nutshell
Non-trivial outgoing traffic that an access ISP might want to differ-
entiate includes media uploading, P2P file sharing and VoIP; a run
of ChkDiff in the upstream direction should ideally test at least one
type of such traffic. Before conducting the actual experiment, we
shuffle trace in such a way that the position of the packets of each
out
flow inside the trace follows a Poisson process, so that according
to the PASTA property (Poisson Arrivals See Time Averages),2 each 2Ronald W Wolff. Poisson arrivals
flowwillseethesamenetworkconditionswhenthetraceisreplayed. see time averages. OperationsResearch,
30(2):223–231,1982
chapter 5. chkdiff: the downstream experiment 81
The order of packets within each flow is preserved. As in the first
half of Algorithm 2, we consider the first few hops away from the
user, at or in proximity of her access ISP network (up to hop 3 or 4,
as in Figure 5.1(a)), and for each hop h we replay trace at a con-
out
stant sending rate higher than the original one and with a modified
IP TTL set to h, so that the trace will expire on the router(s) at hop
h and generate ICMP time-exceeded messages. We showed the va-
lidity of this ICMP feedback in Chapter 3, along with its robustness
toICMPrate-limitation. EachflowhavingitsownsetofRound-Trip
Times (RTT’s) and losses, we can now compare its performance up
to a given hop to that of the rest of the flows along the same path.
We use Kolmogorov-Smirnov test to analyze delays and a binomial-
inspired test to analyze losses. By aggregating the results of each
flow across consecutive hops we are able to infer the presence of a
shaperandlocalizeitintermsofnumberofhopsfromtheclient.
5.1.2 Downstream experiment
In this chapter, we present the downstream version of ChkDiff and
validate it experimentally. In brief, the experiment in the down-
stream direction consists in taking all necessary measures to replay
the original incoming flows, having the server replay the trace to
the client and finally analyzing the results in a way that takes into
account the possibility of having multiple paths to the client (Fig-
Algorithm2ChkDiffcompleteexecution
1: Captureusertraffic,storeintotrace out andtrace in
2: ⊲ Upstreamexperiment
3: foreachhop h ∈ {1,2...k} do
4: foreachrunr ∈ {1,2,3} do
5: shuffletrace out
6: replaytrace out with TTL ←h
7: collectICMPtime-exceededreplies
8: endfor
9: detectshapedflowsathop h
10: endfor
11: aggregateresultsandlocateshaper(s),ifany
12: ⊲ Downstreamexperiment
13: foreachrunr ∈ {1,2,3} do
14: shuffletrace in
15: foreachflow f intrace in do
16: findNATmappingfor f
17: initiateconnectionfromclient
18: endfor
19: replaytrace in fromservertoclient
20: computeone-waydelaysandlosses
21: endfor
22: detectshapedflows
82 inference of network neutrality violations with active measurements
ure5.1(b)).
The second half of Algorithm 2 outlines the main steps of the
downstreamexperiment,whichwedescribeindetailsintheremain-
der of this section. First, we need to shuffle trace in the same way
in
wedidintheupstreamexperiment. Thisallowsustoeliminatecross
traffic noise from the effects of possible neutrality violations. Then,
forareplayedflowtobeabletosuccessfullyreachtheclient,weneed
to deal with possible Network Address Translation (NAT) and fire-
walldevicesausermightbebehindandalsootherpossiblemiddle-
boxes that might be deployed along the path from the server. After
all connections are initiated from the client side, the server replays
theshuffledtrace totheclientataratehigherthantheoriginalone.
in
We compute One-Way Delays (OWD’s) for each flow and note the
number of losses, if any. In order to infer differentiation, we run a
clusteringanalysisondelayssothatwecandistinguishwhendiffer-
entdelaydistributionsareduetoshapingandwhentheyaredueto
avarietyofpaths. Lastly,atestonflowlossescompletestheanalysis.
Weelaboratenowoneachoftheaboveactions.
Gettingreadyforreplaying. As opposed to the upstream experiment
(Chapter 4), we do not truncate or pad packets in trace to a fixed
in
size. Intheupstreamexperimentthelowvariabilityofthetotaldelay
along a short wired path is in the same order of magnitude as the
variability of the transmission delay, which is proportional to the
packet size. That makes it impractical to replay packets exactly as
captured, since flows with large packets over a wired connection
experience larger delays solely because of their packet size. For the
downstream case, we examine a much longer path in terms of hops
and delays, and such source of error is canceled out by the inherent
delayvariabilityalongalargerpath. Thereforeweareabletoreplay
the packets with their original payloads, as seen by the client upon
receivingthem.
Replaying incoming traffic from a single source (i.e. our server)
means that we cannot keep the original source IP addresses of the
usertrace,fortwomainreasons. Firstly,mostaccessnetworkstoday
are configured to drop outgoing packets with a source address that
does not belong to the address space of the access network itself. In
otherwords,theydonotallowIPaddressspoofing.3 Secondly,aswe 3BCP 38 - Network Ingress Filter-
willseeshortly,ifaNATdeviceispresent,wecanreplayaflowonly ing: Defeating Denial of Service At-
tacks which employ IP Source Ad-
if we find the mapping applied by the NAT to that flow for external
dress Spoofing. URL: https://
endpoints. Since we are not in control of other endpoints (that is to tools.ietf.org/html/bcp38
say, all network applications or services run by the user) than our
measurement server, we need to overwrite the IP source address of
each packet in trace with the IP address of the server; original port
in
numbers are retained. Conversely, in the upstream experiment the
original source and destination IP addresses are preserved. How-
ever, even if in the downstream case we lose the ability to reveal
shapers based on the source IP address, we can combine upstream
and downstream experiments to overcome the limitations of both.
chapter 5. chkdiff: the downstream experiment 83
Furthermore, the commercial shapers studied in a recent work4 do 4ArashMolaviKakhki,AbbasRazagh-
notusethispieceofinformationtoclassifyflows. panah, Anke Li, Hyungjoon Koo, Ra-
jesh Golani, David Choffnes, Phillipa
Afterbeingshuffled,trace issentviaFTPtotheserver. Whilewe
in Gill,andAlanMislove.Identifyingtraf-
deployaserverwithapublicIPaddress,listeningonaknownport, fic differentiation in mobile networks.
In Proceedings of the 2015 ACM Confer-
a client is likely less easy to reach: a few network elements need to
enceonInternetMeasurementConference,
beconsideredbeforewecanreplaythetracetotheclient. pages239–251.ACM,2015
• NAT’s. In today’s networks, where IPv4 addresses are running
out, deploying a NAT device has become a widespread practice.
Forourpurposes,thismeansthattheclient’sviewofaflowmight
not be the same as the server’s. Since the trace to replay is orig-
inally as seen by the client, we might need to modify the desti-
nation IP address and port number in order to reach the client
from an external endpoint (Figure 5.1(b)). NAT devices are usu-
ally defined according to how they map the same source pair
X:x of IP address X and port number x of an internal network
when different external destination IP addresses and port num-
bers are reached (for instance Y 1 :y 1 and Y 2 :y 2 ).5 We distinguish 5RFC 4787 - Network Address Trans-
four cases: (i) in the simplest scenario the mapping is indepen- lation (NAT) Behavioral Requirements
for Unicast UDP. URL: http://
dent of the external destination endpoint and will not change for
tools.ietf.org/html/rfc4787
thesamesourcepairX:x;(ii)someNAT’sgeneratethesamemap- RFC 5382 - NAT Behavioral Re-
quirements for TCP. URL: http://
ping only with same external destination IP address (Y ≡ Y ) or
1 2 tools.ietf.org/html/rfc5382
(iii)withthesameexternaldestinationIPaddressandportnumber
(Y ≡Y andy ≡ y ))and(iv)themappingmightbeconnection-
1 2 1 2
dependent and vary each time a new connection to the same ex-
ternaldestinationpairisinitiated.
• Firewall. Weassumethatanyuserisprotectedbyafirewallfrom
the outer network. Consequently, all flows need to be initiated
from the user side (a technique called hole punching) before the
server can replay the trace. For TCP flows, we reproduce the
whole 3-way handshake without the interaction of the kernel on
both endpoints. We assign an initial sequence number for each
side of a TCP flow and modify it accordingly in the data packets.
ForUDPflows,weonlysendoneprobefromtheclient.
• Initial sequence numbers. It has been observed that some mid-
dleboxes overwrite the initial sequence number of TCP flows.6 6Michio Honda, Yoshifumi Nishida,
Sincefirewallscaneasilykeeptrackofthesequencenumbersand CostinRaiciu,AdamGreenhalgh,Mark
Handley, and Hideyuki Tokuda. Is it
reject inconsistent packets, it is important to intercept the over-
stillpossibletoextendTCP?InProceed-
written sequence number from the SYN packet of the TCP hand- ingsofthe2011ACMSIGCOMMConfer-
enceonInternetMeasurementConference,
shakeandmodifyallsubsequentsequenceandacknowledgement
IMC’11,pages181–194,NewYork,NY,
numbersindividuallyforeachTCPflow. USA,2011.ACM
GregoryDetal,BenjaminHesmans,
• Timeouts. In NetFilter,7 the standard firewall provided in Linux,
Olivier Bonaventure, Yves Vanaubel,
the TCP timeout for established connections is 5 days, while for andBenoitDonnet. Revealingmiddle-
boxinterferencewithtracebox. InPro-
UDP it is only 30 seconds whether packets have been seen in one
ceedingsofthe2013ConferenceonInternet
orbothdirections. Thismeansthatweneedtomakesurethatthe MeasurementConference,IMC’13,pages
timeelapsingbetweentwoconsecutivepacketsofeachUDPflow, 1–8,NewYork,NY,USA,2013.ACM
7NetFilter: Firewalling, NAT and
initialprobesincluded,islessthan30seconds. NATmappingsex-
packet mangling for Linux. URL:
piretooinordertoremovestaleentriesfromtheNATtable. Given www.netfilter.org
thelargeamountofcommercialNATdevices,wereferinthiscase
84 inference of network neutrality violations with active measurements
to the requirements and guidelines found in the RFC’s. For UDP
flowsthetimeoutshouldnotbelessthan2minutes,while5min-
utes is recommended;8 for TCP if the connection is not yet in the 8RFC 4787 - Network Address Trans-
established state, the timeout should not be less than 4 minutes, lation (NAT) Behavioral Requirements
for Unicast UDP. URL: http://
andifitisalreadyintheestablishedstateitshouldbenolessthan
tools.ietf.org/html/rfc4787
2 hours and 4 minutes.9 These values are all large enough for 9RFC 5382 - NAT Behavioral Re-
the purpose of our experiment and do not interfere with ChkD- quirements for TCP. URL: http://
tools.ietf.org/html/rfc5382
iff. Finally, to avoid unnecessary synchronization between client
and server, we do not actually send any acknowledgments from
the client side for the TCP flows we replay. In the Linux kernel,
the socket parameter TCP_USER_TIMEOUT sets the maximum
amount of time that data can be transmitted without being ac-
knowledged. Its default value is 20 minutes,10 which is roughly 10Linux Programmer’s Manual - TCP
oneorderofmagnitudelargerthanasinglerunofChkDiff. protocol . URL: http://man7.org/
linux/man-pages/man7/tcp.7.html
Given that our goal is not to classify all possible devices along a
pathbuttorapidlydeliverthetracetotheclient,wetakeaconserva-
tiveapproachandassumethatthemoststringentrestrictionsamong
the above ones are in place. We expect the NAT to be connection-
dependent and perform a per-flow mapping discovery already dur-
ingtheholepunchinginitiatedbytheclientagainstherfirewall. For
each flow, we encrypt the client’s view of its source IP address and
port number and add it to the payload of its SYN packet or UDP
probe,asNATdevicesareexpectedtooverwriteeveryoccurrenceof
the client’s own IP address in a packet. We set the client-side initial
sequence number of TCP flows in accordance to the acknowledge-
ment numbers used in the trace (since no packets are sent from the
client during the replaying phase, the acknowledgement number of
a TCP flow sent by the server is constant across packets of the same
flow). Fromtheserverside,forTCPflows,wekeeptrackofincoming
SYNpacketsalongwiththeobservedsequencenumbersandclient’s
source pair, and mimic the TCP handshake; for UDP flows we just
keeptrackofclient’sandserver’sviewsoftheclient-sidesourcepair.
When these two views differ, we modify the client-side IP address
and port number of the corresponding flows in trace with the pair
in
as seen by the server. The server also overwrites the acknowledge-
ment number of a TCP flow, when the number in the trace does not
match the sequence number seen in the received SYN packet. Ad-
ditionally, in order to overcome the relatively short timeout on UDP
flows, we enforce a maximum interval of 30 seconds between any
two UDP packets of the same flow when shuffling trace and start
in
a timeout on the client side to make sure that we do not exceed 30
seconds between the initial UDP probe of a flow and its first occur-
renceinthetrace. Wediscardthecurrentrunoftheexperimentand
start a new one if ever this timeout expires. In any case, during an
ordinary execution of ChkDiff only a few seconds elapse between
holepunchingandthestartofthereplayingphase.
We avoid the overhead of opening a socket for each flow and re-
playingthetracefromtheapplicationlayerbyinjectingpacketswith
chapter 5. chkdiff: the downstream experiment 85
Figure5.2: Configurationofclientand
server.
tcpreplay11 directly between the IP layer and the Network Interface 11Tcpreplay. URL: http:
Card. SinceweareemulatingTCPandUDPflowsbelowtheIPlayer, //tcpreplay.appneta.com/
weneed toprevent ourpackets fromreaching theirrespective client
applications,whichcouldcauseunsolicitedtrafficorunexpectedap-
plication behaviour. Also, our hole-punching probes target ports on
the server on which no process should be listening and will trigger
TCPresetpacketsforTCPSYNprobes,ICMPport-unreachablemes-
sages for UDP probes and real application packets if ever a process
is indeed listening. As error messages cross a firewall on their way
to the user, the corresponding newly-created connection entries are
removed. Therefore, we need a way to distinguish between experi-
mentpacketsandregulartraffic,sothatwecandroptheformerright
before they reach the IP stack and we can allow the latter to pass
through. Weachievethisbyassigningauniquenumbertoeachuser
session and overwrite with this value the 2-Byte IP ID field of each
experiment packet between a given user and the server. Through a
combined use of tcpdump and iptables, as shown in Figure 5.2, we
dump the experiment packets right at the Network Interface Card
and drop them before they reach the kernel, so that error messages
arenevergeneratedateitherendpoint.
Replay. We are now ready to replay the trace from the server at
a constant packet rate higher than the original one (by default, we
replayitattwicetheoriginalrate).
Wedumpthereplayedtraceonboththeserverandtheclientand
thenforeachflowwemeasureOne-WayDelaysandnotethenumber
of lost packets. For simplicity, we avoid any clock synchronization
between user and server: any effect due to clock skewing is not ex-
pected to disrupt the measured delays for the short time window of
oneexperiment(afewtensofseconds)andinanycasewillaffectall
flowsequally,astheyareevenlyspreadacrossthetrace.
Once the server has completed the replaying phase, the client
closes the emulated TCP connections by sending an RST packet for
eachTCPflowintrace . Thishastheaddedbenefitofclearingspace
in
86 inference of network neutrality violations with active measurements
Figure5.3:Timeseriesofanexperiment
with packets following multiple paths.
Each packet is represented by a black
dot.
intheopenconnectiontableofthefirewall,ifeveraper-userrestric-
tionisactive.
Resultsanalysis. The study of delays between two endpoints across
a path of several hops has to necessarily take into account the pos-
sibility of multiple paths. Discovering the paths taken by each flow
would be cumbersome: first of all, we do not know the exact hash
function applied in a load balancing decision and we observed that
somedatacenters,wherethemeasurementservercouldbedeployed,
make a massive use of load balancers; second of all, it would take
someextratime,aswewouldneedtoprobeatlowrates(i.e. 1packet
per second) to bypass ICMP rate limitation - as seen in Chapter 3 -
and have a complete view of each path. An example is provided in
the timeseries of Figure 5.3, where we can visually identify at least
five different paths; a direct comparison between any two flows be-
comes harder in this case. In the absence of the ground truth, we
canrelyonthefactthatnon-differentiatedflowsfollowingthesame
path will have similar delay distributions, which a clustering algo-
rithm can group together. A differentiated flow going on any of the
available paths will show a distribution significantly different from
thatofallotherflowsandshouldnotbelongtoanyofthediscovered
groups. Wecombinethiswithalossanalysisinordertocapturethe
behaviourofshapers.
• Delays. Ourchoiceofclusteringalgorithmfordelaysisdbscan,12 12MartinEster,Hans-PeterKriegel,Jörg
which groups together points that are in the same high-density Sander, and Xiaowei Xu. A density-
based algorithm for discovering clus-
area and labels as outliers those that do not belong to any found
ters in large spatial databases with
cluster. As a representative point for each flow we take its 25th noise. In Kdd, volume 96, pages 226–
231,1996
percentile: it is close enough to the real path delay, it discards
possible queueing delays and it is robust to delay variations due
for example to WiFi. The algorithm then takes two parameters:
the minimum number n of core samples to form a cluster and
themaximumdistanceǫbetweenanytwosamplesforthemtobe
includedascorepointsinacluster. Sinceweexpectshapedflows
to stand out from non-shaped flows, we set n to 2. As for ǫ, we
need a value that reflects the delay variations of a path: we take
the core values (2nd quartile range, i.e. the 25th-50th percentile
chapter 5. chkdiff: the downstream experiment 87
Figure5.4:Setupusedinthevalidation
ofChkDiff,alongwiththeshapercon-
figuration.
range) of the delay distribution of each flow, we aggregate them
andthenpickfor ǫ alargevalueinthisset,the75thpercentile.
Theoutputofdbscanwillbeasetofclustersofflowsandaset
ofoutliers. Welabelthelatterashavingfailedthedelayanalysis.
• Losses. Wecomparethelossesofaflowtothelossrateoftherest
of the trace as a whole, in the way illustrated in Chapter 4. The
reasoningisthefollowing: ifaflowi withs packetshasnotbeen
i
differentiated, its number of lost packets can be modeled as a bi-
nomialrandomvariableofparametersB(s, p),where pistheloss
i
rate of the rest of the trace. If we approximate this binomial to a
normalrandomvariableofparameters N(s p, s p(1−p)),wecan
i i
verify whether the number of lost packets l of flow i lies within
i
α standard deviations of the normal mean, where α is approxi-
mated to 2.58 for our chosen significance level of 99%. Since we
are interested to know whether a flow experienced more losses
than it should have with the global loss rate p, we check that
l < ps +αpp(1−p)s. If the condition does not hold, the flow
i i i
isrejectedbyourlossanalysis.
Since a shaper affects the delays or the losses of a flow, or both,
werejectaflowifitfailseitheranalysis.
We repeat the whole experiment three times in order to remove
transienterrorsandclaimthataflowwasdifferentiatedifinallthree
runsitfailedthecombinedanalysisofdelaysandlosses.
5.2 Validation
We validate the downstream experiment of ChkDiff in wired, WiFi
and 3G setups (Figure 5.4) with a client located in France and the
serverlocatedinthreedifferentAmazondatacenters: Germany,Ire-
land and Oregon (USA). The client is directly connected to a mid-
dlebox, where the shaper is deployed and which serves also as the
client’s gateway. In the WiFi setup, the client is connected to the
gateway through a dedicated WiFi network operating on the same
channelasthelocalUniversityWiFinetworktocausemorelink-level
collisions. In the 3G setup, the client is connected to the middlebox
viaawiredconnectionandthemiddleboxisconnectedviaWiFitoa
88 inference of network neutrality violations with active measurements
mobilephonefunctioningashotspot. WetestChkDiffinthetwodif-
ferentiationscenariosseeninChapter4: givenasetofflowswewant
todifferentiate,inScenario1wethrottletheirbandwidthandinSce-
nario 2 we apply a uniform packet drop rate to them. We configure
dummynet13 on the middlebox to shape incoming traffic, as shown 13Marta Carbone and Luigi Rizzo.
in the upper part of Figure 5.4. Flows to shape are forwarded to Dummynetrevisited. SIGCOMMCom-
put. Commun. Rev., 40(2):12–20, April
the upper pipe, which applies the desired differentiation technique
2010
according to the scenario we test; flows that we do not intend to
differentiate go through the lower pipe, which only adds a constant
delay equal to the transmission delay of the upper pipe in Scenario
1 and has no effect in Scenario 2. This way, in Scenario 1 the differ-
enceindelaysbetweenshapedandnon-shapedflowsisdueonlyto
the queueing delay at the upper pipe. A final pipe, where all flows
eventuallygo,emulatesa100Mbit/slink. InScenario2thislastpipe
causesuniformdropsonthewholetrace.
In all experiments we replay a trace of approximately 9000 pack-
ets captured during an Internet session of 3 minutes that included
watching a short streaming video, browsing a news website and
makingacallonSkype. Indummynet,ourpipeshaveabufferlength
of100packetsandusedroptailbuffermanagementpolicy.
5.2.1 Shaping pipe (Scenario 1)
Inthisscenario,wecomputeintrace theoverallsendingrateofthe
in
flows to shape and set the shaping pipe to a fraction k < 1 of this
bw
value. The second parameter we vary is the fraction fr of packets
we shape. When picking which flows to differentiate, we choose
iteratively the flow closest to the target fr, until the desired size is
reached. All flows we differentiate go through the same shaping
pipe. By combining delay and loss analysis, we show that we can
effectively identify all shaped flows as long as the fraction fr does
notconstitutemostoftrace ,whichiswhatweexpectwhenwetake
in
thewholetraceasbaselineforcomparison.
Figure5.5:Distributionofflowsizesfor
the trace we used in the validation of
thetool.
(a)CDFofflowsizesin#ofpackets. (b)CDFofflowsizesinKB.
chapter 5. chkdiff: the downstream experiment 89
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(a)Frankfurt,wiredconnection.
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(b)Ireland,wiredconnection.
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
(c) Oregon,wiredconnection.
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(d)Frankfurt,WiFiconnection.
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(e)Ireland,WiFiconnection.
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
(f)Oregon,WiFiconnection.
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(g)Frankfurt,3Gconnection.
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.2 0.4 0.6 0.8
fr
(h)Ireland,3Gconnection.
k
wb
100
80
60
40
20
0
llacer
)NF+PT(/PT
14The definition of recall we use is
the classic one: the number of true
positives over the sum of true posi-
tives and false negatives; in our spe-
cific case, it is the number of differen-
tiatedflowscorrectlydetectedasdiffer-
entiatedbythecombinedanalysisover
thenumberofflowsthatweknowwere
shaped, whether or not we have de-
tecte(di)Othreemgo.n,A3Grceocanlnleoctfio1n0.0% indi-
cates that we have correctly identified
all shaped flows, while a recall of 0%
WepresentinFigure5.6theresultsintermsofrecall14 foreachof F y i W ni s gd eis ui d cr ( a o e d te e 5 n s l . o 6 a t y : t hR i a na et nc cw ld a u le d l l h oe o s af ts vt he he es e ) m r c ef io os sm u s r e l b t d Ss i c nt ei he nn de at m r a eir n o a m alll 1s -.
the three server locations over wired, WiFi and 3G connections. For oovfeprrweciirseiodn,,WcioFmiamnodn3lyGdcoefinnneedctiaosnsth.e
eachpairoffrandk weshowapiewherethecolouroftheupper- numberoftruepositivesoverthenum-
bw
ber of positives, since we found it for
left quarter represents the result of the delay analysis, the colour of
all experiments to be the optimal one,
theupper-rightquarterrepresentstheresultofthelossanalysis,and at 100%; in short, we never flagged a
non-differentiatedflowerroneously.
thecolourofthelowerhalfistheoutcomeofthecombinedanalysis.
Ifforfr≤40%inalmostallcasesthedelayanalysissufficestodetect
all shaped flows, for fr = 60% we see that combining the delay and
loss analysis is essential for a correct output. When k = 1.0 the
bw
shaping pipe is configured with the average bit rate of incoming
packets, so the flows that are supposedly being differentiated might
not be shaped at all, hence the uncertain outcome on the top row of
eachgraph.
Inthisscenario,ChkDiffappearstocopejustaswellwithawired
90 inference of network neutrality violations with active measurements
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(a) Recallwhenfr=20%
(wiredconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(b)Recallwhenfr=40%
(wiredconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(c)Recallwhenfr=60%
(wiredconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(d)Recallwhenfr=80%
(wiredconnection)
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(e)Recallwhenfr=20%
(WiFiconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(f)Recallwhenfr=40%
(WiFiconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(g)Recallwhenfr=60%
(WiFiconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(h)Recallwhenfr=80%
(WiFiconnection)
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(i)Recallwhenfr=20%
(3Gconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(j)Recallwhenfr=40%
(3Gconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(k)Recallwhenfr=60%
(3Gconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(l)Recallwhenfr=80%
(3Gconnection)
Figure5.7:Recallofthelossanalysisas
wevaryfrinScenario2fromtheserver
connection as it does with WiFi and 3G. Over the two wireless con- located in Germany, over wired, WiFi
nections,thereseemstobemorenoisethatisinanycaseneutralized and3Gconnections.
forthemostpartwhencombiningthetwoanalysis.
5.2.2 Uniform drops (Scenario 2)
We consider now a shaper that uniformly drops packets of selected
flows at a loss rate lr (upper-right pipe in Figure 5.4) and of the
whole trace at a loss rate lr (left pipe in the same figure). As op-
all
posed to the previous scenario, we deploy here a dedicated shaping
pipe for each flow we want to differentiate. We vary lr and lr , as
all
well as the fraction fr of traffic impacted by lr. Shaped flows will
thus have an overall loss rate lr equal to 1−(1−lr)(1−lr ).
shaped all
Weshowtheresultsforeachofthethreeserverlocationsalsousedin
Scenario1,overthethreetypesofconnectionpreviouslyconsidered
(Figures 5.7, 5.8 and 5.9). Since in this scenario the differentiation
we apply does not affect delays, we focus only on the outcome of
the loss analysis. For completeness, results are shown also for high
values of lr , even if in practice a global loss rate of 20% is already
all
abletodisruptTCPconnections. Resultsappearqualitativelysimilar
regardlessofwheretheserverislocated. Weobserveforbothwired
andwirelesssetupsthatwhenfrislessthanhalfofthetrace,ChkD-
iff is able to detect all differentiated flows except for the cases on
chapter 5. chkdiff: the downstream experiment 91
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(a) Recallwhenfr=20%
(wiredconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(b)Recallwhenfr=40%
(wiredconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(c)Recallwhenfr=60%
(wiredconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(d)Recallwhenfr=80%
(wiredconnection)
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(e) Recallwhenfr=20%
(WiFiconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(f)Recallwhenfr=40%
(WiFiconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(g)Recallwhenfr=60%
(WiFiconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(h)Recallwhenfr=80%
(WiFiconnection)
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(i) Recallwhenfr=20%
(3Gconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(j)Recallwhenfr=40%
(3Gconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(k)Recallwhenfr=60%
(3Gconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(l)Recallwhenfr=80%
(3Gconnection)
Figure5.8:Recallofthelossanalysisas
the bottom diagonal, where the difference in loss rate between dif- wevaryfrinScenario2fromtheserver
locatedinIreland,overwired,WiFiand
ferentiated and non-differentiated flows is the lowest (5%, 10% and
3Gconnections.
sometimes 20%). Experiments over WiFi and 3G seem to be only
slightlyworsethanoverwiredforthelowestvaluesoflr .
all
5.3 Discussion
AfullrunofChkDiffinupstreamanddownstreamdirectionsisable
to detect differentiation when, regardless of its implementation, it
directlyworsensthethroughput,packetdelayandlossesofuserap-
plications. This is the typical effect introduced by a shaper. Even
though throughout the thesis we used the terms shaping and dif-
ferentiation interchangeably, the former is a subset of the latter and
shapingiswhatweaimatdetectingwithourcurrenttool. Aswesaw
in the validation section, we cannot precisely reveal shaping when
most of the user traffic is affected, as our baseline in the analysis
would mainly be made of differentiated flows. To counteract this, a
user should be running different applications during the capturing
phase, so as to have a variety of flows to check against. In the ex-
tremecase,ifreallyanISPthrottlesthebandwidthofalltrafficfora
givenuser,itwouldnotbepossibletodiscernitfromseverenetwork
congestionfromtheviewpointofthisparticularuser.
92 inference of network neutrality violations with active measurements
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(a) Recallwhenfr=20%
(wiredconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(b)Recallwhenfr=40%
(wiredconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(c)Recallwhenfr=60%
(wiredconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(d)Recallwhenfr=80%
(wiredconnection)
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(e) Recallwhenfr=20%
(WiFiconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(f)Recallwhenfr=40%
(WiFiconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(g)Recallwhenfr=60%
(WiFiconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(h)Recallwhenfr=80%
(WiFiconnection)
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
rl
depahs
fr=20% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(i) Recallwhenfr=20%
(3Gconnection)
rl
depahs
fr=40% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(j)Recallwhenfr=40%
(3Gconnection)
rl
depahs
fr=60% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
1.0
0.8
0.6
0.4
0.2
0.0
0.0 0.2 0.4 0.6 0.8
lr
all
(k)Recallwhenfr=60%
(3Gconnection)
rl
depahs
fr=80% 100
90
80
70
60
50
40
30
20
10
0
llacer
)NF+PT(/PT
(l)Recallwhenfr=80%
(3Gconnection)
Figure5.9:Recallofthelossanalysisas
wevaryfrinScenario2fromtheserver
In this work, we assume that ISPs select flows to differentiate locatedinOregon,overwired,WiFiand
3Gconnections.
based on packet fields (IP addresses, ports and payload). We do
not directly address classification based on flow bandwidth, but we
make sure that we replay the trace at a higher global rate than the
original one. An alternative for shuffling that we have not yet fully
exploredwouldbetorearrangethepacketsofaflowinsidethetrace
in a way that would also take into account the original flow rate, so
that it would be straightforward to scale up the flow rates when re-
playing the trace. If instead an ISP shapes certain traffic at specific
times of the day (e.g. peak hours), ChkDiff will simply report it as
differentiatedifexecutedduringthosehours.
Thereexistothertechniquesfordifferentiationotherthanshaping,
aswesawinthereportedcasesoftrafficdifferentiationinChapter2.
When an ISP performs port blocking15 or, more in general, block- 15Robert Beverly, Steven Bauer, and
ing of entire applications, the traffic generated by a user connected Arthur Berger. The Internet is not a
big truck: toward quantifying network
throughthatISPwouldonlyconsistofafewoutgoingrequests,cer-
neutrality. InPassiveandActiveNetwork
tainly not enough for ChkDiff to work. In case users suspect their Measurement, pages 135–144. Springer,
2007
ISPtoapplysuchpolicies,theycouldforexamplecapturetheirown
traffic in a different network (e.g., using a cell phone as a hotspot)
and then replay it against the suspected ISP. Alternatively, we could
envisage to provide along with our tool, or let advanced users up-
load, a set of flows from well-known applications that a user could
chapter 5. chkdiff: the downstream experiment 93
inject into their own traces. When a flow experiences worse per-
formance due to interconnection provisioning between an ISP and
a content provider, we can detect differentiation with the upstream
experiment if the problem affects upstream traffic and is localized
within3-4hopsfromtheuser. Thedownstreamexperiment,asinall
othermeasurementtoolsmakinguseofaserver,wouldprobablyby-
pass any suspected links directly connected to the content provider
inquestion. AnotherpossibledifferentiationtechniqueisRSTpacket
injection, through which an ISP could terminate selected TCP con-
nections, as for example did Comcast in 2007 for BitTorrent users
sharingtheirfiles.16 Wedonotcurrentlyimplementdetectionofin- 16Packet forgery by ISPs: A report
jected RST packets, but it would be an easy addition: we would just on the comcast affair. URL: https:
//www.eff.org/wp/packet-forgery-
needtodumpRSTpacketsontheusersideandverifyiftheybelong
isps-report-comcast-affair
toanyflowinthereplayedtrace. WewillsooncomplementChkDiff
withthisextrafeatureinfuturework.
Also, we do not detect differentiation when it aims at providing
better treatment to selected traffic. Such behaviour could be the re-
sult of an agreement between a content provider and an ISP and it
does not necessarily imply any worse conditions for the rest of the
traffic than in normal network conditions. It would be interesting
toredefinethedelayanalysisinbothupstreamanddownstreamex-
periments to account for this, as it could reveal what services and
applications are favoured in a given network. We plan to address
thisinfuturework.
The tool is available for Linux machines on the web page of the
project.17 Wecurrentlyprovideaserverlocatedinourlab,whereno 17http://chkdiff.gforge.inria.fr/
trafficdifferentiationistakingplace.
5.4 Assessment with respect to existing methods 18MarcelDischinger,AlanMislove,An-
dreasHaeberlen,andKrishnaP.Gum-
madi. Detecting BitTorrent Blocking.
Many tools for the detection of traffic differentiation have appeared In Proceedings of the 8th ACM SIG-
intheliteratureinrecentyears,asdetailedinChapter2. Amongthe COMM Conference on Internet Measure-
first ones, BT-test18 checks for injected RST packets while emulating ment (IMC’08), Vouliagmeni, Greece,
October2008
a BitTorrent packet exchange between a user and a server. Other 19Marcel Dischinger, Massimiliano
toolscomparetheperformanceofasyntheticapplicationflowtothe Marcon, Saikat Guha, Krishna Gum-
madi, Ratul Mahajan, and Stefan
performance of a similar flow with some modified or randomized
Saroiu. Glasnost: Enabling End Users
packet fields (port numbers or payloads), so that a shaper targeting to Detect Traffic Differentiation. In
Proceedings of the 7th Symposium on
such application would affect the former and not the latter. Glas-
Networked Systems Design and Imple-
nost19 looks for differences in throughput between these two flows, mentation (NSDI), San Jose, CA, Apr
while DiffProbe20 attempts to create congestion in the ISP network 2010
20Partha Kanuparthy and Constantine
byscalingupthereplayingrateofapplicationandcontrolflows,and
Dovrolis. Diffprobe: detecting ISP ser-
then analyzes their delay and loss distributions. ShaperProbe21 ex- vicediscrimination.InProceedingsofthe
29th conference on Information communi-
pandsonDiffProbebyconsideringthecaseofashaperimplemented
cations,INFOCOM’10,pages1649–1657,
asatokenbucketandtriestoinferitsparametersasthereceivedrate Piscataway,NJ,USA,2010.IEEEPress
atthedestinationshowsalevelshift. Packsen22 alsotriestoidentify 21Partha Kanuparthy and Constantine
Dovrolis. Shaperprobe:End-to-endde-
theshapertypeanditsparameters,butclaimstouseamoreefficient
tection of isp traffic shaping using ac-
statistical analysis. As opposed to ChkDiff, these tools are limited tivemethods. InProceedingsofthe2011
to the set of application traces made available by their authors (e.g., ACM SIGCOMM Conference on Internet
MeasurementConference,IMC’11,pages
Skype,BitTorrent,YouTube,etc),whichwouldmakeithardtomain-
473–482.ACM,2011
22Udi Weinsberg, Augustin Soule, and
Laurent Massoulié. Inferring traffic
shaping and policy parameters using
endhostmeasurements. InINFOCOM,
pages151–155,2011
94 inference of network neutrality violations with active measurements
taintheminthelongrun.
A recent work, Differentiator Detector,23 aims at solving this by 23ArashMolaviKakhki,AbbasRazagh-
replaying between user and server a captured user trace and re- panah, Anke Li, Hyungjoon Koo, Ra-
jesh Golani, David Choffnes, Phillipa
producing the same original application behaviour (ports, payloads,
Gill,andAlanMislove.Identifyingtraf-
inter-packettimes)attheapplicationlayer,firstthroughadirectpath fic differentiation in mobile networks.
In Proceedings of the 2015 ACM Confer-
between the two endpoints (application flow) and then through a
enceonInternetMeasurementConference,
VPN tunnel to a middlebox (control flow). It measures throughput, pages239–251.ACM,2015
RTTdistributionandlossesinordertodetectshaping. Eventhough
our tool replays separately upstream and downstream traffic, in the
upstream direction it tests the real hops where the original packets
went instead of testing the path between client and server, and in
thedownstreamdirectionitdealsinamorerobustandscalableway
withNATdevices.
Nano24 differsfromexistingsolutionsinthatitcarriesoutpassive 24Mukarram Bin Tariq, Murtaza Moti-
measurements on user traffic and compares it against a data set of wala,NickFeamster,andMostafaAm-
mar. Detectingnetworkneutralityvio-
otherusersinthesamegeographicalarea,withcomparablemachine
lationswithcausalinference.ACMSIG-
setups, at the same time of the day, but connected to a different ISP. COMMCoNext,page289,2009
While this method is undeniably independent of user applications
anddifferentiationtechniques,itsmaindisadvantageisthatitneeds
afairlylargenumberofusersforittobeoperational. ChkDiffonthe
otherhanddependssolelyontheenduserrunningit.
5.5 Summary
We extended with a downstream experiment ChkDiff, a tool which
enablesuserstodetectdifferentiationontheirowntraffic. Afterfirst
checking for degraded traffic performance on upstream traffic, the
tool replays user incoming flows from a measurement server to the
user and analyzes delays and losses to verify whether each flow ex-
periencedthesamenetworkconditionsastherestofthetrace. While
intheupstreamdirectionourtoolprovedtoberobusttoratelimita-
tion in the ICMP feedback generated by routers, in the downstream
case we successfully cope with NAT’s and middleboxes in front of
theclientandwithend-to-endmeasurementspossiblycomprisinga
diversityofpathsbetweenserverandclient. WevalidatedChkDiffin
the wild, with two differentiation scenarios over three types of con-
nections: wired, WiFi and 3G. We showed that it correctly identifies
shapedflowswhenuptohalfofausertraceisaffected.
Infuturework,weenvisagetoincludeinthetoolteststhatcheck
fordifferentiationtechniquesthatdonotnecessarilyalterdelaysand
losses, as for instance TCP RST injection. We also intend to run a
study with volunteers in a variety of wired and mobile setups in
ordertohaveamappingofthecurrentpracticesofISPs.
6
Conclusion
In this thesis, we presented and validated ChkDiff, a novel tool for
thedetectionoftrafficdifferentiationattheaccessISP,andconducted
a study on the responsiveness routers to TTL-limited probes. We
conclude with a summary of our contributions in Section 6.1 and a
discussionaboutfuturedirectionsinSection6.2.
6.1 Summary
Comparedtoexistingwork,thestrengthofChkDiffliesinitsability
to test any application run by the user and to apply to any shaping
technique deployed by an ISP that results in degraded flow perfor-
mance. Ourtoolrunsmeasurementsdirectlyonpreviously-captured
user traffic and comprises two experiments, according to the direc-
tion of the traffic. In both cases we shuffle the user trace in such a
waythat,whenreplayed,allflowswillexperiencethesamenetwork
conditions.
Intheupstreamexperiment,wereplayoutgoingusertrafficagainst
the routers at the first few hops away from the user by forging the
TTL field of each packet. With the ICMP time-exceeded replies
returned by intermediate routers we compute per-flow delays and
losses and infer differentiation by comparing the performance of
each flow against that of the rest of the trace. By repeating this
experiment across successive hops, we are also able to localize the
position of possible shapers in terms of number of hops from the
user. We validated this in wired and WiFi setups in two different
shapingscenarios,wherewerespectivelythrottledthebandwidthof
selected flows and applied a uniform loss rate to selected flows and
tothewholetrace. WeshowedthatChkDiffisabletocorrectlydetect
shapedflowswhenupto60%oftrafficundergoesbandwidththrot-
tling and when up to 40% of traffic is subject to a higher loss rate
than the whole trace. We also validated our tool in the presence of
ICMP rate limitation and showed that it does not alter significantly
ourresults,evenwhenonly20%ofprobesreceiveareply.
In order to corroborate our choice of measurements in the up-
stream experiment, we first studied the responsiveness of routers to
TTL-limited probes with a large-scale campaign from 180 hosts in
PlanetLab. Among the 850 routers we tested, we found that almost
96 inference of network neutrality violations with active measurements
a third of them were fully responsive in the range of probing rates
we considered (up to 2500 pps), around 4% were unresponsive and
around 60% implemented ICMP rate limitation. Among these, the
most common form of ICMP limitation displays an on-off pattern,
definedbytheburstsizeofthegeneratedpacketsandtheinter-burst
time, which we characterized also according to the router vendors.
Even at relatively high probing rates, we did not hit any capacity
limitsthatresultedinlargerdelays. Thismeansthatintheupstream
experimentofChkDiffwecanprobeatratesatleastwithintherange
wetestedwithoutimpairingthemeasurementsofround-triptimes.
In the downstream experiment, we replay incoming user traffic
from a measurement server and detect differentiation by measuring
per-flowone-waydelaysandlosses. Wetakethenecessaryactionsto
handleNATs,firewallsandmiddleboxesand,unlikeothermethods,
we consider the possibility of having multiple paths between server
and client when analyzing flow delays. We validated this in wired,
WiFi and 3G setups using a measurement server deployed in three
different data center locations, under the two shaping scenarios al-
ready used for the upstream experiment. Similarly to the upstream
case,resultsshowedthatChkDiffsuccessfullydetectsdifferentiation
whenupto60%oftraffichasitsbandwidththrottledandupto40%
of traffic experiences a higher loss rate than the overall one. The re-
sults were qualitatively similar across the three types of connection,
thusprovingtherobustnessofouranalysis.
6.2 Future directions
A natural next step for our project would be to distribute the tool
to a wider audience. First, we could ask undergraduate students at
ourUniversitytodownloadandrunit,soastohaveaglobalviewof
trafficdifferentiationpracticesbyFrenchaccessISPs. Then,wecould
envisage a collaboration with M-Lab,1 which already hosts servers 1www.measurementlab.net
for oroffers visibilityto tools fordifferentiation detection (Glasnost,
Neubot) and network monitoring and troubleshooting (e.g., NDT,
Pathload2, BISmark, MobiPerf, etc.). M-Lab could ideally host our
measurement server for thedownstream experiment in a number of
locations,inordertobeabletotestdifferentpathstotheuser. Along
with this, we could also collect anonymized results from users and
publishper-countrystatistics,similarlytowhatisdoneforGlasnost.2
2http://broadband.mpi-sws.org/
A mobile version of ChkDiff could also be implemented, perhaps transparency/results/
in a lightweight version that reduces the measurement overhead.
Porting to Android and iOS presents several challenges, especially
in the capture and replay of traffic, since in a mobile environment
weshouldnotexpecttohaveadministratorprivilegesonthedevice.
Alternatives to the usage of tcpdump and tcpreplay should be ex-
plored. Currently, as shown in the validation section of Chapter 5,
a user can check if her mobile operator applies shaping on her 3G
connection simply by turning her mobile phone into a WiFi hotspot
and connecting a computer to it. With this approach, we can easily
bibliography 97
testdesktopapplications,butnotmobileones.
AswesawinChapter2,boththeUnitedStatesandtheEuropean
Unionhaveadoptedregulationsthatenforcenetworkneutralityand
restrictthenumberofcasesinwhichanISPisallowedtoapplytraffic
differentiation. Nevertheless,notooliscurrentlywidelyadoptedby
National Regulatory Authorities (NRAs) and even then NRAs can
only check for differentiation on a limited set of applications, for
instance by running Glasnost. ChkDiff could be a solution for this,
with users sending the output of ChkDiff to their national NRA in
caseofdetectionoftrafficdifferentiation.
In our tool, we check for differentiation on the exact paths cov-
ered by the original trace only in the upstream experiment. In the
downstream direction, since IP spoofing is not a viable solution in
today’snetworks,3 weneededtoresorttoreplayingfromameasure- 3BCP 38 - Network Ingress Filter-
ment server using the server IP address as source IP address in all ing: Defeating Denial of Service At-
tacks which employ IP Source Ad-
packets of the trace. This is the same technique used by all other
dress Spoofing. URL: https://
tools that perform active measurements: they test for differentiation tools.ietf.org/html/bcp38
alongthepathbetweentheserverandtheuser,whichinthevicinity
oftheusermightnotcoverexactlythehopstraversedbytheoriginal
flows. This is not necessarily an issue, but it is certainly a limitation
ofthistypeofmeasurements. Asaworkaround,ashintedabove,we
couldoffertheoptiontoreplaythedownstreamtracefromdifferent
serverlocationsinordertocovermorepathstotheuser.
Finally, our methodology infers neutrality violations from Qual-
ityofService(QoS)parameters,withouttakingintoaccountQuality
of Experience (QoE). In other words, we only consider the results
of network measurements (delays and losses) and not the effects on
the usability of applications. This could be a direction to explore.
ACQUA,4 a parallel project in our research team, tries to predict 4htttp://project.inria.fr/acqua
with machine-learning techniques the QoE of popular applications
(e.g. Skype, YouTube) based on the measured QoS. We could inte-
grate ACQUA into our project in order to also infer if a detected
differentiation mechanism significantly degrades the usability of an
application. Moreover, since an equal treatment of traffic does not
necessarily translate into an equally good QoE for applications with
differentrequirements(e.g.,filesharing,videostreaming,VoIP,IPTV,
etc), we could also envisage to explore which shaping mechanisms
donotdegradebutimprovetheQoEofdifferenttypesofapplications.
Bibliography
[1] AT&T blocking iPhone’s FaceTime app would harm
consumers and break net neutrality rules. URL:
http://www.freepress.net/press-release/99480/att-
blocking-iphones-facetime-app-would-harm-consumers-
and-break-net-neutrality.
[2] BCP 38 - Network Ingress Filtering: Defeating Denial of Ser-
vice Attacks which employ IP Source Address Spoofing. URL:
https://tools.ietf.org/html/bcp38.
[3] Bouygues télécom filtre malhonnêtement son réseau 3G et
inspecte vos données. URL: http://grapsus.net/blog/post/
Bouygues-Telecom-filtre-malhonnetement-son-reseau-3G-
et-inspecte-vos-donnees.
[4] Chile, primer país en incorporar la neutralidad en la
red. URL: http://www.elmundo.es/elmundo/2010/07/16/
navegante/1279272468.html.
[5] Dslreports: comcast is using sandvine to manage p2p connec-
tions. URL: http://www.dslreports.com/forum/r18323368-
Comcast-is-using-Sandvine-to-manage-P2P-Connections.
[6] Group asks FCC to probe iPhone Skype restrictions. URL:
http://fortune.com/2009/04/03/group-asks-fcc-to-probe-
iphone-skype-restrictions/.
[7] I just doubled my PIA VPN throughput that I am
getting on my router by switching from UDP:1194 to
TCP:443. URL: http://www.reddit.com/r/VPN/comments/
1xkbca/i_just_doubled_my_pia_vpn_throughput_that_i_am.
[8] Linux Programmer’s Manual - TCP protocol . URL: http://
man7.org/linux/man-pages/man7/tcp.7.html.
[9] MetroPCS 4G Data-Blocking Plans May Violate Net Neu-
trality. URL: http://www.wired.com/2011/01/metropcs-net-
neutrality/.
[10] Net neutrality enshrined in dutch law. URL:
http://www.theguardian.com/technology/2011/jun/23/
netherlands-enshrines-net-neutrality-law.
100 inference of network neutrality violations with active measurements
[11] NetFilter: Firewalling, NAT and packet mangling for Linux.
URL:www.netfilter.org.
[12] Packet forgery by ISPs: A report on the comcast af-
fair. URL: https://www.eff.org/wp/packet-forgery-isps-
report-comcast-affair.
[13] Phone Company Helps Make the Case for Net Neutral-
ity. URL: http://www.savetheinternet.com/blog/10/04/05/
phone-company-helps-make-case-net-neutrality.
[14] Respectmynet. URL:http://respectmynet.eu/view/205.
[15] Respectmynet. URL:http://respectmynet.eu/view/196.
[16] RFC4787-NetworkAddressTranslation(NAT)BehavioralRe-
quirements for Unicast UDP. URL: http://tools.ietf.org/
html/rfc4787.
[17] RFC5382-NATBehavioralRequirementsforTCP. URL:http:
//tools.ietf.org/html/rfc5382.
[18] Service Name and Transport Protocol Port Number Registry.
IANA. URL:www.iana.org/assignments/port-numbers.
[19] Tcpreplay. URL:http://tcpreplay.appneta.com/.
[20] Vint Cerf speaks out on net neutrality. URL: https:
//googleblog.blogspot.fr/2005/11/vint-cerf-speaks-
out-on-net-neutrality.html.
[21] Vonage says broadband provider blocks its calls. URL:
http://www.cnet.com/news/vonage-says-broadband-
provider-blocks-its-calls/.
[22] Widespread Hijacking of Search Traffic in the United States.
URL: https://www.eff.org/deeplinks/2011/07/widespread-
search-hijacking-in-the-us.
[23] Netflix performance on Verizon and Comcast has been drop-
ping for months, 2013. URL: http://arstechnica.com/
information-technology/2014/02/netflix-performance-on-
verizon-and-comcast-has-been-dropping-for-months.
[24] FCC. Protecting and promoting the open internet. April 2015.
URL: https://www.federalregister.gov/articles/2015/
04/13/2015-07841/protecting-and-promoting-theopen-
internet.
[25] WhatsApp Voice Calling Already Banned by UAE’s Eti-
salat: Report. 2015. URL: http://gadgets.ndtv.com/apps/
news/whatsapp-voice-calling-already-banned-by-uaes-
etisalat-report-672283.
[26] P.Almquist. RFC1349: TypeofServiceintheInternetProtocol
Suite. 1992. URL:https://tools.ietf.org/html/rfc1349.
bibliography 101
[27] Brice Augustin, Xavier Cuvellier, Benjamin Orgogozo, Fabien
Viger, Timur Friedman, Matthieu Latapy, Clémence Magnien,
and Renata Teixeira. Avoiding traceroute anomalies with paris
traceroute. In Proceedings of the 6th ACM SIGCOMM conference
onInternetmeasurement,pages153–158.ACM,2006.
[28] BriceAugustin,TimurFriedman,andRenataTeixeira. Measur-
ingload-balancedpathsintheinternet. InProceedingsofthe7th
ACM SIGCOMM conference on Internet measurement, pages 149–
160.ACM,2007.
[29] Simone Basso, Antonio Servetti, and Juan Carlos De Martin.
The network neutrality bot architecture: a preliminary ap-
proach for self-monitoring of Internet access QoS. In Comput-
ers and Communications (ISCC), 2011 IEEE Symposium on, pages
1131–1136.IEEE,2011.
[30] BEREC. AframeworkforQualityofServiceinthescopeofNet
Neutrality. BEREC Report BoR (11) 53, December 2011. URL:
http://berec.europa.eu/eng/document_register/subject_
matter/berec/download/0/117-a-framework-for-quality-
of-service-in-th_0.pdf.
[31] BEREC. Guidelines for quality of service in the scope of net
neutrality. BEREC Report BoR (12) 131, November 2012. URL:
http://berec.europa.eu/eng/document_register/subject_
matter/berec/download/0/1101-berec-guidelines-for-
quality-of-service-_0.pdf.
[32] BEREC. Annex of monitoring quality of internet access
services in the context of net neutrality. BEREC Report BoR
(14) 117, September 2014. URL: http://berec.europa.eu/
eng/document_register/subject_matter/berec/download/1/
4602-monitoring-quality-of-internet-access-se_1.pdf.
[33] BEREC. Monitoring quality of internet access services
in the context of net neutrality. BEREC Report BoR (14)
117, September 2014. URL: http://berec.europa.eu/eng/
document_register/subject_matter/berec/download/0/
4602-monitoring-quality-of-internet-access-se_0.pdf.
[34] RobertBeverly,StevenBauer,andArthurBerger. TheInternetis
not a big truck: toward quantifying network neutrality. In Pas-
sive and Active Network Measurement, pages 135–144. Springer,
2007.
[35] S. Blake, F. Baker, and D. Black. RFC 2474: Definition of the
Differentiated Services Field (DS Field) in the IPv4 and IPv6
Headers. 1998. URL:https://tools.ietf.org/html/rfc2474.
[36] Marta Carbone and Luigi Rizzo. Dummynet revisited. SIG-
COMMComput.Commun.Rev.,40(2):12–20,April2010.
102 inference of network neutrality violations with active measurements
[37] Cisco. TTL expiry attack identification and mitiga-
tion. URL: http://www.cisco.com/web/about/security/
intelligence/ttl-expiry.html.
[38] K Claffy, Tracie E Monk, and Daniel McRobb. Internet tomog-
raphy. Nature,7(11),1999.
[39] Jon Crowcroft. Talk on Net Neutrality, December 2006. URL:
"http://www.cl.cam.ac.uk/~jac22/talks/neut.ppt.gz".
[40] Jon Crowcroft. Net neutrality: the technical side of the debate:
awhitepaper. SIGCOMMComput.Commun.Rev.,37:49–56,Jan-
uary2007.
[41] Jon Crowcroft. Talk on Newt or Notrality, July 2011. URL:
"https://www.cl.cam.ac.uk/~jac22/talks/notrality.ppt".
[42] Gregory Detal, Benjamin Hesmans, Olivier Bonaventure, Yves
Vanaubel, and Benoit Donnet. Revealing middlebox interfer-
encewithtracebox. InProceedingsofthe2013ConferenceonInter-
netMeasurementConference, IMC ’13, pages 1–8, New York, NY,
USA,2013.ACM.
[43] MarcelDischinger,MassimilianoMarcon,SaikatGuha,Krishna
Gummadi, Ratul Mahajan, and Stefan Saroiu. Glasnost: En-
ablingEndUserstoDetectTrafficDifferentiation. InProceedings
ofthe7thSymposiumonNetworkedSystemsDesignandImplemen-
tation(NSDI),SanJose,CA,Apr2010.
[44] Marcel Dischinger, Alan Mislove, Andreas Haeberlen, and Kr-
ishnaP.Gummadi.DetectingBitTorrentBlocking.InProceedings
of the 8th ACM SIGCOMM Conference on Internet Measurement
(IMC’08),Vouliagmeni,Greece,October2008.
[45] Constantine Dovrolis, Krishna Gummadi, Aleksandar Kuz-
manovic, and Sascha D.Meinrath. Measurement lab: overview
and an invitation to the research community. SIGCOMM Com-
put.Commun.Rev.,40:53–56,June2010.
[46] AllenBDowney. Usingpathchartoestimateinternetlinkchar-
acteristics. InACMSIGCOMMComputerCommunicationReview,
volume29,pages241–250.ACM,1999.
[47] Martin Ester, Hans-Peter Kriegel, Jörg Sander, and Xiaowei Xu.
Adensity-basedalgorithmfordiscoveringclustersinlargespa-
tial databases with noise. In Kdd, volume 96, pages 226–231,
1996.
[48] Ramesh Govindan and Vern Paxson. Estimating router ICMP
generationdelays. InPassive&ActiveMeasurement(PAM),2002.
[49] BITAG Technical Working Group. Differentiated Treatment of
InternetTraffic. 2015.
bibliography 103
[50] Mehmet H Gunes and Kamil Sarac. Analyzing router respon-
siveness to active measurement probes. Passive and Active Net-
workMeasurement,pages23–32,2009.
[51] MichioHonda,YoshifumiNishida,CostinRaiciu,AdamGreen-
halgh, Mark Handley, and Hideyuki Tokuda. Is it still possible
toextendTCP? InProceedingsofthe2011ACMSIGCOMMCon-
ference on Internet Measurement Conference, IMC ’11, pages 181–
194,NewYork,NY,USA,2011.ACM.
[52] Ningning Hu, Li Li, Zhuoqing Morley Mao, Peter Steenkiste,
andJiaWang. Ameasurementstudyofinternetbottlenecks. In
INFOCOM 2005. 24th Annual Joint Conference of the IEEE Com-
puter and Communications Societies. Proceedings IEEE, volume 3,
pages1689–1700.IEEE,2005.
[53] Van Jacobson. traceroute. URL: ftp://ftp.ee.lbl.gov/
traceroute.tar.gz.
[54] Partha Kanuparthy and Constantine Dovrolis. Diffprobe: de-
tecting ISP service discrimination. In Proceedings of the 29th
conference on Information communications, INFOCOM’10, pages
1649–1657,Piscataway,NJ,USA,2010.IEEEPress.
[55] Partha Kanuparthy and Constantine Dovrolis. Shaperprobe:
End-to-end detection of isp traffic shaping using active meth-
ods. In Proceedings of the 2011 ACM SIGCOMM Conference on
InternetMeasurementConference, IMC ’11, pages 473–482. ACM,
2011.
[56] Ioannis Koukoutsidis. Public QoS and net neutrality measure-
ments. JournalofInformation,5,2015.
[57] Farah Layouni, Brice Augustin, Timur Friedman, and Renata
Teixeira. Originedesétoilesdanstraceroute. InColloqueFranco-
phonesurl’IngénieriedesProtocoles(CFIP),2008.
[58] Lawrence Lessig and Robert W. McChesney. No Tolls on The
Internet. June 2006. URL: http://www.washingtonpost.com/
wp-dyn/content/article/2006/06/07/AR2006060702108.html.
[59] David Malone and Matthew Luckie. Analysis of ICMP quota-
tions. Passive and Active Network Measurement, pages 228–232,
2007.
[60] Arash Molavi Kakhki, Abbas Razaghpanah, Anke Li,
Hyungjoon Koo, Rajesh Golani, David Choffnes, Phillipa Gill,
and Alan Mislove. Identifying traffic differentiation in mobile
networks. In Proceedings of the 2015 ACM Conference on Internet
MeasurementConference,pages239–251.ACM,2015.
[61] Christos Pappas, Katerina Argyraki, Stefan Bechtold, and
Adrian Perrig. Transparency Instead of Neutrality. In Pro-
ceedings of the 14th ACM Workshop on Hot Topics in Networks,
HotNets-XIV,pages22:1–22:7.ACM,2015.
104 inference of network neutrality violations with active measurements
[62] Alina Quereilhac, Mathieu Lacage, Claudio Freire, Thierry
Turletti, and Walid Dabbous. Nepi: An integration framework
for network experimentation. In Software, Telecommunications
and Computer Networks (SoftCOM), 2011 19th International Con-
ferenceon,pages1–5.IEEE,2011.
[63] Ashwin Rao, Justine Sherry, Arnaud Legout, Arvind Krishna-
murthy, Walid Dabbous, and David Choffnes. Meddle: mid-
dleboxesforincreasedtransparencyandcontrolofmobiletraf-
fic. InProceedingsofthe2012ACMconferenceonCoNEXTstudent
workshop,pages65–66.ACM,2012.
[64] RiccardoRavaioli,ChadiBarakat,andGuillaumeUrvoy-Keller.
Chkdiff: checking traffic differentiation at Internet access. In
Proceedingsofthe2012ACMconferenceonCoNEXTstudentwork-
shop,pages57–58.ACM,2012.
[65] RiccardoRavaioli,GuillaumeUrvoy-Keller,andChadiBarakat.
CharacterizingICMPRateLimitationonRouters. InIEEEInter-
nationalConferenceonCommunications(ICC),2015.
[66] RiccardoRavaioli,GuillaumeUrvoy-Keller,andChadiBarakat.
Towards a general solution for detecting traffic differentiation
at the internet access. In Teletraffic Congress (ITC 27), 2015 27th
International,pages1–9.IEEE,2015.
[67] RiccardoRavaioli,GuillaumeUrvoy-Keller,andChadiBarakat.
Testing for traffic differentiation with chkdiff: the downstream
case.InTeletrafficCongress(ITC28),201628thInternational.IEEE,
2016.
[68] J. H. Saltzer, D. P. Reed, and D. D. Clark. End-to-end Argu-
ments in System Design. ACM Trans. Comput. Syst., 2(4):277–
288,November1984.
[69] Neil Spring, Ratul Mahajan, and David Wetherall. Measuring
ISPtopologieswithrocketfuel. ACMSIGCOMMComputerCom-
municationReview,32(4):133–145,2002.
[70] RA Steenbergen. A practical guide to (correctly) troubleshoot-
ing with traceroute. North American Network Operators Group,
pages1–49,2009.
[71] Srikanth Sundaresan, Walter De Donato, Nick Feamster, Re-
nata Teixeira, Sam Crawford, and Antonio Pescapè. Measur-
inghomebroadbandperformance. CommunicationsoftheACM,
55(11):100–109,2012.
[72] Mukarram Bin Tariq, Murtaza Motiwala, Nick Feamster, and
Mostafa Ammar. Detecting network neutrality violations with
causalinference. ACMSIGCOMMCoNext,page289,2009.
bibliography 105
[73] Yves Vanaubel, Jean-Jacques Pansiot, Pascal Mérindol, and
Benoit Donnet. Network fingerprinting: TTL-based router sig-
natures. In Proceedingsofthe2013conferenceonInternetmeasure-
mentconference,pages369–376.ACM,2013.
[74] Udi Weinsberg, Augustin Soule, and Laurent Massoulié. In-
ferring traffic shaping and policy parameters using end host
measurements. InINFOCOM,pages151–155,2011.
[75] RonaldWWolff. Poissonarrivalsseetimeaverages. Operations
Research,30(2):223–231,1982.
[76] TimWu. Networkneutrality,broadbanddiscrimination. Journal
ofTelecommunicationsandhighTechnologylaw,2:141,2003.
[77] Ying Zhang, Zhuoqing Morley Mao, and Ming Zhang. Detect-
ing traffic differentiation in backbone isps with netpolice. In
Proceedingsofthe9thACMSIGCOMMConferenceonInternetMea-
surementConference,IMC’09,pages103–115.ACM,2009.
[78] ZhiyongZhang,OvidiuMara,andKaterinaArgyraki. Network
neutralityinference.InProceedingsofthe2014ACMConferenceon
SIGCOMM, SIGCOMM ’14, pages 63–74, New York, NY, USA,
2014.ACM.
List of Publications
[79] RiccardoRavaioli,ChadiBarakat,andGuillaumeUrvoy-Keller.
Chkdiff: checkingtrafficdifferentiationatinternetaccess. InPro-
ceedings of the 2012 ACM conference on CoNEXT student workshop,
pages57–58.ACM,2012.
[80] RiccardoRavaioli,GuillaumeUrvoy-Keller,andChadiBarakat.
Characterizing ICMP rate limitation on routers. In IEEEInterna-
tionalConferenceonCommunications(ICC),2015.
[81] RiccardoRavaioli,GuillaumeUrvoy-Keller,andChadiBarakat.
Towards a general solution for detecting traffic differentiation
at the internet access. In Teletraffic Congress (ITC 27), 2015 27th
International,pages1–9.IEEE,2015.
[82] RiccardoRavaioli,GuillaumeUrvoy-Keller,andChadiBarakat.
Testing for traffic differentiation with chkdiff: the downstream
case. InTeletrafficCongress(ITC28),201628thInternational,pages
1–9.IEEE,2016.