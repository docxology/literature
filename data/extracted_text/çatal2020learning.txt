LEARNING PERCEPTION AND PLANNING WITH DEEP ACTIVE INFERENCE
Ozan C ¸ atal Tim Verbelen Johannes Nauta Cedric De Boom Bart Dhoedt
IDLab
Department of Information Technology at Ghent University - imec
ABSTRACT
Active inference is a process theory of the brain that states
that all living organisms infer actions in order to minimize
their (expected) free energy. However, current experiments
are limited to predeﬁned, often discrete, state spaces. In this
paper we use recent advances in deep learning to learn the
state space and approximate the necessary probability distri-
butions to engage in active inference.
Index Terms— active inference, deep learning, percep-
tion, planning
1. INTRODUCTION
Active inference postulates that action selection in biological
systems, in particular the human brain, is actually an infer-
ence problem where agents are attracted to a preferred prior
state distribution in a hidden state space [1]. To do so, each
living organism builds an internal generative model of the
world, by minimizing the so-called free energy. The idea
of active inference stems from neuroscience [2, 3] and has
already been adopted to solve different control and learning
tasks [4, 5, 1]. These experiments however typically make
use of manually engineered state transition models and pre-
deﬁned, often discrete, state spaces.
In this paper we show that we can also learn the state
space and state transition model, by using deep neural net-
works as probability density estimators. By sampling from
the learnt state transition model, we can plan ahead minimiz-
ing the expected free energy, trading off goal-directed behav-
ior and uncertainty-resolving behavior.
2. ACTIVE INFERENCE
Active inference states that every organism or agent entertains
an internal model of the world, and implicitly tries to mini-
mize the difference between what it believes about the world
and what it perceives, hence minimizing its own variational
free energy [2]. Moreover, the agent believes that it will min-
imize its expected free energy in the future, in effect turning
action selection into an inference problem. This boils down
Ozan C ¸ atal is funded by a Ph.D. grant of the Flanders Research Founda-
tion (FWO). This work is supported by AI Research Flanders
to optimizing for two distinct objectives. On the one hand the
agent actively samples the world to update its internal model
of the world and better explain observations. On the other
hand the agent is driven to visit preferred states that it be-
lieves a priori it will visit—a kind of global prior— which
carry little expected free energy.
Formally, we assume an agent entertains a generative
model P(˜o,˜s,˜a,π) of the environment, which speciﬁes the
joint probability of observations, actions and their hidden
causes, where actions are determined by some policy π. If
the environment is modelled as a Markov Decision Process
(MDP) this generative model factorizes as:
P(˜o,˜s,˜a,π) =P(π)P(s0)
T∏
t=1
P(ot|st)P(st|st−1,at−1)P(at−1|π)
(1)
The free energy is then deﬁned as:
F = EQ[log Q(˜s) −log P(˜o,˜s,˜a)]
= DKL(Q(˜s)∥P(˜s,˜a|˜o)) −log P(˜o)
= DKL(Q(˜s)∥P(˜s,˜a)) −EQ[log P(˜o|˜s)]
(2)
where Q(˜s) is an approximate posterior distribution. The sec-
ond equality shows that the free energy is minimized when
the KL divergence term becomes zero, meaning that the ap-
proximate posterior becomes the true posterior, in which case
the free energy becomes the negative log evidence. This can
also be rewritten as the third equality, which is the negative
evidence lower bound (ELBO) that also appears in the varia-
tional autoencoders (V AE) framework [6, 7].
In active inference, agents infer the actions that will result
in visiting states of low expected free energy. They do this by
sampling actions from a prior belief about policies according
to how much expected free energy that policy will induce.
Formally, this means that the probability of picking a policy
is given by [8]:
P(π) =σ(−γG(π))
G(π) =
∑
τ
G(π,τ) (3)
where σ is the softmax function with precision parameter γ,
which governs the agents goal-directedness and randomness
arXiv:2001.11841v2  [cs.LG]  24 Feb 2020
in its behavior. Here Gis the expected free energy at future
timestep τ when following policy π[8]:
G(π,τ) =EQ(oτ ,sτ |π)[log Q(sτ|π) −log P(oτ,sτ|π)]
= EQ(oτ ,sτ |π)[log Q(sτ|π) −log P(oτ|sτ,π)
−log P(sτ|π)]
= DKL(Q(sτ|π)∥P(sτ)) +EQ(sτ )[H(oτ|sτ)]
(4)
We used Q(oτ,sτ|π) =P(oτ|sτ)Q(sτ|π) and that the prior
probability P(sτ|π) is given by a preferred state distribution
P(sτ). This results into two terms: a KL divergence term be-
tween the predicted states and the prior preferred states, and
an entropy term reﬂecting the expected ambiguity under pre-
dicted states. Action selection in active inference thus entails:
1. Evaluate G(π) for each policy π
2. Calculate the belief P(π) over policies
3. Infer the next action using P(π)P(at+1|π)
3. DEEP ACTIVE INFERENCE
For the agent’s model, we use deep neural networks to pa-
rameterize the various factors of equation (1): i.e. the tran-
sition model pθ(st|st−1,at) and the likelihood distribution
pξ(ot|st). Also the approximate posterior is parameterized
by a neural network pφ(st|st−1,at,ot). All distributions
are parameterized as i.i.d multivariate Gaussian distributions,
i.e. the outputs of the neural networks are the means µ and
standard deviations σ of each Gaussian. Sampling is done
using the reparameterization trick, computing µ + ϵσ with
ϵ ∼N(0,1), which allows for backpropagation of the gradi-
ents. Minimizing the free energy then boils down to minimiz-
ing the following loss function:
∀t: minimize
φ,θ,ξ
: −log pξ(ot|st)
+ DKL(pφ(st|st−1,at−1,ot)∥pθ(st|st−1,at−1))
(5)
Figure 1 shows an overview of the information ﬂow be-
tween the transition model, approximate posterior and like-
lihood neural networks. To engage in active inference using
these models, we need to estimateG(π,τ), which involves es-
timating Q(sτ|π). As our model takes a state sample as input,
and only estimates the state distribution of the next timestep,
the only way to get an estimate of the state distribution at a
future timestep τ >t+ 1is by Monte Carlo sampling. Con-
cretely, to infer P(π), we sample for each policy N trajec-
tories following π using pθ. This results in N state samples
ˆsτ, for which we can get N observation estimates ˆoτ via pξ.
To be able to calculate the KL divergence and entropy, we
use a Gaussian distribution ﬁtted on the samples’ mean and
variance. We then estimate the expected free energy for each
policy from current timestep tonward as follows:
Transition
Model
Transition
Model
Posterior
Likelihood
Posterior
Sample
Fig. 1 : We train simultaneously a transition model
pθ(st|st−1,at), an approximate posterior distribution model
pφ(st|st−1,at,ot), and a likelihood distribution pξ(ot|st)
model, by minimizing the variational free energy.
ˆGt(π) =
t+K∑
τ=t+1
DKL(N(µˆsτ ,σˆsτ )∥P(sτ)) +1
ρH(N(µˆoτ ,σˆoτ ))
+
∑
π′
σ(−γˆGt+K(π′)) ˆGt+K(π′) (6)
The ﬁrst summation term looks K timesteps ahead, cal-
culating the KL divergence between expected and preferred
states and the entropy on the expected observations. We also
introduce an additional hyperparameter ρ, which allows for
a trade-off between reaching preferred states on the one hand
and resolving uncertainty on the other hand. The second sum-
mation term implies that after K timesteps, we continue to
select policies according to their expected free energy, hence
recursively re-evaluating the expected free energy of each pol-
icy at timestep t+ K. In practice, we unroll this D times,
resulting into a search tree with an effective planning horizon
of T = K×D.
4. EXPERIMENTS
We experiment with the Mountain Car problem, where an
agent needs to drive the car up the mountain in 1D by throt-
tling left or right, as shown on Figure 2. The top of the moun-
tain can only be reached by ﬁrst building up momentum be-
fore throttling right. The agent spawns at a random position,
and only observes a noisy position sensor and has no access
to its current velocity. At each timestep, the agent can choose
between two policies: πl to throttle to the left, πr to throttle
to the right. We experiment with two ﬂavors of this environ-
ment: one where the agent starts with ﬁxed zero velocity, and
one where the agent starts with a random initial velocity.
For our generative model, we instantiate pθ(st|st−1,at),
pφ(st|st−1,at,ot) and pξ(ot|st) as fully connected neural
Fig. 2: The mountain car environment. The shown position
of the car at −0.5 is the starting position in our evaluations.
networks with 20 hidden neurons, and a state space with 4
dimensions. To bootstrap the model, we train on actions and
observation of a random agent minimizing the loss function
in Equation (5) using stochastic gradient descent. Next, we
instantiate an active inference agent that uses Equation (6) to
plan ahead and select the best policy. As preferred state distri-
bution P(sτ), we manually drive the car up the mountain and
evaluate the model’s posterior state at the end of the sequence
ˆsend, and set P(sτ) = N(ˆsend,1). To limit the computa-
tions, the active inference agent plans ahead for 90 timesteps,
allowing to switch policy every 30 timesteps, effectively eval-
uating a search tree with depth 3, using 100 samples for each
policy (K = 30,D = 3,N = 100).
Figure 3 shows the sampled trajectories for all branches
of the search tree, in the case the model is bootstrapped with
only a single observation at position−0.5. This is a challeng-
ing starting position as the car needs enough momentum in
order to reach up the hill from there. In the case of a ran-
dom starting velocity, the generative model is not sure about
the velocity after only the ﬁrst observation. This is reﬂected
by the entropy (i.e. the expected ambiguity) of the sampled
trajectories. Now following πr from the start will sometimes
reach the preferred state, depending on the initial velocity. In
this case the active inference agent’s behavior is determined
by the parameterρ. For ρ> 1, the agent will act greedily, pre-
ferring the policy that has a chance of reaching the top early,
cf. Figure 3e. When setting ρ <<1, the entropy term will
play a bigger role, and the agent will select the policy that is
less uncertain about the outcomes, rendering a more cautious
agent that prefers a more precise and careful policy, moving
to the left ﬁrst see Fig. 3a. We found setting ρ= 0.1 yields a
good trade-off for the mountain car agent.
In the environment with no initial velocity, the transition
model learnt by the agent is quite accurate and the entropy
terms are an order of magnitude lower, as shown in Figure 4.
However, in terms of preferred state the lowest KL is still
achieved by following πr. This is due to the fact that the KL
term is evaluated each timestep, and moving to the left, away
from the preferred state in the sequence outweighs the beneﬁt
of reaching the preferred state in the end. Choosing ρ = 0.1
again forces the agent to put more weight on resolving uncer-
tainty, preferring the policy in Figure 4a.
5. DISCUSSION
Using deep neural networks to instantiate the generative
model and to approximate both prior and posterior distribu-
tions, has the advantage that the generative model is indepen-
dent of any state representation. The model can learn the best
state representation for the observed data. Employing deep
neural networks also opens up the possibility of using high-
dimensional sensor inputs, e.g. images. The downside of our
model, however, is the required sampling step, which means
that a distribution is only calculated for the next timestep, and
distributions for timesteps τ further in the future can only be
approximated by sampling.
Another point of discussion is the deﬁnition of the pre-
ferred state distribution. In our case we opted for a Gaussian
state distribution, centered around the state visited by an ex-
pert demonstration, similar to our earlier work [9]. However,
the standard deviation of this distribution will determine the
absolute value of the KL term in Equation (6). A small stan-
dard deviation will blow up the KL term, completely ignoring
the entropy term. A large standard deviation will assign prob-
ability mass to neighboring states, possibly introducing local
optima that don’t reach the actual goal state. To mitigate this,
we introduced an additional ρ parameter that balances risk
and ambiguity.
Finally, planning by generating and evaluating trajectories
of the complete search tree is computationally expensive. In
this paper, we intentionally pursued this approach in order to
directly investigate the effect of the KL term versus the en-
tropy term. To mitigate the computational load, one might
amortize the resulting policy by training a policy neural net-
work pπ(at|st) based on the visited states and the planned
actions by the agent, similar to [10]. In other approaches, the
policy is learned directly through end-to-end training. For ex-
ample, K. Ueltzh ¨offer uses evolution strategies to learn both
a model and a policy, that requires part of the state space to
be ﬁxed, to contain information of the preferred state [11].
B. Millidge on the other hand amortizes the expected free en-
ergy Gas function of the state, similar to value function es-
timation in reinforcement learning [12]. Again, however, the
perception part is omitted and the state space is ﬁxed upfront.
6. CONCLUSION
In this paper, we have shown how generative models parame-
terized by neural networks are trained by minimizing the free
energy, and how these can be exploited by an active inference
agent to select the optimal policy. We will further extend our
models to work in more complex environments, in particular
towards more complex sensory inputs such as camera, lidar
or radar data.
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 7.02, H: -0.37, G: 3.28
(a) left-right-right
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 7.09, H: -0.16, G: 5.50 (b) left-right-left
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 7.89, H: -0.26, G: 5.32 (c) left-left-right
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 7.90, H: -0.28, G: 5.05 (d) left-left-left
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 5.07, H: 0.09, G: 5.96
(e) right-right-right
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 5.38, H: 0.16, G: 6.93 (f) right-right-left
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 7.07, H: -0.04, G: 6.68 (g) right-left-right
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 7.35, H: -0.08, G: 6.58 (h) right-left-left
Fig. 3: Depending on the random initial velocity, the car will reach the hill fast using the right policy only part of the cases (e),
however starting with the left policy ﬁrst also reaches the hill top and with lower entropy on the trajectories (a). A greedy agent
(ρ> 1) will pick (e) whereas a cautious agent (ρ<< 1) will favor (a). For each policy we report the values of KL, H and G for
ρ= 0.1.
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 10.55, H: -1.83, G: -7.70
(a) left-right-right
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 10.44, H: -1.14, G: -0.96 (b) left-right-left
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 10.26, H: -1.25, G: -2.19 (c) left-left-right
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 10.42, H: -1.31, G: -2.67 (d) left-left-left
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 9.14, H: -1.33, G: -4.16
(e) right-right-right
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 9.88, H: -1.40, G: -4.16 (f) right-right-left
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 11.03, H: -1.49, G: -3.87 (g) right-left-right
0 20 40 60 80
time
1.25
1.00
0.75
0.50
0.25
0.00
0.25
0.50
0.75
position
KL: 11.11, H: -1.70, G: -5.91 (h) right-left-left
Fig. 4: When the environment starts the car with a ﬁxed zero velocity, the model is on average much more certain on the
predicted trajectories, resulting in lower entropy terms. However, policy (e) still achieves the lowest KL value, as this term is
evaluated each timestep, and moving away from the preferred state yields a high KL penalty. When choosingρ= 0.1, the agent
again favors (a). For each policy we report the values of KL, H and G for ρ= 0.1.
7. REFERENCES
[1] Karl Friston, Thomas FitzGerald, Francesco Rigoli,
Philipp Schwartenbeck, and Giovanni Pezzulo, “Active
inference: A Process Theory,”Neural Computation, vol.
29, pp. 1–49, 2017.
[2] Karl Friston, “The free-energy principle: A uniﬁed
brain theory?,” Nature Reviews Neuroscience, vol. 11,
no. 2, pp. 127–138, 2010.
[3] Karl Friston, James Kilner, and Lee Harrison, “A free
energy principle for the brain,” Journal of Physiology
Paris, vol. 100, no. 1-3, pp. 70–87, 2006.
[4] Karl Friston, Spyridon Samothrakis, and Read Mon-
tague, “Active inference and agency: Optimal control
without cost functions,” Biological Cybernetics, vol.
106, no. 8-9, pp. 523–541, 2012.
[5] Karl Friston, Philipp Schwartenbeck, Thomas FitzGer-
ald, Michael Moutoussis, Timothy Behrens, and Ray-
mond J. Dolan, “The anatomy of choice: active infer-
ence and agency,” Frontiers in Human Neuroscience,
vol. 7, no. September, pp. 1–18, 2013.
[6] Diederik P. Kingma and Max Welling, “Auto-encoding
variational bayes,” CoRR, vol. abs/1312.6114, 2013.
[7] Danilo Jimenez Rezende, Shakir Mohamed, and Daan
Wierstra, “Stochastic backpropagation and approximate
inference in deep generative models,” inProceedings of
the 31st International Conference on Machine Learning,
2014.
[8] Philipp Schwartenbeck, Johannes Passecker, Tobias
Hauser, Thomas H B FitzGerald, Martin Kronbichler,
and Karl J Friston, “Computational mechanisms of
curiosity and goal-directed exploration,” bioRxiv, p.
411272, 2018.
[9] Cedric De Boom, Tim Verbelen, and Bart Dhoedt,
“Deep active inference for state estimation by learning
from demonstration,” in Conference of Complex Sys-
tems (CCS), Satellite Symposium on Complexity from
Cells to Consciousness: Free Energy, Integrated Infor-
mation, and Epsilon Machines, 2018.
[10] Ozan Catal, Johannes Nauta, Tim Verbelen, Pieter
Simoens, and Bart Dhoedt, “Bayesian policy selection
using active inference,” in Workshop on Structure &
Priors in Reinforcement Learning at ICLR 2019 : pro-
ceedings, 2019, p. 9.
[11] Kai Ueltzh ¨offer, “Deep active inference,” Biological
Cybernetics, vol. 112, no. 6, pp. 547–573, Dec 2018.
[12] Beren Millidge, “Deep active inference as variational
policy gradients,” CoRR, vol. abs/1907.03876, 2019.